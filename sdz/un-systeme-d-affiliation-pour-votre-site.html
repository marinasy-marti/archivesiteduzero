<html>

<!-- Mirrored from 62.4.17.167/sdz/sdz/un-systeme-d-affiliation-pour-votre-site.html by HTTrack Website Copier/3.x [XR&CO'2013], Sat, 26 Oct 2013 23:20:13 GMT -->

<!-- Mirrored from sdz.tdct.org/sdz/un-systeme-d-affiliation-pour-votre-site.html by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 30 Nov 2015 04:04:36 GMT -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Tutoriel : Un système d&#039;affiliation pour votre site</title>
<link href="medias/sdz_main.css" type="text/css" rel="stylesheet" media="all"/>
</head>
        <body>
<a href="../www.siteduzero.com/informatique/tutoriels/un-systeme-d-affiliation-pour-votre-site.html" class="version_en_ligne">Version en ligne</a>
<h1>Tutoriel : Un système d&#039;affiliation pour votre site</h1>
<h2>Table des matières</h2><div class="table_des_matieres"><a href="#Unsystmed039affiliationpourvotresite">Un système d&#039;affiliation pour votre site</a><br/><a href="#Principe">Principe</a><br/><a href="#Ductdelatableaffiliation">Du côté de la table affiliation</a><br/><a href="#Ductdelatableaffilies">Du côté de la table affilies</a><br/></div>
<a name="Unsystmed039affiliationpourvotresite"></a><h2>Un système d&#039;affiliation pour votre site</h2><div class="paginate-tuto">
<a class="after" href="http://62.4.17.167/informatique/tutoriels/un-systeme-d-affiliation-pour-votre-site/principe-42">
<span class="next">Principe</span>
<span class="arrow"></span>
</a>
</div>
<hr class="top"/>
<div class="clear"></div> <div class="content">
<p id="r-371945" data-claire-element-id="371945">Dans le commerce électronique (e-commerce), il peut être intéressant d'avoir ses produits visibles sur d'autres sites partenaires. En échange, ces sites affiliés attendent une rémunération.<br/> Si la rémunération au clic est très répandue, elle présente un inconvénient majeur : <strong>un internaute qui clique n'est pas forcément un internaute qui achète.</strong><br/> L'affiliation vient pallier ce défaut en ne prenant en compte que les internautes &quot;qualifiés&quot;. On peut alors verser une commission sur le montant du panier encaissé.</p>
</div><a name="Principe"></a><h2>Principe</h2><div class="paginate-tuto">
<a class="after" href="http://62.4.17.167/informatique/tutoriels/un-systeme-d-affiliation-pour-votre-site/du-cote-de-la-table-affiliation">
<span class="next">Du côté de la table affiliation</span>
<span class="arrow"></span>
</a>
</div>
<hr class="top"/>
<div class="clear"></div> <div id="content" role="article">
<p id="r-371946" data-claire-element-id="371946">Vous vous dites certainement qu'un script d'affiliation est difficile car c'est un concept propre aux sites marchands, et que cela est donc réservé aux professionnels. Détrompez-vous : vous êtes bien sur le Site du Zér0 et à ce titre (car c'est un titre honorifique), vous devriez comprendre ce qui suit sans trop de problèmes.<br/> En plus de connaître les langages PHP et SQL (ouf ! vous êtes encore sur le bon site pour cela), il vous suffit d'avoir bien compris le principe du script.</p><p id="r-371947" data-claire-element-id="371947">Supposons donc que vous ayez une boutique en ligne et que vous vendiez... des graines de courgettes.<br/> Votre site n'est pas encore connu, et vous envisagez de lancer un &quot;programme d'affiliation&quot; afin que des sites internet, spécialisés dans la courgette en particulier, parlent de votre nouveau site.</p><h2 id="r-identifier-un-internaute-provenant-d-un-site-affilie" data-claire-element-id="371972">Identifier un internaute provenant d'un site affilié</h2><p id="r-371948" data-claire-element-id="371948">Dans un premier temps, il faut penser à installer un <strong>script présent sur toutes vos pages</strong> qui vous permettra d'identifier la provenance de vos internautes.</p><aside id="r-371950" data-claire-element-id="371950" data-claire-semantic="warning"><p id="r-371949" data-claire-element-id="371949">En PHP, il existe une variable $_SERVER['HTTP_REFERER'] qui fournit la page précédente. Malheureusement, celle-ci n'est pas fiable, notamment dans le cas où la page est ouverte dans une nouvelle fenêtre par l'internaute.</p></aside><h3 id="r-le-tag" data-claire-element-id="371956">Le tag</h3><p id="r-371951" data-claire-element-id="371951">Nous allons donc utiliser un autre indicateur, fiable à 100 %: le tag. Rassurez-vous, cela n'a rien à voir avec les graffitis, et il ne faudrait pas non plus les confondre avec les &quot;nuages de tags&quot; qu'on voit dans le ciel de nombreux sites...</p><aside id="r-371953" data-claire-element-id="371953" data-claire-semantic="information"><p id="r-371952" data-claire-element-id="371952">Un tag, c'est simplement une variable que l'on fait passer dans l'url. Par exemple : <strong>origine</strong>=<a href="http://www.le-portail-de-la-courgette.com/"><em>www.le-portail-de-la-courgette.com</em></a></p></aside><p id="r-371954" data-claire-element-id="371954">Ainsi, dans le lien <br/><a href="http://www.graines-de-courgette.com/?produit_id=21">http://www.graines-de-courgette.com?produit_id=21</a><strong>&amp;id_affilie=9</strong>,<br/> parmi les deux variables transmises par la méthode GET, c'est <strong>id_affilie=9 qui est le tag</strong> : cela indique que l'internaute est venu du site affilié n°9.</p><p id="r-371955" data-claire-element-id="371955">En supposant que le site <a href="http://www.le-portail-de-la-courgette.com/">www.le-portail-de-la-courgette.com</a> soit justement le neuvième affilié à notre site, le webmaster de ce site devra &quot;tagger&quot; ses liens pointant vers notre site. À nous de lui indiquer le protocole : le nom du tag (ici, id_affilie) et... son identifiant (ici, 9).</p><h3 id="r-transmettre-le-tag" data-claire-element-id="371963">Transmettre le tag</h3><p id="r-371957" data-claire-element-id="371957">Rassurez-vous, on ne va pas trimballer ce tag dans l'url de toutes les pages visitées par l'internaute (eh oui, ça y est, nous avons notre premier internaute, il est venu par le site n°9).<br/> Nous allons juste créer la variable $_SESSION['affiliation']. Je rappelle que la variable superglobale $_SESSION est créée par le serveur et qu'elle conserve de page en page ce que vous voulez dedans.</p><aside id="r-371959" data-claire-element-id="371959" data-claire-semantic="warning"><p id="r-371958" data-claire-element-id="371958">Il faut toujours appeler session_start() au début de vos pages... mais de toute façon, cela doit déjà être le cas si vous faites une boutique en ligne (sinon, comment conserver les informations du panier en cours ?).</p></aside><p id="r-371960" data-claire-element-id="371960">La présence de cette variable nous indique donc que notre internaute est un internaute provenant d'un site partenaire. Nous allons donc enregistrer dans une table cette heureuse visite.</p><aside id="r-371962" data-claire-element-id="371962" data-claire-semantic="information"><p id="r-371961" data-claire-element-id="371961">Nous verrons dans le script que dans $_SESSION['affiliation'] nous ne mettrons pas 9 (la valeur du tag), mais autre chose.</p></aside><h3 id="r-une-table" data-claire-element-id="371966">Une table</h3><p id="r-371964" data-claire-element-id="371964"><strong>affiliation</strong></p><p id="r-371965" data-claire-element-id="371965">C'est la table qui enregistrera les visites comptabilisées comme issues du programme d'affiliation.<br/> On y stockera donc l'identifiant de l'affilié, l'identifiant du panier si c'est le cas, et le statut de la commande. Vous pouvez enregistrer davantage de choses (date et heure, url de provenance) mais le plus important, ce sont ces trois variables qui vous permettront de restituer ce qu'a fait votre internaute.</p><h3 id="r-une-table-1" data-claire-element-id="371971">Une table</h3><p id="r-371967" data-claire-element-id="371967"><strong>affilies</strong></p><p id="r-371968" data-claire-element-id="371968">Nous allons aussi créer une table rien que pour les participants au programme d'affiliation, c'est-à-dire nos sites affiliés. On y stockera bien sûr un pseudo, l'url du site et éventuellement des coordonnées standard par rapport à une inscription. C'est un peu comme de nouveaux membres. Nous allons aussi rajouter un champ commission si nous avons besoin de fixer des taux différents selon les affiliés.</p><aside id="r-371970" data-claire-element-id="371970" data-claire-semantic="information"><p id="r-371969" data-claire-element-id="371969">Ces deux tables n'ont pas grand-chose à voir. La table affiliation permet de suivre le parcours de votre internaute (d'où vient-il, quel est son panier, a-t-il finalement acheté ?).<br/> La table affilies sert à enregistrer vos sites partenaires. Il faudra donc certainement un formulaire d'inscription.</p></aside>
<aside class="aside-menu">
<ul class="content-menu subchapter" role="navigation">
<li class="tuto">
<a href="http://62.4.17.167/informatique/tutoriels/un-systeme-d-affiliation-pour-votre-site">Un système d&#039;affiliation pour votre site</a>
</li>
<ul class="subchapter-parts">
<li class="active">
<a href="http://62.4.17.167/informatique/tutoriels/un-systeme-d-affiliation-pour-votre-site/principe-42">
Principe
</a>
</li>
<li>
<a href="http://62.4.17.167/informatique/tutoriels/un-systeme-d-affiliation-pour-votre-site/du-cote-de-la-table-affiliation">
Du côté de la table affiliation
</a>
</li>
<li>
<a href="http://62.4.17.167/informatique/tutoriels/un-systeme-d-affiliation-pour-votre-site/du-cote-de-la-table-affilies">
Du côté de la table affilies
</a>
</li>
</ul>
</ul>
</aside>
</div>
<div id="content-bottom-menu"></div>
<hr/>
<div class="paginate-tuto">
<a class="after" href="http://62.4.17.167/informatique/tutoriels/un-systeme-d-affiliation-pour-votre-site/du-cote-de-la-table-affiliation">
<span class="next">Du côté de la table affiliation</span>
<span class="arrow"></span>
</a>
</div>
<hr class="bottom"/>
<div class="clear"></div> <div class="adBan">
<script type='text/javascript'>
    if (window.innerWidth >= 728)
    {
        document.write('<div id="div-gpt-ad-1350977194635-8" class="megaban"></div>');
        googletag.cmd.push(function() {
            googletag.display('div-gpt-ad-1350977194635-8');
        });
    }
            else
        {
            document.write('<div id="div-gpt-ad-1350977284180-8" class="miniban"></div>');
            googletag.cmd.push(function() {
                googletag.display('div-gpt-ad-1350977284180-8');
            });
        }
    </script>
</div>
<div class="clear"></div><a name="Ductdelatableaffiliation"></a><h2>Du côté de la table affiliation</h2><div class="paginate-tuto">
<a class="before" href="http://62.4.17.167/informatique/tutoriels/un-systeme-d-affiliation-pour-votre-site/principe-42">
<span class="arrow"></span>
<span class="next">Principe</span>
</a>
<a class="after" href="http://62.4.17.167/informatique/tutoriels/un-systeme-d-affiliation-pour-votre-site/du-cote-de-la-table-affilies">
<span class="next">Du côté de la table affilies</span>
<span class="arrow"></span>
</a>
</div>
<hr class="top"/>
<div class="clear"></div> <div id="content" role="article">
<p id="r-371974" data-claire-element-id="371974">Bon, allez, on y va : on s'intéresse d'abord à la table affiliation. Ce n'est peut-être pas chronologique (comment recevoir des visites depuis des sites affiliés si personne n'est affilié à votre site ?) mais c'est plus pédagogique.</p><h2 id="r-notre-table-affiliation" data-claire-element-id="371978">Notre table affiliation</h2><p id="r-371975" data-claire-element-id="371975">Alors voilà : c'est plus simple de vous donner le code :</p><pre id="r-371976" data-claire-element-id="371976"><code data-claire-semantic="sql">CREATE TABLE `affiliation` (
  `id` mediumint(9) NOT NULL AUTO_INCREMENT,
  `id_affilie` mediumint(9) NOT NULL,
  `dbclic` smallint(4) NOT NULL,
  `paye` tinyint(4) NOT NULL,
  `id_panier` mediumint(9) NOT NULL,
  `ip` varchar(15) NOT NULL,
  `origine` varchar(250) NOT NULL,
  `date` date NOT NULL,
  `heure` time NOT NULL,
  PRIMARY KEY  (`id`)
)</code></pre><p id="r-371977" data-claire-element-id="371977">Le champ id nous permet d'identifier la visite. id_affilie stockera la valeur du tag, c'est-à-dire le numéro de l'affilié. J'ai rajouté des champs comme &quot;dbclic (pour savoir si la personne a au moins vu deux pages sur le site, ça voudra dire qu'il était un peu intéressé par les courgettes...), paye (qui vaudra 1 si la personne atteint avec succès la page de validation de paiement), id_panier (qui contient l'identifiant du panier si l'internaute en constitue un).</p><h2 id="r-le-script-affiliation-php-a-appeler-sur-toutes-vos-pages" data-claire-element-id="372006">Le script affiliation.php (à appeler sur toutes vos pages)</h2><h3 id="r-inclure-le-fichier" data-claire-element-id="371983">Inclure le fichier</h3><p id="r-371979" data-claire-element-id="371979">J'espère que vous avez déjà un petit include &quot;inc/initialisation.php&quot; ou un autre sur vos pages car sinon, il va falloir penser à rajouter partout un petit include/affiliation.php. Si vous avez beaucoup de pages, ça peut vous prendre du temps.</p><aside id="r-371981" data-claire-element-id="371981" data-claire-semantic="information"><p id="r-371980" data-claire-element-id="371980">En général, la plupart des développeurs mettent dans un fichier à part les informations fondamentales au site. Par exemple, un fichier connexion_base.php, appelé à chaque fois pour éviter de toujours faire les trois lignes de connexion à votre base de données.</p></aside><p id="r-371982" data-claire-element-id="371982">Si c'est le cas, vous pouvez à la fin de ce fichier rajouter include inc/affiliation.php. Eh oui : rien ne vous empêche de mettre du include dans un fichier lui-même inclus !<br/> Ce qui compte, c'est d'appeler le fichier au bon endroit. Supposons que notre fichier affiliation.php soit dans le dossier <strong>inc</strong>. Qu'allons-nous y mettre ? Vous le saurez au fil de ce tuto...</p><h3 id="r-on-en-a-un-on-en-a-un" data-claire-element-id="371986">On en a un ! On en a un !</h3><p id="r-371984" data-claire-element-id="371984">Allez : on est dans le cas où l'on a récupéré un tag. Je vous rappelle que c'est quelque chose comme <strong>&amp;id_affilie=9</strong>.<br/> Le but est alors d'insérer cette visite dans notre table affiliation.<br/> À ce moment, on crée la variable $_SESSION['affiliation'] qui contiendra l'id de cette visite.<br/> En PHP, la commande mysql_insert_id(), qui ne prend aucun argument, permet justement de récupérer l'id du dernier élément entré.<br/> On en profite pour créer deux autres variables dans $_SESSION qui nous seront utiles par la suite.</p><pre id="r-371985" data-claire-element-id="371985"><code data-claire-semantic="html+php">&lt;?php
if (isset($_GET['id_affilie']) AND !isset($_SESSION['affiliation'])){
        $sql_temp='INSERT INTO affiliation (id,id_affilie,date,heure,ip,origine) VALUES (&quot;&quot;,&quot;'.$_GET['id_affilie'].'&quot;,&quot;'.date(&quot;Y-m-d&quot;).'&quot;,&quot;'.date(&quot;H:i:s&quot;).'&quot;,&quot;'.$_SERVER['REMOTE_ADDR'].'&quot;,&quot;'.$_SERVER['HTTP_REFERER'].'&quot;)';
        $reponse_temp=mysql_query($sql_temp);
        $_SESSION['affiliation']=mysql_insert_id();//on crée la variable superglobale $_SESSION['affiliation'] avec l'id correspondant dans la table affiliation
        $_SESSION['affiliation_nbclic']=0;
        $_SESSION['affiliation_panier']=false;  
        }
?&gt;</code></pre><h3 id="r-et-ensuite-on-en-fait-quoi" data-claire-element-id="371998">Et ensuite, on en fait quoi ?</h3><p id="r-371987" data-claire-element-id="371987">Remarquez que j'ai mis une autre condition dans l'insertion : il ne faut pas que la variable $_SESSION['affiliation'] existe. C'est la signification de !isset($variable) qui veut dire &quot;si $variable n'existe pas&quot;. Ainsi, on évite des cas bizarres où l'internaute actualiserait sa page, ou serait de nouveau venu par le site affilié. Il n'y a pas de raison pour que ce genre de bizarrerie compte pour une deuxième visite.<br/> Maintenant que cette variable de session existe, il ne reste plus qu'à dire ce que l'on fait au fur et à mesure des événements qu'on souhaite détecter.<br/> Alors, après avoir vérifié que cet internaute provient d'un site affilié :</p><pre id="r-371988" data-claire-element-id="371988"><code data-claire-semantic="html+php">&lt;?php
if (isset($_SESSION['affiliation'])){
$_SESSION['affiliation_nbclic']++; // On rajoute +1 clic
//tests des événements choisis
}
?&gt;</code></pre><p id="r-371989" data-claire-element-id="371989">Le double clic (on change le statut de dbclic : 1=oui) :</p><pre id="r-371990" data-claire-element-id="371990"><code data-claire-semantic="html+php">&lt;?php
if ($_SESSION['affiliation_nb_clic'])==2{
                $sql_temp='UPDATE affiliation SET dbclic=1 WHERE id='.$_SESSION['affiliation'];
                mysql_query($sql_temp);
        }
?&gt;</code></pre><p id="r-371991" data-claire-element-id="371991">Détection du panier :</p><pre id="r-371992" data-claire-element-id="371992"><code data-claire-semantic="html+php">&lt;?php
if (isset($_SESSION['panier_id']) AND (!$_SESSION['affiliation_panier'])){
$sql_temp='UPDATE affiliation SET id_panier='.$_SESSION['panier_id'].' WHERE id='.$_SESSION['affiliation'];
mysql_query($sql_temp);
$_SESSION['affiliation_panier']=true;
}
?&gt;</code></pre><p id="r-371993" data-claire-element-id="371993">Détection de la validation de commande :</p><pre id="r-371994" data-claire-element-id="371994"><code data-claire-semantic="html+php">&lt;?php
if (isset($_GET['retour_paiement']) AND $_GET['retour_paiement']=='valide'){
$sql_temp='UPDATE affiliation SET paye=1 WHERE id='.$_SESSION['affiliation'];
mysql_query($sql_temp);
 $_SESSION['affiliation_panier']=true;
?&gt;
}</code></pre><p id="r-371995" data-claire-element-id="371995">Ici, on a supposé que lorsque le paiement est validé par la banque, le site sécurisé de la banque a renvoyé vers une page dont l'url serait par exemple : retour.php?retour_paiement=valide.<br/> En effet, quand vous configurez un module de paiement en ligne (y compris Paypal), vous pouvez devriez renseigner cette page de retour.</p><aside id="r-371997" data-claire-element-id="371997" data-claire-semantic="warning"><p id="r-371996" data-claire-element-id="371996">C'est le seul endroit qui permet de dire automatiquement que le paiement a été accepté. Bien sûr, il faut ensuite vérifier sur le relevé de compte que ce n'est pas juste un blagueur qui a écrit une telle URL...</p></aside><h3 id="r-et-le-code-complet-affiliation-php" data-claire-element-id="372005">Et le code complet <strong>affiliation.php</strong></h3><pre id="r-371999" data-claire-element-id="371999"><code data-claire-semantic="html+php">&lt;?php
if (isset($_GET['id_affilie']) AND !isset($_SESSION['affiliation'])){
$sql_temp='INSERT INTO affiliation (id,id_affilie,date,heure,ip,origine) VALUES (&quot;&quot;,&quot;'.$_GET['id_affilie'].'&quot;,&quot;'.date(&quot;Y-m-d&quot;).'&quot;,&quot;'.date(&quot;H:i:s&quot;).'&quot;,&quot;'.$_SERVER['REMOTE_ADDR'].'&quot;,&quot;'.$_SERVER['HTTP_REFERER'].'&quot;)';
$reponse_temp=mysql_query($sql_temp);
$_SESSION['affiliation']=mysql_insert_id();
$_SESSION['affiliation_nbclic']=0;
$_SESSION['affiliation_panier']=false;  
        }

if (isset($_SESSION['affiliation'])){
$_SESSION['affiliation_nbclic']=$_SESSION['affiliation_nbclic']+1;

//détection du nb de clics
if ($_SESSION['affiliation_nb_clic'])==2{
$sql_temp='UPDATE affiliation SET dbclic=1 WHERE id='.$_SESSION['affiliation'];
mysql_query($sql_temp);
}
        
//détection du panier
if (isset($_SESSION['panier_id']) AND (!$_SESSION['affiliation_panier'])){
$sql_temp='UPDATE affiliation SET id_panier='.$_SESSION['panier_id'].' WHERE id='.$_SESSION['affiliation'];
mysql_query($sql_temp);
$_SESSION['affiliation_panier']=true;
}

//détection de la validation de commande
if (isset($_GET['retour']) AND $_GET['retour']=='valide'){
$sql_temp='UPDATE affiliation SET paye=1 WHERE id='.$_SESSION['affiliation'];
mysql_query($sql_temp);
$_SESSION['affiliation_panier']=true;
}
}
?&gt;</code></pre><p id="r-372000" data-claire-element-id="372000">Regardons dans la table de MySQL ce qui s'est passé (on suppose que l'internaute venant du site <a href="http://www.le-protail-de-la-courgette.com/">www.le-protail-de-la-courgette.com</a> a fait un panier, le 262e, mais qu'il n'a finalement pas commandé :'( ).</p><figure id="r-372002" data-claire-element-id="372003"><img id="r-372001" data-claire-element-id="372001" src="medias/uploads.siteduzero.com_files_74001_75000_74977.png" alt="Un enregistrement dans affiliation"/></figure><p id="r-372004" data-claire-element-id="372004">Ne reste plus qu'à fournir à nos affiliés une interface où ils pourront observer leurs résultats.</p>
<aside class="aside-menu">
<ul class="content-menu subchapter" role="navigation">
<li class="tuto">
<a href="http://62.4.17.167/informatique/tutoriels/un-systeme-d-affiliation-pour-votre-site">Un système d&#039;affiliation pour votre site</a>
</li>
<ul class="subchapter-parts">
<li>
<a href="http://62.4.17.167/informatique/tutoriels/un-systeme-d-affiliation-pour-votre-site/principe-42">
Principe
</a>
</li>
<li class="active">
<a href="http://62.4.17.167/informatique/tutoriels/un-systeme-d-affiliation-pour-votre-site/du-cote-de-la-table-affiliation">
Du côté de la table affiliation
</a>
</li>
<li>
<a href="http://62.4.17.167/informatique/tutoriels/un-systeme-d-affiliation-pour-votre-site/du-cote-de-la-table-affilies">
Du côté de la table affilies
</a>
</li>
</ul>
</ul>
</aside>
</div>
<div id="content-bottom-menu"></div>
<hr/>
<div class="paginate-tuto">
<a class="before" href="http://62.4.17.167/informatique/tutoriels/un-systeme-d-affiliation-pour-votre-site/principe-42">
<span class="arrow"></span>
<span class="next">Principe</span>
</a>
<a class="after" href="http://62.4.17.167/informatique/tutoriels/un-systeme-d-affiliation-pour-votre-site/du-cote-de-la-table-affilies">
<span class="next">Du côté de la table affilies</span>
<span class="arrow"></span>
</a>
</div>
<hr class="bottom"/>
<div class="clear"></div> <div class="adBan">
<script type='text/javascript'>
    if (window.innerWidth >= 728)
    {
        document.write('<div id="div-gpt-ad-1350977194635-8" class="megaban"></div>');
        googletag.cmd.push(function() {
            googletag.display('div-gpt-ad-1350977194635-8');
        });
    }
            else
        {
            document.write('<div id="div-gpt-ad-1350977284180-8" class="miniban"></div>');
            googletag.cmd.push(function() {
                googletag.display('div-gpt-ad-1350977284180-8');
            });
        }
    </script>
</div>
<div class="clear"></div><a name="Ductdelatableaffilies"></a><h2>Du côté de la table affilies</h2><div class="paginate-tuto">
<a class="before" href="http://62.4.17.167/informatique/tutoriels/un-systeme-d-affiliation-pour-votre-site/du-cote-de-la-table-affiliation">
<span class="arrow"></span>
<span class="next">Du côté de la table affiliation</span>
</a>
</div>
<hr class="top"/>
<div class="clear"></div> <div id="content" role="article">
<p id="r-372008" data-claire-element-id="372008">Une table affilies, c'est un peu comme une table membres. On va faire un formulaire pour demander le nom du site à affilier. On attribue ensuite un numéro d'identifiant à cet affilié (ça lui servira pour le tag à mettre sur ses liens).</p><aside id="r-372010" data-claire-element-id="372010" data-claire-semantic="warning"><p id="r-372009" data-claire-element-id="372009">Le but de ce tuto n'étant pas de vous apprendre à <a href="http://www.siteduzero.com/tuto-3-3358-1-un-espace-membres-simple.html">enregistrer des membres</a>, avec un système de mot de passe, de confirmation par mail, etc., nous allons plutôt supposer que vous avez des membres et qu'il existe une <strong>option</strong> affiliation.</p></aside><h2 id="r-la-table-affilies" data-claire-element-id="372013">La table affilies</h2><pre id="r-372011" data-claire-element-id="372011"><code data-claire-semantic="sql">CREATE TABLE `affilies` (
  `id` mediumint(9) NOT NULL AUTO_INCREMENT,
  `affilie_pseudo` varchar(30) NOT NULL,
  `affilie_email` varchar(100) NOT NULL,
  `affilie_site` varchar(100) NOT NULL,
  `commission_pourcentage` decimal(8,2) NOT NULL DEFAULT '5.00',
  `commission_clic` decimal(8,2) NOT NULL DEFAULT '0.00',
  `commission_dbclic` decimal(8,2) NOT NULL DEFAULT '0.00',
  PRIMARY KEY  (`id`)
)</code></pre><p id="r-372012" data-claire-element-id="372012">Ici, on a vu un peu large car la table permet à un membre d'affilier plusieurs de ses sites à votre boutique en ligne. Dites-vous bien que ce qui repère un site affilié, c'est le tag, ce qui correspond au champ id dans notre table affilies.</p><h2 id="r-un-premier-affilie" data-claire-element-id="372032">Un premier affilié</h2><p id="r-372014" data-claire-element-id="372014">Allez : supposons que ce cher Zucchini ait affilié son site d'informations sur la courgette à notre site qui vend des graines de courgette.<br/> Dans la table affiliation, vous aurez quelque chose comme ceci :</p><figure id="r-372016" data-claire-element-id="372017"><img id="r-372015" data-claire-element-id="372015" src="medias/uploads.siteduzero.com_files_74001_75000_74980.png" alt="et un affilié"/></figure><p id="r-372018" data-claire-element-id="372018">Encore une fois, je ne m'occupe pas ici de faire le formulaire d'inscription. Je vous donne juste ce petit bout de code pour réaliser l'insertion de l'affilié.</p><pre id="r-372019" data-claire-element-id="372019"><code data-claire-semantic="html+php">&lt;?php
$sql_temp='INSERT INTO affilies (id, affilie_pseudo, affilie_email, affilie_site) VALUES (&quot;&quot;,&quot;'.$_SESSION['pseudo'].'&quot;, &quot;'.$_POST['affilie_email'].'&quot;, &quot;'.$_POST['affilie_site'].'&quot;)';
mysql_query($sql_temp);
$_SESSION['id_affilie']=mysql_insert_id();
echo'
Bravo ! Votre site &lt;strong&gt;'.$_POST['affilie_site'].'&lt;/strong&gt; est désormais affilié à &lt;em&gt;www.graines-de-courgette-bio.com&lt;/em&gt; !&lt;br /&gt;
Votre numéro d\'affilié est '.$_SESSION['id_affilie'].'&lt;br /&gt;
Il vous suffit donc de rajouter ce tag dans vos URL :&lt;br /&gt;
&lt;em&gt;&amp;id_affilie='.$_SESSION['id_affilie].'&lt;/em&gt;';
?&gt;</code></pre><p id="r-372020" data-claire-element-id="372020">Quelques petites explications s'imposent, du coup.<br/> Comme précédemment, on a utilisé mysql_insert_id() pour connaître le numéro de notre nouvel affilié.<br/> Ensuite, on a créé une variable session nommée $_SESSION['id_affilie'] qui a la valeur de ce numéro d'identifiant. Ainsi, on sait que c'est notre affilié qui est connecté et qu'il cherche vraisemblablement à consulter ses résultats. Bref, en créant cette variable, c'est comme lorsque l'on crée une variable session pour dire que le membre est connecté.</p><p id="r-372021" data-claire-element-id="372021">On va donc lui proposer une petite interface pour voir le trafic qu'il nous renvoie.</p><h3 id="r-voir-ses-resultats" data-claire-element-id="372031">Voir ses résultats</h3><p id="r-372022" data-claire-element-id="372022">C'est très simple, rappelez-vous, la table affiliation comportait un champ id_affilie.</p><pre id="r-372023" data-claire-element-id="372023"><code data-claire-semantic="html+php">&lt;?php
$sql='SELECT * from affiliation WHERE id_affilie='.$_SESSION['id_affilie'];
$reponse=mysql_query($sql);
echo '&lt;table&gt;
&lt;caption&gt;vos résultats '.$_SESSION['affilie_site'].'&lt;/caption&gt;
&lt;tr&gt;&lt;th&gt;date&lt;/th&gt;&lt;th&gt;origine&lt;/th&gt;&lt;th&gt;double&lt;/th&gt;&lt;th&gt;paye&lt;/th&gt;&lt;/tr&gt;';
while ($donnees=mysql_fetch_array($reponse)){
        echo '
                &lt;tr&gt;
                &lt;td&gt;'.$donnees['date'].' à '.$donnees['heure'].'&lt;/td&gt;
                &lt;td&gt;'.str_replace('http://','',$donnees['origine']).'&lt;/td&gt;
                &lt;td&gt;'.$donnees['dbclic'].'&lt;/td&gt;
                &lt;td&gt;'.$donnees['paye'].'&lt;/td&gt;
                &lt;/tr&gt;';
        }
echo '&lt;/table&gt;';
?&gt;</code></pre><p id="r-372024" data-claire-element-id="372024">Là, vous avez tout, mais c'est un peu brut...</p><p id="r-372025" data-claire-element-id="372025">Il peut être plus intéressant de lui dire où en est son compte.</p><pre id="r-372026" data-claire-element-id="372026"><code data-claire-semantic="html+php">&lt;?php
$nb_clics_simples=0;
$nb_clics_doubles=0;
$montant_paniers=0;

//comptez les clics simples
$sql='SELECT id from affiliation WHERE id_affilie='.$_SESSION['id_affilie'].' AND db_clic=0';
$reponse=mysql_query($sql);
$nb_clics_simples=mysql_num_rows($reponse);

//comptez les clics doubles
$sql='SELECT id from affiliation WHERE id_affilie='.$_SESSION['id_affilie'].' AND db_clic=1 AND paye=0';
$reponse=mysql_query($sql);
$nb_clics_doubles=mysql_num_rows($reponse);


//comptez les paniers payes
$sql='SELECT affiliation.id_panier, paniers.total from affiliation LEFT JOIN paniers ON paniers.id=affiliation.id_panier WHERE id_affilie='.$_SESSION['id_affilie'].' AND affiliation.paye=1';
$reponse=mysql_query($sql);
while ($donnees=mysql_fetchh_arry($reponse)){
$montant_paniers+=$donnees['total'];
}
?&gt;</code></pre><p id="r-372027" data-claire-element-id="372027">La dernière requête utilise une <a href="http://www.siteduzero.com/tuto-3-8504-1-les-jointures-moyen-d-economiser-des-ressources.html">jointure</a>.<br/> Maintenant qu'on a récupéré ceci, il est facile de calculer les sommes dues :</p><pre id="r-372028" data-claire-element-id="372028"><code data-claire-semantic="html+php">&lt;?php
$sql='SELECT * from affiliation WHERE id_affilie='.$_SESSION['id_affilie'];
$reponse=mysql_query($sql);
echo '&lt;table&gt;
&lt;caption&gt;vos résultats '.$_SESSION['affilie_site'].'&lt;/caption&gt;
&lt;tr&gt;&lt;th&gt;type&lt;/th&gt;&lt;th&gt;nombre&lt;/th&gt;&lt;th&gt;ratio&lt;/th&gt;&lt;th&gt;total&lt;/th&gt;&lt;/tr&gt;';
$donnees=mysql_fetch_array($reponse))
        echo '
                &lt;tr&gt;
                &lt;td&gt;simple clic&lt;/td&gt;
                &lt;td&gt;'.$nb_clics_simples.'&lt;/td&gt;
                &lt;td&gt;'.$donnees['commission_clic'].'&lt;/td&gt;
                &lt;td&gt;'.($nb_clics_simples * $donnees['commission_clic']).'&lt;/td&gt;
                &lt;/tr&gt;';
        echo '
                &lt;tr&gt;
                &lt;td&gt;double clic&lt;/td&gt;
                &lt;td&gt;'.$nb_clics_doubles.'&lt;/td&gt;
                &lt;td&gt;'.$donnees['commission_dbclic'].'&lt;/td&gt;
                &lt;td&gt;'.($nb_clics_doubles * $donnees['commission_dbclic']).'&lt;/td&gt;
                &lt;/tr&gt;';
        echo '
                &lt;tr&gt;
                &lt;td&gt;commissions&lt;/td&gt;
                &lt;td&gt;'.$montant_paniers.'&lt;/td&gt;
                &lt;td&gt;'.$donnees['commission_porcentage'].'&lt;/td&gt;
                &lt;td&gt;'.($montant_paniers * $donnees['commission_pourcentage']).'&lt;/td&gt;
                &lt;/tr&gt;';
        echo '
                &lt;tr&gt;
                &lt;td&gt;TOTAL&lt;/td&gt;
                &lt;td&gt;&lt;/td&gt;
                &lt;td&gt;&lt;/td&gt;
                &lt;td&gt;'.($nb_clics_simples * $donnees['commission_clic']+ $nb_clics_doubles * $donnees['commission_dbclic']$montant_paniers * $donnees['commission_pourcentage']).'&lt;/td&gt;
                &lt;/tr&gt;';        
echo '&lt;/table&gt;';
?&gt;</code></pre><p id="r-372029" data-claire-element-id="372029">Et voilà !</p><p id="r-372030" data-claire-element-id="372030">Ce script est à modifier, à enrichir, à adapter à vos besoins. Je me suis efforcé de prendre trois paramètres pour que vous voyiez ce qui est possible (rémunération au clic, au double clic, à la commission).<br/> Il reste à lui ajouter un système de gestion des factures, de remise à zéro des compteurs pour en faire un script complet. Peut-être que vous en serez l'auteur...</p>
<aside class="aside-menu">
<ul class="content-menu subchapter" role="navigation">
<li class="tuto">
<a href="http://62.4.17.167/informatique/tutoriels/un-systeme-d-affiliation-pour-votre-site">Un système d&#039;affiliation pour votre site</a>
</li>
<ul class="subchapter-parts">
<li>
<a href="http://62.4.17.167/informatique/tutoriels/un-systeme-d-affiliation-pour-votre-site/principe-42">
Principe
</a>
</li>
<li>
<a href="http://62.4.17.167/informatique/tutoriels/un-systeme-d-affiliation-pour-votre-site/du-cote-de-la-table-affiliation">
Du côté de la table affiliation
</a>
</li>
<li class="active">
<a href="http://62.4.17.167/informatique/tutoriels/un-systeme-d-affiliation-pour-votre-site/du-cote-de-la-table-affilies">
Du côté de la table affilies
</a>
</li>
</ul>
</ul>
</aside>
</div>
<div id="content-bottom-menu"></div>
<hr/>
<div class="paginate-tuto">
<a class="before" href="http://62.4.17.167/informatique/tutoriels/un-systeme-d-affiliation-pour-votre-site/du-cote-de-la-table-affiliation">
<span class="arrow"></span>
<span class="next">Du côté de la table affiliation</span>
</a>
</div>
<hr class="bottom"/>
<div class="clear"></div> <div class="adBan">
<script type='text/javascript'>
    if (window.innerWidth >= 728)
    {
        document.write('<div id="div-gpt-ad-1350977194635-8" class="megaban"></div>');
        googletag.cmd.push(function() {
            googletag.display('div-gpt-ad-1350977194635-8');
        });
    }
            else
        {
            document.write('<div id="div-gpt-ad-1350977284180-8" class="miniban"></div>');
            googletag.cmd.push(function() {
                googletag.display('div-gpt-ad-1350977284180-8');
            });
        }
    </script>
</div>
<div class="clear"></div>
</body>
<!-- Mirrored from 62.4.17.167/sdz/sdz/un-systeme-d-affiliation-pour-votre-site.html by HTTrack Website Copier/3.x [XR&CO'2013], Sat, 26 Oct 2013 23:20:14 GMT -->

<!-- Mirrored from sdz.tdct.org/sdz/un-systeme-d-affiliation-pour-votre-site.html by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 30 Nov 2015 04:04:36 GMT -->
</html>
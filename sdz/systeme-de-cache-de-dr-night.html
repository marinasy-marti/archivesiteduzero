<html>

<!-- Mirrored from 62.4.17.167/sdz/sdz/systeme-de-cache-de-dr-night.html by HTTrack Website Copier/3.x [XR&CO'2013], Sun, 27 Oct 2013 03:24:28 GMT -->

<!-- Mirrored from sdz.tdct.org/sdz/systeme-de-cache-de-dr-night.html by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 30 Nov 2015 04:42:38 GMT -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Tutoriel : Système de cache de Dr Night</title>
<link href="medias/sdz_main.css" type="text/css" rel="stylesheet" media="all"/>
</head>
        <body>
<a href="../www.siteduzero.com/informatique/tutoriels/systeme-de-cache-de-dr-night.html" class="version_en_ligne">Version en ligne</a>
<h1>Tutoriel : Système de cache de Dr Night</h1>
<h2>Table des matières</h2><div class="table_des_matieres"><a href="#SystmedecachedeDrNight">Système de cache de Dr Night</a><br/><a href="#Prparatifs">Préparatifs</a><br/><a href="#Crationdesfonctions">Création des fonctions</a><br/><a href="#Exempled039utilisation">Exemple d&#039;utilisation</a><br/></div>
<a name="SystmedecachedeDrNight"></a><h2>Système de cache de Dr Night</h2><div class="paginate-tuto">
<a class="after" href="http://62.4.17.167/informatique/tutoriels/systeme-de-cache-de-dr-night/preparatifs-3">
<span class="next">Préparatifs</span>
<span class="arrow"></span>
</a>
</div>
<hr class="top"/>
<div class="clear"></div> <div class="content">
</div><a name="Prparatifs"></a><h2>Préparatifs</h2><div class="paginate-tuto">
<a class="after" href="http://62.4.17.167/informatique/tutoriels/systeme-de-cache-de-dr-night/creation-des-fonctions">
<span class="next">Création des fonctions</span>
<span class="arrow"></span>
</a>
</div>
<hr class="top"/>
<div class="clear"></div> <div id="content" role="article">
<h2 id="r-creation-du-dossier-cache" data-claire-element-id="340200">Création du dossier <em>cache</em></h2><p id="r-340196" data-claire-element-id="340196">Pour fonctionner, le système de cache a besoin d'un dossier autorisé en lecture et en écriture pour stocker les données temporaires.</p><p id="r-340197" data-claire-element-id="340197">Ici, le dossier sera placé en racine du site et son nom sera <em>cache</em> (ouais, on va pas spécialement chercher quelque chose d'original :lol: ).</p><aside id="r-340199" data-claire-element-id="340199" data-claire-semantic="information"><p id="r-340198" data-claire-element-id="340198">Pour autoriser l'accès en lecture et écriture au répertoire <em>cache</em>, il faut y effectuer un <a href="http://www.siteduzero.com/tuto-3-172-1-lire-et-ecrire-dans-un-fichier.html#ss_part_1">chmod 777</a>.</p></aside><h2 id="r-fonctionnement-27" data-claire-element-id="340218">Fonctionnement</h2><p id="r-340201" data-claire-element-id="340201">Le système de cache a besoin d'effectuer <strong>trois actions</strong> :</p><ul id="r-340208" data-claire-element-id="340208"><li id="r-340203" data-claire-element-id="340203"><p id="r-340202" data-claire-element-id="340202"><strong>créer</strong> un fichier de cache contenant des informations,</p></li><li id="r-340205" data-claire-element-id="340205"><p id="r-340204" data-claire-element-id="340204"><strong>lire</strong> les informations contenues dans un fichier de cache,</p></li><li id="r-340207" data-claire-element-id="340207"><p id="r-340206" data-claire-element-id="340206"><strong>détruire</strong> un fichier de cache.</p></li></ul><div id="r-340210" data-claire-element-id="340210" data-claire-semantic="question"><p id="r-340209" data-claire-element-id="340209">On a seulement besoin de ces trois actions ? o_O</p></div><p id="r-340211" data-claire-element-id="340211">Oui, le système est basé sur la création et la suppression de fichiers, et pas vraiment sur la modification.</p><h3 id="r-explications-24" data-claire-element-id="340217">Explications</h3><p id="r-340212" data-claire-element-id="340212">Imaginons que nous voulons mettre en cache les messages d'un sujet de forum.</p><p id="r-340213" data-claire-element-id="340213"><strong>Au premier affichage</strong>, le script constate qu'il n'existe pas de fichier de cache contenant les messages voulus, il va alors récupérer dans la base de données les messages, puis créera un nouveau fichier de cache contenant ces messages.</p><p id="r-340214" data-claire-element-id="340214"><strong>Aux prochains affichages</strong>, le script verra que le fichier de cache existe et lira donc son contenu, sans passer par la base de données.</p><p id="r-340215" data-claire-element-id="340215"><strong>Lors d'une modification</strong>, c'est-à-dire quand un message sera posté, le fichier de cache sera effacé, et la base de données mise à jour pour qu'au prochain affichage, un nouveau fichier de cache soit créé !</p><p id="r-340216" data-claire-element-id="340216">Regardez bien, il n'y a que trois actions différentes à effectuer. ;) On peut maintenant commencer le concret !</p>
<aside class="aside-menu">
<ul class="content-menu subchapter" role="navigation">
<li class="tuto">
<a href="http://62.4.17.167/informatique/tutoriels/systeme-de-cache-de-dr-night">Système de cache de Dr Night</a>
</li>
<ul class="subchapter-parts">
<li class="active">
<a href="http://62.4.17.167/informatique/tutoriels/systeme-de-cache-de-dr-night/preparatifs-3">
Préparatifs
</a>
</li>
<li>
<a href="http://62.4.17.167/informatique/tutoriels/systeme-de-cache-de-dr-night/creation-des-fonctions">
Création des fonctions
</a>
</li>
<li>
<a href="http://62.4.17.167/informatique/tutoriels/systeme-de-cache-de-dr-night/exemple-d-utilisation-10">
Exemple d&#039;utilisation
</a>
</li>
</ul>
</ul>
</aside>
</div>
<div id="content-bottom-menu"></div>
<hr/>
<div class="paginate-tuto">
<a class="after" href="http://62.4.17.167/informatique/tutoriels/systeme-de-cache-de-dr-night/creation-des-fonctions">
<span class="next">Création des fonctions</span>
<span class="arrow"></span>
</a>
</div>
<hr class="bottom"/>
<div class="clear"></div> <div class="adBan">
<script type='text/javascript'>
    if (window.innerWidth >= 728)
    {
        document.write('<div id="div-gpt-ad-1350977194635-8" class="megaban"></div>');
        googletag.cmd.push(function() {
            googletag.display('div-gpt-ad-1350977194635-8');
        });
    }
            else
        {
            document.write('<div id="div-gpt-ad-1350977284180-8" class="miniban"></div>');
            googletag.cmd.push(function() {
                googletag.display('div-gpt-ad-1350977284180-8');
            });
        }
    </script>
</div>
<div class="clear"></div><a name="Crationdesfonctions"></a><h2>Création des fonctions</h2><div class="paginate-tuto">
<a class="before" href="http://62.4.17.167/informatique/tutoriels/systeme-de-cache-de-dr-night/preparatifs-3">
<span class="arrow"></span>
<span class="next">Préparatifs</span>
</a>
<a class="after" href="http://62.4.17.167/informatique/tutoriels/systeme-de-cache-de-dr-night/exemple-d-utilisation-10">
<span class="next">Exemple d&#039;utilisation</span>
<span class="arrow"></span>
</a>
</div>
<hr class="top"/>
<div class="clear"></div> <div id="content" role="article">
<h2 id="r-definition-des-fonctions" data-claire-element-id="340229">Définition des fonctions</h2><p id="r-340220" data-claire-element-id="340220">Comme je l'ai dit plus haut, le système de cache a besoin d'effectuer trois actions principales. Ces trois grandes actions vont être effectuées par trois fonctions PHP (que nous allons créer) :</p><ul id="r-340227" data-claire-element-id="340227"><li id="r-340222" data-claire-element-id="340222"><p id="r-340221" data-claire-element-id="340221"><strong>create_cache</strong>(nom_cache,contenu)</p></li><li id="r-340224" data-claire-element-id="340224"><p id="r-340223" data-claire-element-id="340223"><strong>get_cache</strong>(nom_cache)</p></li><li id="r-340226" data-claire-element-id="340226"><p id="r-340225" data-claire-element-id="340225"><strong>destroy_cache</strong>(nom_cache)</p></li></ul><p id="r-340228" data-claire-element-id="340228">Vous l'aurez peut-être compris, <strong>create_cache</strong>() permet d'enregistrer contenu dans le fichier de cache nommé nom_cache, <strong>get_cache</strong>() permet de récupérer contenu et <strong>destroy_cache</strong>() permet de détruire le cache nom_cache.</p><h2 id="r-ecriture-des-fonctions" data-claire-element-id="340259">Écriture des fonctions</h2><h3 id="r-creation-d-un-cache" data-claire-element-id="340240">Création d'un cache</h3><p id="r-340230" data-claire-element-id="340230"><strong>create_cache()</strong></p><div id="r-340232" data-claire-element-id="340232" data-claire-semantic="question"><p id="r-340231" data-claire-element-id="340231">OK, c'est cool, mais maintenant on l'enregistre comment, le cache ? Comment elle fonctionne, la fonction <strong>create_cache</strong>() ?</p></div><p id="r-340233" data-claire-element-id="340233">L'idée est d'obtenir une fonction PHP qui, quand on l'appelle, restitue les données qu'on lui a fournies lors de sa création.</p><p id="r-340234" data-claire-element-id="340234">Pour stocker tout type de données, on va utiliser la fonction <strong>serialize</strong>(), qui transforme n'importe quelle variable (ou presque) en une chaîne de caractères.</p><p id="r-340235" data-claire-element-id="340235">Le fichier créé contiendra le code permettant de récupérer la variable initiale en utilisant la fonction <strong>unserialize</strong>().</p><p id="r-340236" data-claire-element-id="340236">Voilà la fonction que j'ai faite :</p><pre id="r-340237" data-claire-element-id="340237"><code data-claire-semantic="html+php">&lt;?php
// met en cache une variable
function create_cache($nom_cache, $contenu)
{
        // Utilisation de serialize() pour transformer $content en chaîne de caractères.
        $contenu = serialize($contenu);

        // Échappement les caractères spéciaux pour pouvoir mettre le tout entre quotes dans le futur fichier.
        $contenu = str_replace(array('', '\'', &quot;0&quot;), array('\\', '\'', '0'), $contenu);

        // Création du code PHP à stocker dans le fichier.
        $contenu = '&lt;?php' . &quot;nn&quot; . '$cache = unserialize('' .  $contenu . '');' . &quot;nn&quot; . '?&gt;';
        
        // Écriture du code dans le fichier.
        $fichier = fopen('./cache/donnees_' . $nom_cache . '.php', 'w');
        $resultat = fwrite($fichier, $contenu);
        fclose($fichier);

        // Renvoie true si l'écriture du fichier a réussi.
        return $resultat;
}?&gt;</code></pre><aside id="r-340239" data-claire-element-id="340239" data-claire-semantic="information"><p id="r-340238" data-claire-element-id="340238">Note : <strong>$nom_cache</strong> est le nom sous lequel le cache est stocké et <strong>$contenu</strong>, la variable contenant les données à mettre en cache.</p></aside><h3 id="r-lecture-d-un-cache" data-claire-element-id="340252">Lecture d'un cache</h3><p id="r-340241" data-claire-element-id="340241"><strong>get_cache()</strong></p><p id="r-340242" data-claire-element-id="340242">Vous pouvez tester la fonction <strong>create_cache</strong>(), par exemple en faisant <br/><strong>create_cache</strong>('test', 'Bonjour !').</p><p id="r-340243" data-claire-element-id="340243">Vous verrez ensuite qu'un fichier nommé <em>donnees_test.php</em> aura été créé dans le dossier <em>cache/</em>.</p><p id="r-340244" data-claire-element-id="340244">Si l'on regarde le contenu du fichier donnees_test.php, on voit ceci :</p><pre id="r-340245" data-claire-element-id="340245"><code data-claire-semantic="html+php">&lt;?php

$cache = unserialize('s:9:&quot;Bonjour !&quot;;');

?&gt;</code></pre><p id="r-340246" data-claire-element-id="340246">Le fichier contient les données <em>sérialisées</em>. Lorsqu'il est exécuté, il recrée les données telles qu'elles étaient au moment de la création du cache avec <strong>unserialize</strong>() et les enregistre dans la variable <strong>$cache</strong>.</p><p id="r-340247" data-claire-element-id="340247">La fonction <strong>get_cache</strong>() a donc juste servi à appeler le fichier créé en utilisant <strong>include</strong>(), puis à retourner le contenu de <strong>$cache</strong>.</p><p id="r-340248" data-claire-element-id="340248">Voici le code que je vous propose :</p><pre id="r-340249" data-claire-element-id="340249"><code data-claire-semantic="html+php">&lt;?php
// Récupère une variable mise en cache.
function get_cache($nom_cache)
{
        // Vérifie que le fichier de cache existe.
        if ( is_file('./cache/donnees_' . $nom_cache . '.php') )
        {
                // Le fichier existe, on l'exécute puis on retourne le contenu de $cache.
                include('./cache/donnees_' . $nom_cache . '.php');
                return $cache;
        }
        else
        {
                // Le fichier de cache n'existe pas, on retourne false.
                return false;
        }
}
?&gt;</code></pre><aside id="r-340251" data-claire-element-id="340251" data-claire-semantic="warning"><p id="r-340250" data-claire-element-id="340250">Il est important de retourner <strong>false</strong> si le fichier de cache est inexistant. C'est en effet primordial pour le fonctionnement général du système. Cela permet de savoir si un cache existe ou non (vous comprendrez un peu plus bas, si ce n'est pas déjà fait ;) ).</p></aside><h3 id="r-destruction-d-un-cache" data-claire-element-id="340258">Destruction d'un cache</h3><p id="r-340253" data-claire-element-id="340253"><strong>destroy_cache()</strong></p><p id="r-340254" data-claire-element-id="340254">Cette fonction est simple. Elle permet juste de supprimer un fichier de cache en utilisant la fonction <strong>unlink</strong>() :</p><pre id="r-340255" data-claire-element-id="340255"><code data-claire-semantic="html+php">&lt;?php
// Détruit un cache.
function destroy_cache($nom_cache)
{
        return @unlink('./cache/donnees_' . $nom_cache . '.php');
}
?&gt;</code></pre><aside id="r-340257" data-claire-element-id="340257" data-claire-semantic="information"><p id="r-340256" data-claire-element-id="340256">Le <strong>@</strong> permet de ne pas afficher de message d'erreur dans le cas où <strong>unlink</strong>() tenterait d'effacer un fichier qui n'existe pas.</p></aside>
<aside class="aside-menu">
<ul class="content-menu subchapter" role="navigation">
<li class="tuto">
<a href="http://62.4.17.167/informatique/tutoriels/systeme-de-cache-de-dr-night">Système de cache de Dr Night</a>
</li>
<ul class="subchapter-parts">
<li>
<a href="http://62.4.17.167/informatique/tutoriels/systeme-de-cache-de-dr-night/preparatifs-3">
Préparatifs
</a>
</li>
<li class="active">
<a href="http://62.4.17.167/informatique/tutoriels/systeme-de-cache-de-dr-night/creation-des-fonctions">
Création des fonctions
</a>
</li>
<li>
<a href="http://62.4.17.167/informatique/tutoriels/systeme-de-cache-de-dr-night/exemple-d-utilisation-10">
Exemple d&#039;utilisation
</a>
</li>
</ul>
</ul>
</aside>
</div>
<div id="content-bottom-menu"></div>
<hr/>
<div class="paginate-tuto">
<a class="before" href="http://62.4.17.167/informatique/tutoriels/systeme-de-cache-de-dr-night/preparatifs-3">
<span class="arrow"></span>
<span class="next">Préparatifs</span>
</a>
<a class="after" href="http://62.4.17.167/informatique/tutoriels/systeme-de-cache-de-dr-night/exemple-d-utilisation-10">
<span class="next">Exemple d&#039;utilisation</span>
<span class="arrow"></span>
</a>
</div>
<hr class="bottom"/>
<div class="clear"></div> <div class="adBan">
<script type='text/javascript'>
    if (window.innerWidth >= 728)
    {
        document.write('<div id="div-gpt-ad-1350977194635-8" class="megaban"></div>');
        googletag.cmd.push(function() {
            googletag.display('div-gpt-ad-1350977194635-8');
        });
    }
            else
        {
            document.write('<div id="div-gpt-ad-1350977284180-8" class="miniban"></div>');
            googletag.cmd.push(function() {
                googletag.display('div-gpt-ad-1350977284180-8');
            });
        }
    </script>
</div>
<div class="clear"></div><a name="Exempled039utilisation"></a><h2>Exemple d&#039;utilisation</h2><div class="paginate-tuto">
<a class="before" href="http://62.4.17.167/informatique/tutoriels/systeme-de-cache-de-dr-night/creation-des-fonctions">
<span class="arrow"></span>
<span class="next">Création des fonctions</span>
</a>
</div>
<hr class="top"/>
<div class="clear"></div> <div id="content" role="article">
<p id="r-340261" data-claire-element-id="340261">Voilà ! On a créé nos 3 fonctions. Il ne reste plus qu'à les utiliser ! :)</p><p id="r-340262" data-claire-element-id="340262">Je vais donc, en reprenant l'exemple des messages d'un sujet de forum, vous montrer comment les fonctions s'emploient. Vous allez voir, ce n'est pas compliqué ! ;)</p><h2 id="r-lecture-des-messages" data-claire-element-id="340282">Lecture des messages</h2><h3 id="r-sans-le-systeme-de-cache" data-claire-element-id="340265">Sans le système de cache</h3><p id="r-340263" data-claire-element-id="340263">Voici un script d'exemple simplifié récupérant les messages du sujet :</p><pre id="r-340264" data-claire-element-id="340264"><code data-claire-semantic="html+php">&lt;?php

// Récupération des messages.
$resultat = mysql_query('SELECT * FROM messages WHERE sujet = 42');

while ( $ligne = mysql_fetch_array($resultat) )
{
        //
        // On affiche les messages.
        //
}

?&gt;</code></pre><h3 id="r-avec-le-systeme-de-cache" data-claire-element-id="340273">Avec le système de cache</h3><p id="r-340266" data-claire-element-id="340266">Voici maintenant le même script, avec le système de cache.</p><pre id="r-340267" data-claire-element-id="340267"><code data-claire-semantic="html+php">&lt;?php

// On essaye de récupérer les données dans le cache.
if ( !$donnees = get_cache('messages_sujet_42') )
{
        // Le cache n'existe pas, récupération des messages dans la base de données.
        $resultat = mysql_query('SELECT * FROM messages WHERE sujet = 42');

        // Stockage du résultat dans la variable $donnees.
        $donnees = array();
        while ( $donnees[] = mysql_fetch_array($resultat) );

        // Mise en cache de $donnees.
        create_cache('messages_sujet_42', $donnees);
}

// Lecture des messages.
foreach ( $donnees as $ligne )
{
        //
        // On affiche les messages.
        //
}

?&gt;</code></pre><div id="r-340269" data-claire-element-id="340269" data-claire-semantic="question"><p id="r-340268" data-claire-element-id="340268">Que fait le second script ?</p></div><p id="r-340270" data-claire-element-id="340270">Le second script, contrairement au premier, utilise un intermédiaire : la variable <strong>$donnees</strong>. Si le cache existe, on met le contenu du cache dans <strong>$donnees</strong>, sinon on y met le contenu lu depuis la base de données, et on recrée le cache.</p><p id="r-340271" data-claire-element-id="340271">Ensuite, on lit les messages ligne par ligne à partir de <strong>$donnees</strong> comme si on lisait les lignes obtenues à partir d'une requête SQL.</p><p id="r-340272" data-claire-element-id="340272">Ainsi, vous n'avez pas à modifier le code qui consiste à afficher les messages.</p><h3 id="r-mise-a-jour-du-cache-lors-d-une-modification" data-claire-element-id="340281">Mise à jour du cache lors d'une modification</h3><p id="r-340274" data-claire-element-id="340274">Voici un code simplifié d'exemple lorsqu'un message est posté :</p><pre id="r-340275" data-claire-element-id="340275"><code data-claire-semantic="html+php">&lt;?php

// Ajout d'un message.
mysql_query('INSERT INTO messages(texte, sujet) VALUES ('blablablablabla', 42)');

?&gt;</code></pre><p id="r-340276" data-claire-element-id="340276">Ici, il n'y a qu'une chose à faire : supprimer le fichier de cache pour qu'à la prochaine lecture des messages, il soit remis à jour :) :</p><pre id="r-340277" data-claire-element-id="340277"><code data-claire-semantic="html+php">&lt;?php

// Ajout d'un message.
mysql_query('INSERT INTO messages(texte, sujet) VALUES (\'blablablablabla\', 42)');

// Suppression du cache.
destroy_cache('messages_sujet_42');

?&gt;</code></pre><p id="r-340278" data-claire-element-id="340278">Voilà ! Ici, le système de cache a été mis en place assez facilement sans grande modification. Avec un système de ce type, on peut facilement ajouter le cache à ses anciens scripts, par exemple ! ;)</p><p id="r-340279" data-claire-element-id="340279">Ce tutoriel s'achève ici, je vous souhaite une bonne optimisation de vos scripts ! :lol:</p><p id="r-340280" data-claire-element-id="340280">Et si vous avez des questions, les commentaires sont là.</p>
<aside class="aside-menu">
<ul class="content-menu subchapter" role="navigation">
<li class="tuto">
<a href="http://62.4.17.167/informatique/tutoriels/systeme-de-cache-de-dr-night">Système de cache de Dr Night</a>
</li>
<ul class="subchapter-parts">
<li>
<a href="http://62.4.17.167/informatique/tutoriels/systeme-de-cache-de-dr-night/preparatifs-3">
Préparatifs
</a>
</li>
<li>
<a href="http://62.4.17.167/informatique/tutoriels/systeme-de-cache-de-dr-night/creation-des-fonctions">
Création des fonctions
</a>
</li>
<li class="active">
<a href="http://62.4.17.167/informatique/tutoriels/systeme-de-cache-de-dr-night/exemple-d-utilisation-10">
Exemple d&#039;utilisation
</a>
</li>
</ul>
</ul>
</aside>
</div>
<div id="content-bottom-menu"></div>
<hr/>
<div class="paginate-tuto">
<a class="before" href="http://62.4.17.167/informatique/tutoriels/systeme-de-cache-de-dr-night/creation-des-fonctions">
<span class="arrow"></span>
<span class="next">Création des fonctions</span>
</a>
</div>
<hr class="bottom"/>
<div class="clear"></div> <div class="adBan">
<script type='text/javascript'>
    if (window.innerWidth >= 728)
    {
        document.write('<div id="div-gpt-ad-1350977194635-8" class="megaban"></div>');
        googletag.cmd.push(function() {
            googletag.display('div-gpt-ad-1350977194635-8');
        });
    }
            else
        {
            document.write('<div id="div-gpt-ad-1350977284180-8" class="miniban"></div>');
            googletag.cmd.push(function() {
                googletag.display('div-gpt-ad-1350977284180-8');
            });
        }
    </script>
</div>
<div class="clear"></div>
</body>
<!-- Mirrored from 62.4.17.167/sdz/sdz/systeme-de-cache-de-dr-night.html by HTTrack Website Copier/3.x [XR&CO'2013], Sun, 27 Oct 2013 03:24:28 GMT -->

<!-- Mirrored from sdz.tdct.org/sdz/systeme-de-cache-de-dr-night.html by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 30 Nov 2015 04:42:39 GMT -->
</html>
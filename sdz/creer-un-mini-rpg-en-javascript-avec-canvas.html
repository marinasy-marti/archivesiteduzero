<html>

<!-- Mirrored from 62.4.17.167/sdz/sdz/creer-un-mini-rpg-en-javascript-avec-canvas.html by HTTrack Website Copier/3.x [XR&CO'2013], Sun, 27 Oct 2013 01:53:02 GMT -->

<!-- Mirrored from sdz.tdct.org/sdz/creer-un-mini-rpg-en-javascript-avec-canvas.html by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 30 Nov 2015 04:29:46 GMT -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Tutoriel : Créer un mini-RPG en JavaScript avec canvas</title>
<link href="medias/sdz_main.css" type="text/css" rel="stylesheet" media="all"/>
</head>
        <body>
<a href="../www.siteduzero.com/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas.html" class="version_en_ligne">Version en ligne</a>
<h1>Tutoriel : Créer un mini-RPG en JavaScript avec canvas</h1>
<h2>Table des matières</h2><div class="table_des_matieres"><a href="#Crerunmini-RPGenJavaScriptaveccanvas">Créer un mini-RPG en JavaScript avec canvas</a><br/><a href="#Miseenplacedesbases">Mise en place des bases</a><br/><a href="#Structuredesfichiers">Structure des fichiers</a><br/><a href="#Miseenplaceducanvas">Mise en place du canvas</a><br/><a href="#Lecasd039InternetExplorer">Le cas d&#039;Internet Explorer</a><br/><a href="#Utilisationdel039objetcontext">Utilisation de l&#039;objet context</a><br/><a href="#Gestiondestilesets">Gestion des tilesets</a><br/><a href="#Prsentation">Présentation</a><br/><a href="#Dcoupageetutilisation">Découpage et utilisation</a><br/><a href="#Miseenplaceduterrain">Mise en place du terrain</a><br/><a href="#Formatdestockagedesdonnes">Format de stockage des données</a><br/><a href="#Chargementetaffichageduterrain">Chargement et affichage du terrain</a><br/><a href="#Lespersonnages">Les personnages</a><br/><a href="#Choixetrendudessprites">Choix et rendu des sprites</a><br/><a href="#Clavieretboucleprincipale">Clavier et boucle principale</a><br/><a href="#Animationdesdplacements">Animation des déplacements</a><br/></div>
<a name="Crerunmini-RPGenJavaScriptaveccanvas"></a><h2>Créer un mini-RPG en JavaScript avec canvas</h2><div class="content" role="article">
<p id="r-497942" data-claire-element-id="497942">Je vois régulièrement sur des forums d'informatique des novices qui souhaitent créer leurs propres jeux, et plus précisément leurs propres MMORPG (jeu de rôle massivement multijoueurs) en général.<br/> C'est une tâche ardue, et j'ai moi même commencé par là. Je n'aborderai ici que l'aspect technique (programmation) du jeu.</p><div id="r-497944" data-claire-element-id="497944" data-claire-semantic="question"><p id="r-497943" data-claire-element-id="497943">Alors tu vas nous apprendre à créer un MMORPG complet ?</p></div><p id="r-497945" data-claire-element-id="497945">Non. Ce tutoriel a pour but de vous montrer les bases de la programmation d'un RPG en Javascript. Je n'aborderai pas l'aspect MMO, c'est à dire que ce sera un jeu en solo et pas multijoueurs. D'autre part, je rappelle que c'est un mini-RPG. Ce sera un jeu de rôle très basique et ne comportera globalement que la partie graphique du jeu.<br/> Une fois les bases acquises, je pars du principe que vous saurez vous débrouiller seul. Il est donc important que vous alliez de l'avant en apportant vos propres modifications et essais au code que je propose. Le copié-collé sans chercher à comprendre ne vous servira à rien, et vous seriez probablement bloqué dès la fin du tuto.</p><aside id="r-497947" data-claire-element-id="497947" data-claire-semantic="information"><p id="r-497946" data-claire-element-id="497946">Il n'y a pas qu'une seule méthode pour faire un jeu. Celle que je présente n'est peut être pas la meilleure, mais en tout cas c'est une méthode qui fonctionne, et c'est celle que j'utilise.</p></aside><p id="r-497948" data-claire-element-id="497948">En résumé, voici ce que vous apprendrez à faire dans ce cours :</p><ul id="r-497959" data-claire-element-id="497959"><li id="r-497950" data-claire-element-id="497950"><p id="r-497949" data-claire-element-id="497949">Organiser les différentes données du jeu pour avoir un système aussi dynamique que possible</p></li><li id="r-497952" data-claire-element-id="497952"><p id="r-497951" data-claire-element-id="497951">Afficher une carte du monde</p></li><li id="r-497954" data-claire-element-id="497954"><p id="r-497953" data-claire-element-id="497953">Afficher des personnages qui peuvent se déplacer, et gérer l'animation de leurs déplacements</p></li><li id="r-497956" data-claire-element-id="497956"><p id="r-497955" data-claire-element-id="497955">Gérer la caméra</p></li><li id="r-497958" data-claire-element-id="497958"><p id="r-497957" data-claire-element-id="497957">Afficher des éléments d'interface (indicateur de vie par exemple)</p></li></ul><aside id="r-497968" data-claire-element-id="497968" data-claire-semantic="warning"><p id="r-497960" data-claire-element-id="497960">Pour suivre ce cours, vous devez d'abord maîtriser :</p><ul id="r-497967" data-claire-element-id="497967"><li id="r-497962" data-claire-element-id="497962"><p id="r-497961" data-claire-element-id="497961"><a href="http://www.siteduzero.com/tutoriel-2-69-xhtml-css.html">HTML</a></p></li><li id="r-497964" data-claire-element-id="497964"><p id="r-497963" data-claire-element-id="497963"><a href="http://www.siteduzero.com/tutoriel-3-8158-tout-sur-le-javascript.html">JavaScript et sa programmation objet</a></p></li><li id="r-497966" data-claire-element-id="497966"><p id="r-497965" data-claire-element-id="497965"><a href="http://www.siteduzero.com/tutoriel-3-4745-ajax-et-l-echange-de-donnees-en-javascript.html">AJAX</a></p></li></ul></aside>
</div>
<div class="adBan">
<script type='text/javascript'>
    if (window.innerWidth >= 728)
    {
        document.write('<div id="div-gpt-ad-1358423835269-0" class="megaban"></div>');
        googletag.cmd.push(function() {
            googletag.display('div-gpt-ad-1358423835269-0');
        });
    }
    </script>
</div><a name="Miseenplacedesbases"></a><h2>Mise en place des bases</h2><div class="paginate-tuto">
<a class="after" href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/structure-des-fichiers">
<span class="next">Structure des fichiers</span>
<span class="arrow"></span>
</a>
</div>
<hr class="top"/>
<div class="clear"></div> <div class="content">
<p id="r-497971" data-claire-element-id="497971">Dans cette partie, nous allons poser les fondations de notre jeu.</p><p id="r-497972" data-claire-element-id="497972">Ce n'est pas une partie difficile, mais c'est la plus importante.</p>
</div><a name="Structuredesfichiers"></a><h2>Structure des fichiers</h2><div class="paginate-tuto">
<a class="before" href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/mise-en-place-des-bases">
<span class="arrow"></span>
<span class="next">Mise en place des bases</span>
</a>
<a class="after" href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/mise-en-place-du-canvas">
<span class="next">Mise en place du canvas</span>
<span class="arrow"></span>
</a>
</div>
<hr class="top"/>
<div class="clear"></div> <div id="content" role="article">
<h4 id="r-structure-des-fichiers" data-claire-element-id="498002">Structure des fichiers</h4><h5 id="r-explications-38" data-claire-element-id="497977">Explications</h5><p id="r-497973" data-claire-element-id="497973">Avant de commencer tout codage, je pense qu'il est important de mettre en place l'arborescence de notre application. Vous n'êtes bien sûr pas forcé d'utiliser la même que moi, mais au moins nous saurons avec précision où trouver ce que l'on cherche.</p><aside id="r-497975" data-claire-element-id="497975" data-claire-semantic="information"><p id="r-497974" data-claire-element-id="497974">Ce tuto ne comportera aucun code exécuté côté serveur. Vous pouvez donc vous passer d'un serveur si vous n'en avez pas à disposition, mais il faudra peut-être configurer votre navigateur pour certaines parties (notamment pour autoriser l'utilisation de l'AJAX en mode hors ligne).</p></aside><p id="r-497976" data-claire-element-id="497976">Notre application terminée ne comportera qu'un seul et unique fichier HTML. Je le nomme index.html pour des raisons pratiques, mais si vous intégrez plus tard notre mini-RPG dans un site plus complet, sachez que le nom de ce fichier n'a aucune importance.</p><h5 id="r-arborescence-2" data-claire-element-id="497996">Arborescence</h5><p id="r-497978" data-claire-element-id="497978">J'ai également à la racine de mon application les dossiers suivants :</p><ul id="r-497989" data-claire-element-id="497989"><li id="r-497980" data-claire-element-id="497980"><p id="r-497979" data-claire-element-id="497979">css</p></li><li id="r-497982" data-claire-element-id="497982"><p id="r-497981" data-claire-element-id="497981">js</p></li><li id="r-497984" data-claire-element-id="497984"><p id="r-497983" data-claire-element-id="497983">maps</p></li><li id="r-497986" data-claire-element-id="497986"><p id="r-497985" data-claire-element-id="497985">sprites</p></li><li id="r-497988" data-claire-element-id="497988"><p id="r-497987" data-claire-element-id="497987">tilesets</p></li></ul><p id="r-497990" data-claire-element-id="497990">Comme vous devez vous en douter, les dossiers js et css contiendront nos fichiers JavaScript et CSS. Le dossier maps comportera les fichiers définissant les cartes de notre jeu (j'ai l'habitude de les appeler &quot;map&quot;, ce qui veut dire la même chose en Anglais. Si vous êtes amateur de jeux, ce terme devrait vous être familier.). Quant aux sprites et aux tilesets, j'expliquerai ça plus tard.<br/> Dans mon dossier js, j'ai un sous-répertoire &quot;classes&quot;. J'organiserai mon code comme ceci :</p><ul id="r-497995" data-claire-element-id="497995"><li id="r-497992" data-claire-element-id="497992"><p id="r-497991" data-claire-element-id="497991">Les fichiers directement placés dans js seront des fonctions et des bouts de codes divers</p></li><li id="r-497994" data-claire-element-id="497994"><p id="r-497993" data-claire-element-id="497993">Chaque classe JavaScript sera dans le dossier js/classes, et le nom du fichier sera celui de la classe, suivi de l'extension (.js)</p></li></ul><h5 id="r-resultat-13" data-claire-element-id="498001">Résultat</h5><p id="r-497997" data-claire-element-id="497997">Vous devriez avoir quelque chose comme ceci :</p><figure id="r-497999" data-claire-element-id="498000"><img id="r-497998" data-claire-element-id="497998" src="medias/uploads.siteduzero.com_files_298001_299000_298805.png" alt="Structure de base de notre mini-RPG"/></figure>
<aside class="aside-menu">
<ul class="content-menu" role="navigation">
<li class="tuto">
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas">Créer un mini-RPG en JavaScript avec canvas</a>
</li>
<li class="chapter">
 
<a class="chapterLink" onmouseover="$(this).addClass('box-shadow-summary').next().addClass('box-shadow-summary');" onmouseout="$(this).removeClass('box-shadow-summary').next().removeClass('box-shadow-summary');">
<span>Partie 1</span>
La carte
</a>
<a class="chapterOpen" href="#" onmouseover="$(this).addClass('box-shadow-summary').prev().addClass('box-shadow-summary');" onmouseout="$(this).removeClass('box-shadow-summary').prev().removeClass('box-shadow-summary');">
<span>+</span>
</a>
 
<ul class="subchapters">
<li class="subchapter">
<div>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/mise-en-place-des-bases">Mise en place des bases</a>
<a class="subchapterOpen" href="#">
<span>+</span>
</a>
</div>
<ul class="subchapter-parts">
<li class="active">
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/structure-des-fichiers">
Structure des fichiers
</a>
</li>
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/mise-en-place-du-canvas">
Mise en place du canvas
</a>
</li>
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/le-cas-d-internet-explorer">
Le cas d&#039;Internet Explorer
</a>
</li>
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/utilisation-de-l-objet-context">
Utilisation de l&#039;objet context
</a>
</li>
</ul> </li> <li class="subchapter">
<div>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/gestion-des-tilesets">Gestion des tilesets</a>
<a class="subchapterOpen" href="#">
<span>+</span>
</a>
</div>
<ul class="subchapter-parts">
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/presentation-132">
Présentation
</a>
</li>
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/decoupage-et-utilisation">
Découpage et utilisation
</a>
</li>
</ul> </li> <li class="subchapter">
<div>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/mise-en-place-du-terrain">Mise en place du terrain</a>
<a class="subchapterOpen" href="#">
<span>+</span>
</a>
</div>
<ul class="subchapter-parts">
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/format-de-stockage-des-donnees">
Format de stockage des données
</a>
</li>
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/chargement-et-affichage-du-terrain">
Chargement et affichage du terrain
</a>
</li>
</ul> </li></ul> </li>
<li class="chapter">
 
<a class="chapterLink" onmouseover="$(this).addClass('box-shadow-summary').next().addClass('box-shadow-summary');" onmouseout="$(this).removeClass('box-shadow-summary').next().removeClass('box-shadow-summary');">
<span>Partie 2</span>
Les personnages et les décors
</a>
<a class="chapterOpen" href="#" onmouseover="$(this).addClass('box-shadow-summary').prev().addClass('box-shadow-summary');" onmouseout="$(this).removeClass('box-shadow-summary').prev().removeClass('box-shadow-summary');">
<span>+</span>
</a>
 
<ul class="subchapters">
<li class="subchapter">
<div>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/les-personnages-1">Les personnages</a>
<a class="subchapterOpen" href="#">
<span>+</span>
</a>
</div>
<ul class="subchapter-parts">
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/choix-et-rendu-des-sprites">
Choix et rendu des sprites
</a>
</li>
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/clavier-et-boucle-principale">
Clavier et boucle principale
</a>
</li>
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/animation-des-deplacements">
Animation des déplacements
</a>
</li>
</ul>
</li>
</ul>
</li>
</li>
</ul>
</aside>
</div>
<div id="content-bottom-menu"></div>
<hr/>
<div class="paginate-tuto">
<a class="before" href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/mise-en-place-des-bases">
<span class="arrow"></span>
<span class="next">Mise en place des bases</span>
</a>
<a class="after" href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/mise-en-place-du-canvas">
<span class="next">Mise en place du canvas</span>
<span class="arrow"></span>
</a>
</div>
<hr class="bottom"/>
<div class="clear"></div> <div class="adBan">
<script type='text/javascript'>
    if (window.innerWidth >= 728)
    {
        document.write('<div id="div-gpt-ad-1350977194635-8" class="megaban"></div>');
        googletag.cmd.push(function() {
            googletag.display('div-gpt-ad-1350977194635-8');
        });
    }
            else
        {
            document.write('<div id="div-gpt-ad-1350977284180-8" class="miniban"></div>');
            googletag.cmd.push(function() {
                googletag.display('div-gpt-ad-1350977284180-8');
            });
        }
    </script>
</div>
<div class="clear"></div><a name="Miseenplaceducanvas"></a><h2>Mise en place du canvas</h2><div class="paginate-tuto">
<a class="before" href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/structure-des-fichiers">
<span class="arrow"></span>
<span class="next">Structure des fichiers</span>
</a>
<a class="after" href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/le-cas-d-internet-explorer">
<span class="next">Le cas d&#039;Internet Explorer</span>
<span class="arrow"></span>
</a>
</div>
<hr class="top"/>
<div class="clear"></div> <div id="content" role="article">
<h4 id="r-mise-en-place-du-canvas" data-claire-element-id="498025">Mise en place du canvas</h4><h5 id="r-code-de-base-3" data-claire-element-id="498009">Code de base</h5><p id="r-498003" data-claire-element-id="498003">Bien, maintenant que nous avons mis en place notre arborescence, nous pouvons commencer la partie la plus intéressante : le codage. Ouvrez le fichier index.html (et créez le si ce n'est pas déjà fait) dans votre éditeur favori.</p><p id="r-498004" data-claire-element-id="498004">Copiez/collez la page suivante (elle est vide mais ça vous évitera de devoir tout taper ;) ) :</p><pre id="r-498005" data-claire-element-id="498005"><code data-claire-semantic="html">&lt;!DOCTYPE html&gt;
&lt;html&gt;
	&lt;head&gt;
		&lt;title&gt;Mini-RPG&lt;/title&gt;
	&lt;/head&gt;
	&lt;body&gt;
		
	&lt;/body&gt;
&lt;/html&gt;</code></pre><aside id="r-498007" data-claire-element-id="498007" data-claire-semantic="information"><p id="r-498006" data-claire-element-id="498006">Vous avez peut-être remarqué le doctype un peu inhabituel. Ce n'est pas une erreur (et ce n'est pas non plus parce que j'ai la flemme :p ). C'est le doctype qui a été adopté pour le HTML5 (il faut avouer que c'est quand même plus simple à mémoriser).</p></aside><p id="r-498008" data-claire-element-id="498008">Nous allons maintenant y placer notre canvas.</p><h5 id="r-canvas-1" data-claire-element-id="498019">Canvas</h5><div id="r-498011" data-claire-element-id="498011" data-claire-semantic="question"><p id="r-498010" data-claire-element-id="498010">C'est quoi un canvas ?</p></div><p id="r-498012" data-claire-element-id="498012">Le canvas est une des nombreuses nouvelles possibilités offertes par HTML5. Concrètement ça fait pas mal de temps qu'elle existe déjà (c'est Apple qui l'a inventée, au sein de son navigateur Safari). Le canvas offre la possibilité de dessiner (carrés, rectangles, droites, texte, ronds, images ...) via du code JavaScript.</p><p id="r-498013" data-claire-element-id="498013">Ajoutez donc la ligne suivante dans le body de votre page HTML :</p><pre id="r-498014" data-claire-element-id="498014"><code data-claire-semantic="html">&lt;canvas id=&quot;canvas&quot;&gt;Votre navigateur ne supporte pas HTML5, veuillez le mettre à jour pour jouer.&lt;/canvas&gt;</code></pre><p id="r-498015" data-claire-element-id="498015">La phrase &quot;Votre navigateur ne supporte pas HTML5, veuillez le mettre à jour pour jouer&quot; placée dans la balise n'apparaîtra que sur les navigateurs concernés. En effet : si vous mettez quoi que ce soit dans la balise canvas, ce sera ignoré par les navigateurs compatibles. En revanche, les navigateurs qui ne connaissent pas cette balise vont tout simplement l'ignorer... et donc afficher son contenu.</p><aside id="r-498017" data-claire-element-id="498017" data-claire-semantic="error"><p id="r-498016" data-claire-element-id="498016">Si votre navigateur ne supporte pas canvas, une simple mise à jour devrait régler le problème. En revanche, si vous possédez Internet Explorer, cela ne suffira pas (sauf à partir de la version 9). Nous allons étudier son cas dans la partie qui suit.</p></aside><p id="r-498018" data-claire-element-id="498018">Vous pouvez maintenant voir... Une page blanche. C'est pas beau la technologie ? C'est tout à fait normal étant donné que nous ne dessinons rien dans notre canvas pour le moment. Cependant, pour des raisons pratiques nous allons lui mettre un cadre.</p><h5 id="r-du-css-pour-une-meilleure-visibilite" data-claire-element-id="498024">Du CSS pour une meilleure visibilité</h5><p id="r-498020" data-claire-element-id="498020">Créez donc un fichier style.css dans le dossier css. Ensuite liez-le à votre page HTML en mettant la ligne suivante dans votre head (rien de complexe si vous maîtrisez HTML) :</p><pre id="r-498021" data-claire-element-id="498021"><code data-claire-semantic="html">&lt;link rel=&quot;stylesheet&quot; type=&quot;text/css&quot; href=&quot;css/style.css&quot; /&gt;</code></pre><p id="r-498022" data-claire-element-id="498022">Pour afficher des bordures au canvas, il suffit de faire comme ceci :</p><pre id="r-498023" data-claire-element-id="498023"><code data-claire-semantic="css">canvas {
	border: 1px solid black;
}</code></pre>
<aside class="aside-menu">
<ul class="content-menu" role="navigation">
<li class="tuto">
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas">Créer un mini-RPG en JavaScript avec canvas</a>
</li>
<li class="chapter">
 
<a class="chapterLink" onmouseover="$(this).addClass('box-shadow-summary').next().addClass('box-shadow-summary');" onmouseout="$(this).removeClass('box-shadow-summary').next().removeClass('box-shadow-summary');">
<span>Partie 1</span>
La carte
</a>
<a class="chapterOpen" href="#" onmouseover="$(this).addClass('box-shadow-summary').prev().addClass('box-shadow-summary');" onmouseout="$(this).removeClass('box-shadow-summary').prev().removeClass('box-shadow-summary');">
<span>+</span>
</a>
 
<ul class="subchapters">
<li class="subchapter">
<div>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/mise-en-place-des-bases">Mise en place des bases</a>
<a class="subchapterOpen" href="#">
<span>+</span>
</a>
</div>
<ul class="subchapter-parts">
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/structure-des-fichiers">
Structure des fichiers
</a>
</li>
<li class="active">
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/mise-en-place-du-canvas">
Mise en place du canvas
</a>
</li>
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/le-cas-d-internet-explorer">
Le cas d&#039;Internet Explorer
</a>
</li>
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/utilisation-de-l-objet-context">
Utilisation de l&#039;objet context
</a>
</li>
</ul> </li> <li class="subchapter">
<div>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/gestion-des-tilesets">Gestion des tilesets</a>
<a class="subchapterOpen" href="#">
<span>+</span>
</a>
</div>
<ul class="subchapter-parts">
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/presentation-132">
Présentation
</a>
</li>
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/decoupage-et-utilisation">
Découpage et utilisation
</a>
</li>
</ul> </li> <li class="subchapter">
<div>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/mise-en-place-du-terrain">Mise en place du terrain</a>
<a class="subchapterOpen" href="#">
<span>+</span>
</a>
</div>
<ul class="subchapter-parts">
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/format-de-stockage-des-donnees">
Format de stockage des données
</a>
</li>
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/chargement-et-affichage-du-terrain">
Chargement et affichage du terrain
</a>
</li>
</ul> </li></ul> </li>
<li class="chapter">
 
<a class="chapterLink" onmouseover="$(this).addClass('box-shadow-summary').next().addClass('box-shadow-summary');" onmouseout="$(this).removeClass('box-shadow-summary').next().removeClass('box-shadow-summary');">
<span>Partie 2</span>
Les personnages et les décors
</a>
<a class="chapterOpen" href="#" onmouseover="$(this).addClass('box-shadow-summary').prev().addClass('box-shadow-summary');" onmouseout="$(this).removeClass('box-shadow-summary').prev().removeClass('box-shadow-summary');">
<span>+</span>
</a>
 
<ul class="subchapters">
<li class="subchapter">
<div>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/les-personnages-1">Les personnages</a>
<a class="subchapterOpen" href="#">
<span>+</span>
</a>
</div>
<ul class="subchapter-parts">
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/choix-et-rendu-des-sprites">
Choix et rendu des sprites
</a>
</li>
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/clavier-et-boucle-principale">
Clavier et boucle principale
</a>
</li>
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/animation-des-deplacements">
Animation des déplacements
</a>
</li>
</ul>
</li>
</ul>
</li>
</li>
</ul>
</aside>
</div>
<div id="content-bottom-menu"></div>
<hr/>
<div class="paginate-tuto">
<a class="before" href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/structure-des-fichiers">
<span class="arrow"></span>
<span class="next">Structure des fichiers</span>
</a>
<a class="after" href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/le-cas-d-internet-explorer">
<span class="next">Le cas d&#039;Internet Explorer</span>
<span class="arrow"></span>
</a>
</div>
<hr class="bottom"/>
<div class="clear"></div> <div class="adBan">
<script type='text/javascript'>
    if (window.innerWidth >= 728)
    {
        document.write('<div id="div-gpt-ad-1350977194635-8" class="megaban"></div>');
        googletag.cmd.push(function() {
            googletag.display('div-gpt-ad-1350977194635-8');
        });
    }
            else
        {
            document.write('<div id="div-gpt-ad-1350977284180-8" class="miniban"></div>');
            googletag.cmd.push(function() {
                googletag.display('div-gpt-ad-1350977284180-8');
            });
        }
    </script>
</div>
<div class="clear"></div><a name="Lecasd039InternetExplorer"></a><h2>Le cas d&#039;Internet Explorer</h2><div class="paginate-tuto">
<a class="before" href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/mise-en-place-du-canvas">
<span class="arrow"></span>
<span class="next">Mise en place du canvas</span>
</a>
<a class="after" href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/utilisation-de-l-objet-context">
<span class="next">Utilisation de l&#039;objet context</span>
<span class="arrow"></span>
</a>
</div>
<hr class="top"/>
<div class="clear"></div> <div id="content" role="article">
<h4 id="r-le-cas-d-internet-explorer" data-claire-element-id="498046">Le cas d'Internet Explorer</h4><h5 id="r-quelle-s-solution-s-au-probleme" data-claire-element-id="498030">Quelle(s) solution(s) au problème ?</h5><p id="r-498026" data-claire-element-id="498026">Si vous n'utilisez pas Internet Explorer, ce chapitre ne vous concerne pas personnellement. Cependant, il faut penser à vos futurs joueurs qui seront adeptes de ce navigateur.</p><div id="r-498028" data-claire-element-id="498028" data-claire-semantic="question"><p id="r-498027" data-claire-element-id="498027">Mais comment allons-nous faire s'il ne connaît pas canvas ?</p></div><p id="r-498029" data-claire-element-id="498029">Pour cela, nous allons devoir utiliser une librairie externe qui se nomme <a href="http://code.google.com/p/explorercanvas/downloads/list">ExplorerCanvas</a>.</p><h5 id="r-mise-en-place-24" data-claire-element-id="498039">Mise en place</h5><p id="r-498031" data-claire-element-id="498031">Téléchargez la dernière version disponible sur le lien ci-dessus (à l'heure où j'écris ces lignes, le fichier se nomme excanvas_r3.zip) et dé-zippez le. Le fichier qui nous intéresse est excanvas.compiled.js.</p><div id="r-498033" data-claire-element-id="498033" data-claire-semantic="question"><p id="r-498032" data-claire-element-id="498032">À quoi sert le fichier excanvas.js ?</p></div><p id="r-498034" data-claire-element-id="498034">Le fichier excanvas.js est le code source de la librairie. L'autre aussi me direz vous, mais si vous ouvrez la version &quot;compiled&quot;, vous verrez que le code n'est pas très digeste.</p><p id="r-498035" data-claire-element-id="498035">Les créateurs d'ExplorerCanvas ont tout simplement utilisé un obfuscateur de code. C'est un outil qui permet d'alléger le code source en supprimant les caractères inutiles au navigateur (commentaires, indentations, sauts de lignes), et de renommer les variables plus simplement (si vous survolez le code, vous verrez qu'il y a plusieurs variables et fonctions qui se nomment a, b, c...). Ainsi le fichier est plus rapide à charger et les curieux auront beaucoup de mal à copier le code source (ce qui n'est pas très utile pour cette librairie vu qu'elle est open source).</p><p id="r-498036" data-claire-element-id="498036">Mettez le fichier excanvas.compiled.js dans le dossier js de notre jeu. Ensuite, ajoutez cette ligne dans le head de la page html :</p><pre id="r-498037" data-claire-element-id="498037"><code data-claire-semantic="html">&lt;!--[if lt IE 9]&gt;&lt;script type=&quot;text/javascript&quot; src=&quot;js/excanvas.compiled.js&quot;&gt;&lt;/script&gt;&lt;![endif]--&gt;</code></pre><p id="r-498038" data-claire-element-id="498038">Et voilà, maintenant ça fonctionne dans tous les navigateurs !</p><h5 id="r-explications-39" data-claire-element-id="498045">Explications</h5><div id="r-498041" data-claire-element-id="498041" data-claire-semantic="question"><p id="r-498040" data-claire-element-id="498040">Mais comment les créateurs de cette librairie ont-ils fait pour dessiner des ronds, des carrés et des lignes ?</p></div><p id="r-498042" data-claire-element-id="498042">Internet Explorer implémente la technologie <a href="http://fr.wikipedia.org/wiki/Vector_Markup_Language">VML</a> (Vector Markup Language) qui permet faire des choses semblables à canvas. Je ne sais pas vous donner plus de détails, mais je sais que les créateurs d'ExCanvas l'ont utilisée.</p><aside id="r-498044" data-claire-element-id="498044" data-claire-semantic="information"><p id="r-498043" data-claire-element-id="498043">Sachez qu'il existe également d'autres librairies qui font le même travail qu'ExCanvas, mais c'est la seule que je connaisse qui ne fasse pas appel à Flash.</p></aside>
<aside class="aside-menu">
<ul class="content-menu" role="navigation">
<li class="tuto">
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas">Créer un mini-RPG en JavaScript avec canvas</a>
</li>
<li class="chapter">
 
<a class="chapterLink" onmouseover="$(this).addClass('box-shadow-summary').next().addClass('box-shadow-summary');" onmouseout="$(this).removeClass('box-shadow-summary').next().removeClass('box-shadow-summary');">
<span>Partie 1</span>
La carte
</a>
<a class="chapterOpen" href="#" onmouseover="$(this).addClass('box-shadow-summary').prev().addClass('box-shadow-summary');" onmouseout="$(this).removeClass('box-shadow-summary').prev().removeClass('box-shadow-summary');">
<span>+</span>
</a>
 
<ul class="subchapters">
<li class="subchapter">
<div>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/mise-en-place-des-bases">Mise en place des bases</a>
<a class="subchapterOpen" href="#">
<span>+</span>
</a>
</div>
<ul class="subchapter-parts">
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/structure-des-fichiers">
Structure des fichiers
</a>
</li>
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/mise-en-place-du-canvas">
Mise en place du canvas
</a>
</li>
<li class="active">
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/le-cas-d-internet-explorer">
Le cas d&#039;Internet Explorer
</a>
</li>
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/utilisation-de-l-objet-context">
Utilisation de l&#039;objet context
</a>
</li>
</ul> </li> <li class="subchapter">
<div>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/gestion-des-tilesets">Gestion des tilesets</a>
<a class="subchapterOpen" href="#">
<span>+</span>
</a>
</div>
<ul class="subchapter-parts">
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/presentation-132">
Présentation
</a>
</li>
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/decoupage-et-utilisation">
Découpage et utilisation
</a>
</li>
</ul> </li> <li class="subchapter">
<div>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/mise-en-place-du-terrain">Mise en place du terrain</a>
<a class="subchapterOpen" href="#">
<span>+</span>
</a>
</div>
<ul class="subchapter-parts">
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/format-de-stockage-des-donnees">
Format de stockage des données
</a>
</li>
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/chargement-et-affichage-du-terrain">
Chargement et affichage du terrain
</a>
</li>
</ul> </li></ul> </li>
<li class="chapter">
 
<a class="chapterLink" onmouseover="$(this).addClass('box-shadow-summary').next().addClass('box-shadow-summary');" onmouseout="$(this).removeClass('box-shadow-summary').next().removeClass('box-shadow-summary');">
<span>Partie 2</span>
Les personnages et les décors
</a>
<a class="chapterOpen" href="#" onmouseover="$(this).addClass('box-shadow-summary').prev().addClass('box-shadow-summary');" onmouseout="$(this).removeClass('box-shadow-summary').prev().removeClass('box-shadow-summary');">
<span>+</span>
</a>
 
<ul class="subchapters">
<li class="subchapter">
<div>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/les-personnages-1">Les personnages</a>
<a class="subchapterOpen" href="#">
<span>+</span>
</a>
</div>
<ul class="subchapter-parts">
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/choix-et-rendu-des-sprites">
Choix et rendu des sprites
</a>
</li>
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/clavier-et-boucle-principale">
Clavier et boucle principale
</a>
</li>
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/animation-des-deplacements">
Animation des déplacements
</a>
</li>
</ul>
</li>
</ul>
</li>
</li>
</ul>
</aside>
</div>
<div id="content-bottom-menu"></div>
<hr/>
<div class="paginate-tuto">
<a class="before" href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/mise-en-place-du-canvas">
<span class="arrow"></span>
<span class="next">Mise en place du canvas</span>
</a>
<a class="after" href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/utilisation-de-l-objet-context">
<span class="next">Utilisation de l&#039;objet context</span>
<span class="arrow"></span>
</a>
</div>
<hr class="bottom"/>
<div class="clear"></div> <div class="adBan">
<script type='text/javascript'>
    if (window.innerWidth >= 728)
    {
        document.write('<div id="div-gpt-ad-1350977194635-8" class="megaban"></div>');
        googletag.cmd.push(function() {
            googletag.display('div-gpt-ad-1350977194635-8');
        });
    }
            else
        {
            document.write('<div id="div-gpt-ad-1350977284180-8" class="miniban"></div>');
            googletag.cmd.push(function() {
                googletag.display('div-gpt-ad-1350977284180-8');
            });
        }
    </script>
</div>
<div class="clear"></div><a name="Utilisationdel039objetcontext"></a><h2>Utilisation de l&#039;objet context</h2><div class="paginate-tuto">
<a class="before" href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/le-cas-d-internet-explorer">
<span class="arrow"></span>
<span class="next">Le cas d&#039;Internet Explorer</span>
</a>
<a class="after" href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/gestion-des-tilesets">
<span class="next">Gestion des tilesets</span>
<span class="arrow"></span>
</a>
</div>
<hr class="top"/>
<div class="clear"></div> <div id="content" role="article">
<h4 id="r-utilisation-de-l-objet-context" data-claire-element-id="498115">Utilisation de l'objet context</h4><h5 id="r-quelques-bases-1" data-claire-element-id="498055">Quelques bases</h5><p id="r-498047" data-claire-element-id="498047">Dans cette partie, je vais vous présenter un peu les possibilités de canvas. Nous n'attaquerons pas le jeu lui-même, c'est plutôt pour vous apprendre à vous familiariser avec l'objet &quot;contexte&quot;.</p><p id="r-498048" data-claire-element-id="498048">Créez un fichier rpg.js (si vous trouvez un nom plus original n'hésitez pas :-° ) à la racine du dossier js, et liez-le à votre page html (dans le head).</p><p id="r-498049" data-claire-element-id="498049">Ensuite placez-y le code suivant :</p><pre id="r-498050" data-claire-element-id="498050"><code data-claire-semantic="javascript">window.onload = function() {
	var canvas = document.getElementById('canvas');
	var ctx = canvas.getContext('2d');
	
	ctx.fillStyle = 'blue';
	ctx.fillRect(10, 10, 100, 50);
	
	ctx.strokeStyle = 'red';
	ctx.strokeRect(75, 75, 50, 50);
}</code></pre><p id="r-498051" data-claire-element-id="498051">Si tout va bien vous devriez obtenir ceci :</p><figure id="r-498053" data-claire-element-id="498054"><img id="r-498052" data-claire-element-id="498052" src="medias/uploads.siteduzero.com_files_298001_299000_298834.png" alt="Résultat de notre bout de code"/></figure><h5 id="r-explications-sur-le-code-1" data-claire-element-id="498074">Explications sur le code</h5><p id="r-498056" data-claire-element-id="498056">La première ligne n'a rien de difficile, elle nous permet de faire en sorte que notre code JavaScript ne soit exécuté qu'une fois la page chargée complètement. Ensuite nous récupérons l'élément DOM de notre canvas. Rien de nouveau non plus.</p><p id="r-498057" data-claire-element-id="498057">La ligne suivante est plus intéressante :</p><pre id="r-498058" data-claire-element-id="498058"><code data-claire-semantic="javascript">var ctx = canvas.getContext('2d');</code></pre><p id="r-498059" data-claire-element-id="498059">Elle nous permet de récupérer notre objet &quot;context&quot; (son nom est <a href="https://developer.mozilla.org/en/DOM/CanvasRenderingContext2D">CanvasRenderingContext2D</a> pour être plus précis).</p><div id="r-498061" data-claire-element-id="498061" data-claire-semantic="question"><p id="r-498060" data-claire-element-id="498060">Pourquoi on passe '2d' en paramètres ?</p></div><p id="r-498062" data-claire-element-id="498062">Le canvas est prévu pour être capable de faire bien plus que de la 2D. Le canvas permet déjà (sous les navigateurs Firefox 4 et Google Chrome 9) d'utiliser la technologie WebGL. Le webGL est une implémentation d'OpenGL pour JavaScript. Lorsque tous les navigateurs seront compatibles, vous pourrez donc voir fleurir des jeux 3D en JavaScript sans souci ni problèmes de performances puisque WebGL utilise l'accélération 3D.</p><aside id="r-498064" data-claire-element-id="498064" data-claire-semantic="information"><p id="r-498063" data-claire-element-id="498063">Si vous souhaitez en savoir plus, je vous conseille d'aller voir du côté de <a href="http://www.c3dl.org/">c3dl</a>.</p></aside><p id="r-498065" data-claire-element-id="498065">Avant de continuer, je dois quand même préciser que le système de coordonnées de canvas (et de la grande majorité des langages de programmation) ne fonctionne pas dans le même sens qu'en mathématiques. Les axes fonctionnent dans ce sens :</p><figure id="r-498067" data-claire-element-id="498068"><img id="r-498066" data-claire-element-id="498066" src="medias/uploads.siteduzero.com_files_300001_301000_300709.png" alt="Coordonnées"/></figure><p id="r-498069" data-claire-element-id="498069">Maintenant étudions la partie la plus intéressante du code :</p><pre id="r-498070" data-claire-element-id="498070"><code data-claire-semantic="javascript">ctx.fillStyle = 'blue';
ctx.fillRect(10, 10, 100, 50);
	
ctx.strokeStyle = 'red';
ctx.strokeRect(75, 75, 50, 50);</code></pre><p id="r-498071" data-claire-element-id="498071">Dans l'objet context, nous avons beaucoup de méthodes et d'attributs qui portent un nom commençant par 'fill' ou 'stroke'. Les méthodes en fill remplissent la forme que vous dessinez avec la couleur précisée dans l'attribut fillStyle. Les méthodes en stroke dessinent uniquement les contours des formes avec la couleur définie via strokeStyle.</p><aside id="r-498073" data-claire-element-id="498073" data-claire-semantic="information"><p id="r-498072" data-claire-element-id="498072">Je ne détaillerai pas toutes les méthodes du context dans ce cours. Vous pouvez avoir plus de détails sur les méthodes du Context2D sur <a href="http://www.whatwg.org/specs/web-apps/current-work/#2dcontext">la page des spécifications officielles de HTML5</a> (en Anglais, attention la page est très lourde).</p></aside><h5 id="r-traitement-des-images" data-claire-element-id="498114">Traitement des images</h5><p id="r-498075" data-claire-element-id="498075">Ces méthodes de dessin sont bien sympathiques, mais elles nous seront peu utiles pour notre RPG. Le dessin d'images par contre est très utile. Les méthodes de dessin du context nous permettent :</p><ul id="r-498082" data-claire-element-id="498082"><li id="r-498077" data-claire-element-id="498077"><p id="r-498076" data-claire-element-id="498076">De simplement dessiner une image</p></li><li id="r-498079" data-claire-element-id="498079"><p id="r-498078" data-claire-element-id="498078">De dessiner une image avec une taille différente</p></li><li id="r-498081" data-claire-element-id="498081"><p id="r-498080" data-claire-element-id="498080">De dessiner une partie d'une image</p></li></ul><p id="r-498083" data-claire-element-id="498083">Ajoutez donc le code suivant à votre page pour voir concrètement ce que ça donne :</p><pre id="r-498084" data-claire-element-id="498084"><code data-claire-semantic="javascript">ctx.drawImage(smiley, 200, 10);
	
ctx.drawImage(smiley, 200, 30, 100, 50); 
ctx.drawImage(smiley, 0, 0, 10, 19, 200, 100, 10, 19);</code></pre><p id="r-498085" data-claire-element-id="498085">Ainsi que celui-ci tout en haut du fichier (en dehors de tout bloc) :</p><pre id="r-498086" data-claire-element-id="498086"><code data-claire-semantic="javascript">var smiley = new Image();
smiley.src = &quot;http://www.siteduzero.com/Templates/images/smilies/heureux.png&quot;;</code></pre><p id="r-498087" data-claire-element-id="498087">Nous obtenons ceci :</p><figure id="r-498089" data-claire-element-id="498090"><img id="r-498088" data-claire-element-id="498088" src="medias/uploads.siteduzero.com_files_298001_299000_298840.png" alt="Résultat de l'utilisation des méthodes de dessin d'image du context"/></figure><aside id="r-498092" data-claire-element-id="498092" data-claire-semantic="warning"><p id="r-498091" data-claire-element-id="498091">En fonction de votre navigateur, il se peut que le smiley ne s'affiche pas. Si c'est le cas, téléchargez et enregistrez l'image du smiley dans votre application, et mettez un chemin relatif dans le code.</p></aside><p id="r-498093" data-claire-element-id="498093">Dans la documentation, on peut voir qu'il y a surcharge de la méthode drawImage, ce qui nous donne trois possibilités :</p><pre id="r-498094" data-claire-element-id="498094"><code data-claire-semantic="javascript">drawImage(image, dx, dy) 
drawImage(image, dx, dy, dw, dh) 
drawImage(image, sx, sy, sw, sh, dx, dy, dw, dh)</code></pre><p id="r-498095" data-claire-element-id="498095">Plus de détails sur les noms des paramètres :</p><ul id="r-498108" data-claire-element-id="498108"><li id="r-498097" data-claire-element-id="498097"><p id="r-498096" data-claire-element-id="498096">d : Destination</p></li><li id="r-498099" data-claire-element-id="498099"><p id="r-498098" data-claire-element-id="498098">s : Source</p></li><li id="r-498101" data-claire-element-id="498101"><p id="r-498100" data-claire-element-id="498100">x : Coordonnée X</p></li><li id="r-498103" data-claire-element-id="498103"><p id="r-498102" data-claire-element-id="498102">Coordonnée Y</p></li><li id="r-498105" data-claire-element-id="498105"><p id="r-498104" data-claire-element-id="498104">w : Largeur</p></li><li id="r-498107" data-claire-element-id="498107"><p id="r-498106" data-claire-element-id="498106">h : Hauteur</p></li></ul><p id="r-498109" data-claire-element-id="498109">La première se contente de dessiner l'image sans la modifier à partir des coordonnées du point en haut à gauche passé en paramètre. Dans la seconde, l'image est dessinée en fonction de la taille (dw et dh) passée en paramètre. Et dans la troisième, on précise une partie de l'image source que l'on souhaite (en précisant les coordonnées x et y, ainsi que la largeur et la hauteur du &quot;rectangle&quot; que l'on sélectionne. On précise la même chose pour la destination.</p><aside id="r-498111" data-claire-element-id="498111" data-claire-semantic="information"><p id="r-498110" data-claire-element-id="498110">Vous pouvez préciser des hauteurs et largeurs de destination négatives, ce qui aura pour effet d'appliquer un &quot;effet miroir&quot; à votre image (elle sera inversée).</p></aside><p id="r-498112" data-claire-element-id="498112">Dans cette partie, nous n'avons pas encore réellement commencé le RPG.</p><p id="r-498113" data-claire-element-id="498113">Néanmoins, poser les bases était nécessaire. Le canvas est primordial pour notre RPG. N'hésitez donc pas à vous entraîner pour bien le maîtriser, ainsi que les méthodes du context avant de poursuivre ce cours.</p>
<aside class="aside-menu">
<ul class="content-menu" role="navigation">
<li class="tuto">
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas">Créer un mini-RPG en JavaScript avec canvas</a>
</li>
<li class="chapter">
 
<a class="chapterLink" onmouseover="$(this).addClass('box-shadow-summary').next().addClass('box-shadow-summary');" onmouseout="$(this).removeClass('box-shadow-summary').next().removeClass('box-shadow-summary');">
<span>Partie 1</span>
La carte
</a>
<a class="chapterOpen" href="#" onmouseover="$(this).addClass('box-shadow-summary').prev().addClass('box-shadow-summary');" onmouseout="$(this).removeClass('box-shadow-summary').prev().removeClass('box-shadow-summary');">
<span>+</span>
</a>
 
<ul class="subchapters">
<li class="subchapter">
<div>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/mise-en-place-des-bases">Mise en place des bases</a>
<a class="subchapterOpen" href="#">
<span>+</span>
</a>
</div>
<ul class="subchapter-parts">
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/structure-des-fichiers">
Structure des fichiers
</a>
</li>
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/mise-en-place-du-canvas">
Mise en place du canvas
</a>
</li>
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/le-cas-d-internet-explorer">
Le cas d&#039;Internet Explorer
</a>
</li>
<li class="active">
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/utilisation-de-l-objet-context">
Utilisation de l&#039;objet context
</a>
</li>
</ul> </li> <li class="subchapter">
<div>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/gestion-des-tilesets">Gestion des tilesets</a>
<a class="subchapterOpen" href="#">
<span>+</span>
</a>
</div>
<ul class="subchapter-parts">
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/presentation-132">
Présentation
</a>
</li>
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/decoupage-et-utilisation">
Découpage et utilisation
</a>
</li>
</ul> </li> <li class="subchapter">
<div>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/mise-en-place-du-terrain">Mise en place du terrain</a>
<a class="subchapterOpen" href="#">
<span>+</span>
</a>
</div>
<ul class="subchapter-parts">
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/format-de-stockage-des-donnees">
Format de stockage des données
</a>
</li>
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/chargement-et-affichage-du-terrain">
Chargement et affichage du terrain
</a>
</li>
</ul> </li></ul> </li>
<li class="chapter">
 
<a class="chapterLink" onmouseover="$(this).addClass('box-shadow-summary').next().addClass('box-shadow-summary');" onmouseout="$(this).removeClass('box-shadow-summary').next().removeClass('box-shadow-summary');">
<span>Partie 2</span>
Les personnages et les décors
</a>
<a class="chapterOpen" href="#" onmouseover="$(this).addClass('box-shadow-summary').prev().addClass('box-shadow-summary');" onmouseout="$(this).removeClass('box-shadow-summary').prev().removeClass('box-shadow-summary');">
<span>+</span>
</a>
 
<ul class="subchapters">
<li class="subchapter">
<div>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/les-personnages-1">Les personnages</a>
<a class="subchapterOpen" href="#">
<span>+</span>
</a>
</div>
<ul class="subchapter-parts">
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/choix-et-rendu-des-sprites">
Choix et rendu des sprites
</a>
</li>
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/clavier-et-boucle-principale">
Clavier et boucle principale
</a>
</li>
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/animation-des-deplacements">
Animation des déplacements
</a>
</li>
</ul>
</li>
</ul>
</li>
</li>
</ul>
</aside>
</div>
<div id="content-bottom-menu"></div>
<hr/>
<div class="paginate-tuto">
<a class="before" href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/le-cas-d-internet-explorer">
<span class="arrow"></span>
<span class="next">Le cas d&#039;Internet Explorer</span>
</a>
<a class="after" href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/gestion-des-tilesets">
<span class="next">Gestion des tilesets</span>
<span class="arrow"></span>
</a>
</div>
<hr class="bottom"/>
<div class="clear"></div> <div class="adBan">
<script type='text/javascript'>
    if (window.innerWidth >= 728)
    {
        document.write('<div id="div-gpt-ad-1350977194635-8" class="megaban"></div>');
        googletag.cmd.push(function() {
            googletag.display('div-gpt-ad-1350977194635-8');
        });
    }
            else
        {
            document.write('<div id="div-gpt-ad-1350977284180-8" class="miniban"></div>');
            googletag.cmd.push(function() {
                googletag.display('div-gpt-ad-1350977284180-8');
            });
        }
    </script>
</div>
<div class="clear"></div><a name="Gestiondestilesets"></a><h2>Gestion des tilesets</h2><div class="paginate-tuto">
<a class="before" href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/utilisation-de-l-objet-context">
<span class="arrow"></span>
<span class="next">Utilisation de l&#039;objet context</span>
</a>
<a class="after" href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/presentation-132">
<span class="next">Présentation</span>
<span class="arrow"></span>
</a>
</div>
<hr class="top"/>
<div class="clear"></div> <div class="content">
<p id="r-498117" data-claire-element-id="498117">Dans cette partie, nous allons voir ce qu'est un tileset, à quoi ca sert et comment l'utiliser dans notre RPG.</p>
</div><a name="Prsentation"></a><h2>Présentation</h2><div class="paginate-tuto">
<a class="before" href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/gestion-des-tilesets">
<span class="arrow"></span>
<span class="next">Gestion des tilesets</span>
</a>
<a class="after" href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/decoupage-et-utilisation">
<span class="next">Découpage et utilisation</span>
<span class="arrow"></span>
</a>
</div>
<hr class="top"/>
<div class="clear"></div> <div id="content" role="article">
<h4 id="r-presentation-132" data-claire-element-id="498138">Présentation</h4><h5 id="r-un-tileset-c-est-quoi" data-claire-element-id="498121">Un tileset, c'est quoi ?</h5><p id="r-498118" data-claire-element-id="498118">Dans un RPG, une carte (map) est constituée de cases que l'on nomme généralement tiles (tuiles en français). C'est en plaçant plusieurs tiles les uns à côté des autres que l'on va générer notre monde.</p><p id="r-498119" data-claire-element-id="498119">Chaque tile est une image carrée. On utilise généralement une taille de 32 x 32 pixels.<br/> Dans ce tuto, c'est également la taille que j'utiliserai car vous pourrez trouver une énorme quantité de ressources graphiques libres sur internet basées sur ce modèle (pour ceux qui connaissent RPG Maker, sachez que c'est le même format).</p><p id="r-498120" data-claire-element-id="498120">Si vous avez une carte très basique avec une étendue d'herbe et un chemin qui la traverse, vous aurez globalement deux tiles différents : un avec une texture d'herbe et un avec une texture de chemin. Dans la pratique c'est un peu plus compliqué. On utilisera généralement une dizaine de tiles afin de gérer les bordures du chemin (sinon il sera totalement carré, ce qui n'est pas très beau).</p><h5 id="r-pourquoi-un-tel-systeme" data-claire-element-id="498137">Pourquoi un tel système ?</h5><p id="r-498122" data-claire-element-id="498122">La première chose qui nous vient à l'esprit quand on a pas l'expérience du développement de jeux en 2D est de tout simplement avoir un fichier image de 32 x 32 pixels par tile.</p><aside id="r-498124" data-claire-element-id="498124" data-claire-semantic="error"><p id="r-498123" data-claire-element-id="498123">Cette méthode présente un inconvénient non négligeable en terme de performances. Imaginez que vous ayez une très grande carte sur laquelle vous avez une centaine de tiles différents. Cela veut dire que vous allez devoir charger une centaine d'images, et donc - si votre jeu est sur un serveur web - une centaine de requêtes HTTP.</p></aside><p id="r-498125" data-claire-element-id="498125">L'objectif du tileset est de combiner plusieurs tiles sur une seule image. Ainsi, même si cela n'a pas d'impact en terme de taille, ça en aura en performances car il n'y aura qu'une seule image à charger.</p><p id="r-498126" data-claire-element-id="498126">Pour cette partie, nous allons utiliser un tileset très simple qui est celui-ci :</p><figure id="r-498128" data-claire-element-id="498129"><img id="r-498127" data-claire-element-id="498127" src="medias/uploads.siteduzero.com_files_299001_300000_299126.png" alt="Tileset de base"/></figure><aside id="r-498131" data-claire-element-id="498131" data-claire-semantic="information"><p id="r-498130" data-claire-element-id="498130">Ce tileset est gratuit mais tout de même soumis à une licence. Aussi, je vous informe que je l'ai pris <a href="../../opengameart.org/sites/default/files/styles/watermarked/public/grass-tiles-2-small.png">ici</a> et qu'il a été créé par des personnes nommées &quot;qubodup&quot;, &quot;Bart K.&quot; et &quot;Blarumyrran&quot;.</p></aside><p id="r-498132" data-claire-element-id="498132">Vous comprenez mieux ce qu'est un tileset à présent ?</p><div id="r-498134" data-claire-element-id="498134" data-claire-semantic="question"><p id="r-498133" data-claire-element-id="498133">Mais comment allons-nous l'utiliser dans notre jeu puisqu'il n'est pas découpé ?</p></div><p id="r-498135" data-claire-element-id="498135">Vous vous souvenez de la méthode drawImage de l'objet context vu dans la partie précédente ? Nous avons vu qu'elle pouvait nous permettre de ne dessiner qu'une partie de l'image en sélectionnant un &quot;rectangle&quot; source par ses coordonnées (x, y) et par sa taille.</p><p id="r-498136" data-claire-element-id="498136">C'est ce que nous allons maintenant étudier.</p>
<aside class="aside-menu">
<ul class="content-menu" role="navigation">
<li class="tuto">
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas">Créer un mini-RPG en JavaScript avec canvas</a>
</li>
<li class="chapter">
 
<a class="chapterLink" onmouseover="$(this).addClass('box-shadow-summary').next().addClass('box-shadow-summary');" onmouseout="$(this).removeClass('box-shadow-summary').next().removeClass('box-shadow-summary');">
<span>Partie 1</span>
La carte
</a>
<a class="chapterOpen" href="#" onmouseover="$(this).addClass('box-shadow-summary').prev().addClass('box-shadow-summary');" onmouseout="$(this).removeClass('box-shadow-summary').prev().removeClass('box-shadow-summary');">
<span>+</span>
</a>
 
<ul class="subchapters">
<li class="subchapter">
<div>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/mise-en-place-des-bases">Mise en place des bases</a>
<a class="subchapterOpen" href="#">
<span>+</span>
</a>
</div>
<ul class="subchapter-parts">
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/structure-des-fichiers">
Structure des fichiers
</a>
</li>
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/mise-en-place-du-canvas">
Mise en place du canvas
</a>
</li>
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/le-cas-d-internet-explorer">
Le cas d&#039;Internet Explorer
</a>
</li>
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/utilisation-de-l-objet-context">
Utilisation de l&#039;objet context
</a>
</li>
</ul> </li> <li class="subchapter">
<div>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/gestion-des-tilesets">Gestion des tilesets</a>
<a class="subchapterOpen" href="#">
<span>+</span>
</a>
</div>
<ul class="subchapter-parts">
<li class="active">
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/presentation-132">
Présentation
</a>
</li>
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/decoupage-et-utilisation">
Découpage et utilisation
</a>
</li>
</ul> </li> <li class="subchapter">
<div>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/mise-en-place-du-terrain">Mise en place du terrain</a>
<a class="subchapterOpen" href="#">
<span>+</span>
</a>
</div>
<ul class="subchapter-parts">
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/format-de-stockage-des-donnees">
Format de stockage des données
</a>
</li>
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/chargement-et-affichage-du-terrain">
Chargement et affichage du terrain
</a>
</li>
</ul> </li></ul> </li>
<li class="chapter">
 
<a class="chapterLink" onmouseover="$(this).addClass('box-shadow-summary').next().addClass('box-shadow-summary');" onmouseout="$(this).removeClass('box-shadow-summary').next().removeClass('box-shadow-summary');">
<span>Partie 2</span>
Les personnages et les décors
</a>
<a class="chapterOpen" href="#" onmouseover="$(this).addClass('box-shadow-summary').prev().addClass('box-shadow-summary');" onmouseout="$(this).removeClass('box-shadow-summary').prev().removeClass('box-shadow-summary');">
<span>+</span>
</a>
 
<ul class="subchapters">
<li class="subchapter">
<div>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/les-personnages-1">Les personnages</a>
<a class="subchapterOpen" href="#">
<span>+</span>
</a>
</div>
<ul class="subchapter-parts">
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/choix-et-rendu-des-sprites">
Choix et rendu des sprites
</a>
</li>
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/clavier-et-boucle-principale">
Clavier et boucle principale
</a>
</li>
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/animation-des-deplacements">
Animation des déplacements
</a>
</li>
</ul>
</li>
</ul>
</li>
</li>
</ul>
</aside>
</div>
<div id="content-bottom-menu"></div>
<hr/>
<div class="paginate-tuto">
<a class="before" href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/gestion-des-tilesets">
<span class="arrow"></span>
<span class="next">Gestion des tilesets</span>
</a>
<a class="after" href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/decoupage-et-utilisation">
<span class="next">Découpage et utilisation</span>
<span class="arrow"></span>
</a>
</div>
<hr class="bottom"/>
<div class="clear"></div> <div class="adBan">
<script type='text/javascript'>
    if (window.innerWidth >= 728)
    {
        document.write('<div id="div-gpt-ad-1350977194635-8" class="megaban"></div>');
        googletag.cmd.push(function() {
            googletag.display('div-gpt-ad-1350977194635-8');
        });
    }
            else
        {
            document.write('<div id="div-gpt-ad-1350977284180-8" class="miniban"></div>');
            googletag.cmd.push(function() {
                googletag.display('div-gpt-ad-1350977284180-8');
            });
        }
    </script>
</div>
<div class="clear"></div><a name="Dcoupageetutilisation"></a><h2>Découpage et utilisation</h2><div class="paginate-tuto">
<a class="before" href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/presentation-132">
<span class="arrow"></span>
<span class="next">Présentation</span>
</a>
<a class="after" href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/mise-en-place-du-terrain">
<span class="next">Mise en place du terrain</span>
<span class="arrow"></span>
</a>
</div>
<hr class="top"/>
<div class="clear"></div> <div id="content" role="article">
<h4 id="r-decoupage-et-utilisation" data-claire-element-id="498266">Découpage et utilisation</h4><h5 id="r-structure-de-la-classe" data-claire-element-id="498146">Structure de la classe</h5><p id="r-498139" data-claire-element-id="498139">Avant de commencer le codage du côté des tilesets, nous allons-nous mettre d'accord sur la manière de les appeler. Comment allons nous choisir de dessiner tel ou tel tile ? Plusieurs solutions se présentent à nous. La première qui nous vient à l'esprit (et qui est la plus facile à calculer) est de les appeler par des coordonnées (x, y), x et y étant non pas des pixels mais des tiles.</p><p id="r-498140" data-claire-element-id="498140">Ce n'est pas la convention de numérotation que j'ai choisie. J'ai choisi de n'utiliser qu'un seul entier. Ce sera moins simple à calculer, mais ça nous simplifiera la vie plus tard. Voici la manière dont ce sera numéroté pour notre tileset :</p><figure id="r-498142" data-claire-element-id="498143"><img id="r-498141" data-claire-element-id="498141" src="medias/uploads.siteduzero.com_files_299001_300000_299141.png" alt="Tileset de base numéroté"/></figure><p id="r-498144" data-claire-element-id="498144">Bien. Maintenant commençons un peu à coder.</p><p id="r-498145" data-claire-element-id="498145">Premièrement, enregistrez <a href="medias/uploads.siteduzero.com_files_299001_300000_299141.png">l'image de tileset</a> dans le répertoire &quot;tilesets&quot; que nous avons créé dans la première partie. Je l'ai nommée &quot;basique.png&quot;. Si vous choisissez un nom différent, pensez bien à reporter vos modifications dans le code.</p><h5 id="r-programme-de-test-1" data-claire-element-id="498163">Programme de test</h5><p id="r-498147" data-claire-element-id="498147">Reprenez le fichier rpg.js et faites un peu de ménage (si vous avez fait des tests que vous souhaitez garder, n'oubliez pas de les sauvegarder dans un coin) :</p><pre id="r-498148" data-claire-element-id="498148"><code data-claire-semantic="javascript">window.onload = function() {
	var canvas = document.getElementById('canvas');
	var ctx = canvas.getContext('2d');

	// Nous allons insérer nos tests ici
}</code></pre><p id="r-498149" data-claire-element-id="498149">Pour gérer nos tilesets, nous allons utiliser une classe. Nous aurons besoin des méthodes suivantes :</p><ul id="r-498154" data-claire-element-id="498154"><li id="r-498151" data-claire-element-id="498151"><p id="r-498150" data-claire-element-id="498150">Constructeur(String)</p></li><li id="r-498153" data-claire-element-id="498153"><p id="r-498152" data-claire-element-id="498152">dessinerTile(int, Context, int, int)</p></li></ul><p id="r-498155" data-claire-element-id="498155">Le constructeur prendra en paramètres le nom de l'image contenant le tileset.<br/> La méthode dessinerTile nous permettra de facilement dessiner un tile (dont le numéro est passé en premier paramètre) sur un context passé en second paramètre, aux coordonnées x et y (troisième et quatrième paramètre).</p><p id="r-498156" data-claire-element-id="498156">Maintenant que nous avons défini notre classe, nous allons mettre en place nos tests, comme ça ce sera fait. Remplacez le commentaire que j'ai laissé à cet effet dans rpg.js par le code suivant :</p><pre id="r-498157" data-claire-element-id="498157"><code data-claire-semantic="javascript">ts.dessinerTile(1, ctx, 10, 10);
ts.dessinerTile(5, ctx, 50, 10);
ts.dessinerTile(6, ctx, 90, 10);
ts.dessinerTile(7, ctx, 130, 10);</code></pre><p id="r-498158" data-claire-element-id="498158">Et ajoutez la ligne suivante tout en haut (en dehors de la fonction) :</p><pre id="r-498159" data-claire-element-id="498159"><code data-claire-semantic="javascript">var ts = new Tileset(&quot;basique.png&quot;);</code></pre><aside id="r-498161" data-claire-element-id="498161" data-claire-semantic="information"><p id="r-498160" data-claire-element-id="498160">Nous créons une instance de tileset en dehors de la fonction window.onload. Ainsi, le navigateur commencera à charger l'image en même temps que le reste de la page. La fonction définie via window.onload ne sera donc appelée qu'une fois l'image totalement chargée (et donc prête à être dessinée).</p></aside><p id="r-498162" data-claire-element-id="498162">Vous l'aurez sans doute compris, notre test va dessiner côte à côte les tiles numéros 1, 5, 6 et 7. Ce jeu d'essai teste principalement les &quot;coins&quot; du tileset, car c'est souvent les coins qui posent problème.</p><h5 id="r-creation-de-notre-classe-1" data-claire-element-id="498169">Création de notre classe</h5><p id="r-498164" data-claire-element-id="498164">Nous allons maintenant passer au codage de notre classe. Créez donc un fichier Tileset.js dans le dossier js/classes, et liez-le à votre fichier HTML :</p><pre id="r-498165" data-claire-element-id="498165"><code data-claire-semantic="html">&lt;script type=&quot;text/javascript&quot; src=&quot;js/classes/Tileset.js&quot;&gt;&lt;/script&gt;</code></pre><p id="r-498166" data-claire-element-id="498166">Nous pouvons dès lors poser les bases de notre classe sans trop de difficulté :</p><pre id="r-498167" data-claire-element-id="498167"><code data-claire-semantic="javascript">function Tileset(url) {
	// Chargement de l'image dans l'attribut image
	this.image = new Image();
	this.image.referenceDuTileset = this;
	this.image.onload = function() {
		if(!this.complete) 
			throw new Error(&quot;Erreur de chargement du tileset nommé \&quot;&quot; + url + &quot;\&quot;.&quot;);
	}
	this.image.src = &quot;tilesets/&quot; + url;
}

// Méthode de dessin du tile numéro &quot;numero&quot; dans le contexte 2D &quot;context&quot; aux coordonnées x et y
Tileset.prototype.dessinerTile = function(numero, context, xDestination, yDestination) {
	
}</code></pre><p id="r-498168" data-claire-element-id="498168">Dans le constructeur, vous voyez qu'on ajoute un attribut spécial à notre objet image afin qu'il sache à quel objet Tileset il appartient. Ainsi, nous pourrons terminer le constructeur de notre Tileset de manière asynchrone, c'est à dire quand l'image sera chargée.</p><h5 id="r-dessin-d-un-tile" data-claire-element-id="498265">Dessin d'un tile</h5><p id="r-498170" data-claire-element-id="498170">Ici, le constructeur n'est pas terminé. Pour pouvoir déterminer les coordonnées (x, y) d'un tile précis dans le tileset à partir de son numéro, nous allons avoir besoin de connaître la largeur en tiles de notre tileset. Il faut donc ajouter le code suivant dans la fonction onload de l'image :</p><pre id="r-498171" data-claire-element-id="498171"><code data-claire-semantic="javascript">// Largeur du tileset en tiles
this.referenceDuTileset.largeur = this.width / 32;</code></pre><p id="r-498172" data-claire-element-id="498172">Nous allons pouvoir maintenant attaquer notre méthode de dessin.<br/> Voici un tableau récapitulatif des paramètres dont nous avons besoin pour utiliser la méthode drawImage du context, ainsi que leur description et leur valeur si elle est déjà connue :</p><table id="r-498245" data-claire-element-id="498245"><thead id="r-498180" data-claire-element-id="498180"><tr id="r-498179" data-claire-element-id="498179"><th id="r-498174" data-claire-element-id="498174"><p id="r-498173" data-claire-element-id="498173">Paramètre</p></th><th id="r-498176" data-claire-element-id="498176"><p id="r-498175" data-claire-element-id="498175">Description</p></th><th id="r-498178" data-claire-element-id="498178"><p id="r-498177" data-claire-element-id="498177">Valeur</p></th></tr></thead><tbody id="r-498244" data-claire-element-id="498244"><tr id="r-498187" data-claire-element-id="498187"><td id="r-498182" data-claire-element-id="498182"><p id="r-498181" data-claire-element-id="498181">image</p></td><td id="r-498184" data-claire-element-id="498184"><p id="r-498183" data-claire-element-id="498183">L'image source</p></td><td id="r-498186" data-claire-element-id="498186"><p id="r-498185" data-claire-element-id="498185">this.image</p></td></tr><tr id="r-498194" data-claire-element-id="498194"><td id="r-498189" data-claire-element-id="498189"><p id="r-498188" data-claire-element-id="498188">sx</p></td><td id="r-498191" data-claire-element-id="498191"><p id="r-498190" data-claire-element-id="498190">Coordonnée x du tile dans le tileset</p></td><td id="r-498193" data-claire-element-id="498193"><p id="r-498192" data-claire-element-id="498192"><strong>???</strong></p></td></tr><tr id="r-498201" data-claire-element-id="498201"><td id="r-498196" data-claire-element-id="498196"><p id="r-498195" data-claire-element-id="498195">sy</p></td><td id="r-498198" data-claire-element-id="498198"><p id="r-498197" data-claire-element-id="498197">Coordonnée y du tile dans le tileset</p></td><td id="r-498200" data-claire-element-id="498200"><p id="r-498199" data-claire-element-id="498199"><strong>???</strong></p></td></tr><tr id="r-498208" data-claire-element-id="498208"><td id="r-498203" data-claire-element-id="498203"><p id="r-498202" data-claire-element-id="498202">sw</p></td><td id="r-498205" data-claire-element-id="498205"><p id="r-498204" data-claire-element-id="498204">Largeur de l'image source</p></td><td id="r-498207" data-claire-element-id="498207"><p id="r-498206" data-claire-element-id="498206">32</p></td></tr><tr id="r-498215" data-claire-element-id="498215"><td id="r-498210" data-claire-element-id="498210"><p id="r-498209" data-claire-element-id="498209">sh</p></td><td id="r-498212" data-claire-element-id="498212"><p id="r-498211" data-claire-element-id="498211">Hauteur de l'image source</p></td><td id="r-498214" data-claire-element-id="498214"><p id="r-498213" data-claire-element-id="498213">32</p></td></tr><tr id="r-498222" data-claire-element-id="498222"><td id="r-498217" data-claire-element-id="498217"><p id="r-498216" data-claire-element-id="498216">dx</p></td><td id="r-498219" data-claire-element-id="498219"><p id="r-498218" data-claire-element-id="498218">Coordonnée x de destination</p></td><td id="r-498221" data-claire-element-id="498221"><p id="r-498220" data-claire-element-id="498220">xDestination</p></td></tr><tr id="r-498229" data-claire-element-id="498229"><td id="r-498224" data-claire-element-id="498224"><p id="r-498223" data-claire-element-id="498223">dy</p></td><td id="r-498226" data-claire-element-id="498226"><p id="r-498225" data-claire-element-id="498225">Coordonnée y de destination</p></td><td id="r-498228" data-claire-element-id="498228"><p id="r-498227" data-claire-element-id="498227">yDestination</p></td></tr><tr id="r-498236" data-claire-element-id="498236"><td id="r-498231" data-claire-element-id="498231"><p id="r-498230" data-claire-element-id="498230">dw</p></td><td id="r-498233" data-claire-element-id="498233"><p id="r-498232" data-claire-element-id="498232">Largeur de l'image a dessiner</p></td><td id="r-498235" data-claire-element-id="498235"><p id="r-498234" data-claire-element-id="498234">32</p></td></tr><tr id="r-498243" data-claire-element-id="498243"><td id="r-498238" data-claire-element-id="498238"><p id="r-498237" data-claire-element-id="498237">dh</p></td><td id="r-498240" data-claire-element-id="498240"><p id="r-498239" data-claire-element-id="498239">Hauteur de l'image a dessiner</p></td><td id="r-498242" data-claire-element-id="498242"><p id="r-498241" data-claire-element-id="498241">32</p></td></tr></tbody></table><p id="r-498246" data-claire-element-id="498246">Nous avons donc à peu près ce qu'il nous faut, sauf les coordonnées x et y du tile demandé dans le tileset. Nous allons donc déterminer sa position (x, y), <strong>en nombre de tiles</strong>.</p><p id="r-498247" data-claire-element-id="498247">Tout d'abord, la coordonnée x :</p><pre id="r-498248" data-claire-element-id="498248"><code data-claire-semantic="javascript">var xSourceEnTiles = numero % this.largeur;
if(xSourceEnTiles == 0) xSourceEnTiles = this.largeur;</code></pre><p id="r-498249" data-claire-element-id="498249">Ici, il n'y a que des maths. On prend le reste de la division entière du numéro du tile par la largeur (en tiles) du tileset. On obtient alors le numéro de la colonne où est situé le tile. Par contre si on obtient 0, c'est qu'on est sur un tile tout à droite du tileset.</p><p id="r-498250" data-claire-element-id="498250">Pour la coordonnée y :</p><pre id="r-498251" data-claire-element-id="498251"><code data-claire-semantic="javascript">var ySourceEnTiles = Math.ceil(numero / this.largeur);</code></pre><p id="r-498252" data-claire-element-id="498252">Ici on divise le numéro demandé par la largeur en tiles. Si nous obtenons un nombre entier, pas de problème. Dans le cas contraire c'est que nous ne sommes plus sur la ligne indiquée par la partie entière, mais sur la ligne suivante.</p><p id="r-498253" data-claire-element-id="498253">Maintenant, c'est plutôt facile :</p><pre id="r-498254" data-claire-element-id="498254"><code data-claire-semantic="javascript">var xSource = (xSourceEnTiles - 1) * 32;
var ySource = (ySourceEnTiles - 1) * 32;</code></pre><aside id="r-498256" data-claire-element-id="498256" data-claire-semantic="warning"><p id="r-498255" data-claire-element-id="498255">Il faut bien penser à ne pas oublier le -1. En effet, le tile numéro 1 est situé aux coordonnées (0, 0), pas (32, 32).</p></aside><p id="r-498257" data-claire-element-id="498257">Il ne nous reste plus qu'à utiliser la méthode de dessin :</p><pre id="r-498258" data-claire-element-id="498258"><code data-claire-semantic="javascript">context.drawImage(this.image, xSource, ySource, 32, 32, xDestination, yDestination, 32, 32);</code></pre><p id="r-498259" data-claire-element-id="498259">Si tout va bien vous devriez obtenir ceci, qui correspond bien a nos attentes :</p><figure id="r-498261" data-claire-element-id="498262"><img id="r-498260" data-claire-element-id="498260" src="medias/uploads.siteduzero.com_files_299001_300000_299450.png" alt="Résultat de l'affichage des tiles 1, 5, 6 et 7"/></figure><p id="r-498263" data-claire-element-id="498263">Nous sommes maintenant capables d'afficher facilement n'importe quel tile de notre tileset !</p><p id="r-498264" data-claire-element-id="498264">Vous verrez que ca sera bien plus facile pour afficher notre carte dans la partie suivante.</p>
<aside class="aside-menu">
<ul class="content-menu" role="navigation">
<li class="tuto">
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas">Créer un mini-RPG en JavaScript avec canvas</a>
</li>
<li class="chapter">
 
<a class="chapterLink" onmouseover="$(this).addClass('box-shadow-summary').next().addClass('box-shadow-summary');" onmouseout="$(this).removeClass('box-shadow-summary').next().removeClass('box-shadow-summary');">
<span>Partie 1</span>
La carte
</a>
<a class="chapterOpen" href="#" onmouseover="$(this).addClass('box-shadow-summary').prev().addClass('box-shadow-summary');" onmouseout="$(this).removeClass('box-shadow-summary').prev().removeClass('box-shadow-summary');">
<span>+</span>
</a>
 
<ul class="subchapters">
<li class="subchapter">
<div>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/mise-en-place-des-bases">Mise en place des bases</a>
<a class="subchapterOpen" href="#">
<span>+</span>
</a>
</div>
<ul class="subchapter-parts">
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/structure-des-fichiers">
Structure des fichiers
</a>
</li>
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/mise-en-place-du-canvas">
Mise en place du canvas
</a>
</li>
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/le-cas-d-internet-explorer">
Le cas d&#039;Internet Explorer
</a>
</li>
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/utilisation-de-l-objet-context">
Utilisation de l&#039;objet context
</a>
</li>
</ul> </li> <li class="subchapter">
<div>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/gestion-des-tilesets">Gestion des tilesets</a>
<a class="subchapterOpen" href="#">
<span>+</span>
</a>
</div>
<ul class="subchapter-parts">
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/presentation-132">
Présentation
</a>
</li>
<li class="active">
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/decoupage-et-utilisation">
Découpage et utilisation
</a>
</li>
</ul> </li> <li class="subchapter">
<div>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/mise-en-place-du-terrain">Mise en place du terrain</a>
<a class="subchapterOpen" href="#">
<span>+</span>
</a>
</div>
<ul class="subchapter-parts">
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/format-de-stockage-des-donnees">
Format de stockage des données
</a>
</li>
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/chargement-et-affichage-du-terrain">
Chargement et affichage du terrain
</a>
</li>
</ul> </li></ul> </li>
<li class="chapter">
 
<a class="chapterLink" onmouseover="$(this).addClass('box-shadow-summary').next().addClass('box-shadow-summary');" onmouseout="$(this).removeClass('box-shadow-summary').next().removeClass('box-shadow-summary');">
<span>Partie 2</span>
Les personnages et les décors
</a>
<a class="chapterOpen" href="#" onmouseover="$(this).addClass('box-shadow-summary').prev().addClass('box-shadow-summary');" onmouseout="$(this).removeClass('box-shadow-summary').prev().removeClass('box-shadow-summary');">
<span>+</span>
</a>
 
<ul class="subchapters">
<li class="subchapter">
<div>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/les-personnages-1">Les personnages</a>
<a class="subchapterOpen" href="#">
<span>+</span>
</a>
</div>
<ul class="subchapter-parts">
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/choix-et-rendu-des-sprites">
Choix et rendu des sprites
</a>
</li>
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/clavier-et-boucle-principale">
Clavier et boucle principale
</a>
</li>
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/animation-des-deplacements">
Animation des déplacements
</a>
</li>
</ul>
</li>
</ul>
</li>
</li>
</ul>
</aside>
</div>
<div id="content-bottom-menu"></div>
<hr/>
<div class="paginate-tuto">
<a class="before" href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/presentation-132">
<span class="arrow"></span>
<span class="next">Présentation</span>
</a>
<a class="after" href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/mise-en-place-du-terrain">
<span class="next">Mise en place du terrain</span>
<span class="arrow"></span>
</a>
</div>
<hr class="bottom"/>
<div class="clear"></div> <div class="adBan">
<script type='text/javascript'>
    if (window.innerWidth >= 728)
    {
        document.write('<div id="div-gpt-ad-1350977194635-8" class="megaban"></div>');
        googletag.cmd.push(function() {
            googletag.display('div-gpt-ad-1350977194635-8');
        });
    }
            else
        {
            document.write('<div id="div-gpt-ad-1350977284180-8" class="miniban"></div>');
            googletag.cmd.push(function() {
                googletag.display('div-gpt-ad-1350977284180-8');
            });
        }
    </script>
</div>
<div class="clear"></div><a name="Miseenplaceduterrain"></a><h2>Mise en place du terrain</h2><div class="paginate-tuto">
<a class="before" href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/decoupage-et-utilisation">
<span class="arrow"></span>
<span class="next">Découpage et utilisation</span>
</a>
<a class="after" href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/format-de-stockage-des-donnees">
<span class="next">Format de stockage des données</span>
<span class="arrow"></span>
</a>
</div>
<hr class="top"/>
<div class="clear"></div> <div class="content">
<p id="r-498268" data-claire-element-id="498268">Nous allons maintenant mettre en place la première partie de la carte : le terrain.</p><p id="r-498269" data-claire-element-id="498269">Cette partie vous permettra de vous rendre compte de l'utilité des tilesets que nous avons mis en place dans la partie précédente, ainsi que de la facilité que ça nous apporte.</p>
</div><a name="Formatdestockagedesdonnes"></a><h2>Format de stockage des données</h2><div class="paginate-tuto">
<a class="before" href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/mise-en-place-du-terrain">
<span class="arrow"></span>
<span class="next">Mise en place du terrain</span>
</a>
<a class="after" href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/chargement-et-affichage-du-terrain">
<span class="next">Chargement et affichage du terrain</span>
<span class="arrow"></span>
</a>
</div>
<hr class="top"/>
<div class="clear"></div> <div id="content" role="article">
<h4 id="r-format-de-stockage-des-donnees" data-claire-element-id="498382">Format de stockage des données</h4><h5 id="r-choix-d-un-langage-de-representation-des-donnees" data-claire-element-id="498361">Choix d'un langage de représentation des données</h5><p id="r-498270" data-claire-element-id="498270">Nous allons tout d'abord commencer par nous interroger sur la manière dont nous allons stocker nos cartes, et plus précisément sur la syntaxe que nous allons utiliser.</p><p id="r-498271" data-claire-element-id="498271">À première vue, il existe plusieurs solutions que je vais répertorier ici :</p><table id="r-498359" data-claire-element-id="498359"><thead id="r-498279" data-claire-element-id="498279"><tr id="r-498278" data-claire-element-id="498278"><th id="r-498273" data-claire-element-id="498273"><p id="r-498272" data-claire-element-id="498272">Format</p></th><th id="r-498275" data-claire-element-id="498275"><p id="r-498274" data-claire-element-id="498274">Avantages</p></th><th id="r-498277" data-claire-element-id="498277"><p id="r-498276" data-claire-element-id="498276">Inconvénients</p></th></tr></thead><tbody id="r-498358" data-claire-element-id="498358"><tr id="r-498296" data-claire-element-id="498296"><td id="r-498281" data-claire-element-id="498281"><p id="r-498280" data-claire-element-id="498280">XML</p></td><td id="r-498289" data-claire-element-id="498289"><ul id="r-498288" data-claire-element-id="498288"><li id="r-498283" data-claire-element-id="498283"><p id="r-498282" data-claire-element-id="498282">Possibilité de structurer correctement notre document</p></li><li id="r-498285" data-claire-element-id="498285"><p id="r-498284" data-claire-element-id="498284">Facile à interpréter</p></li><li id="r-498287" data-claire-element-id="498287"><p id="r-498286" data-claire-element-id="498286">Standard</p></li></ul></td><td id="r-498295" data-claire-element-id="498295"><ul id="r-498294" data-claire-element-id="498294"><li id="r-498291" data-claire-element-id="498291"><p id="r-498290" data-claire-element-id="498290">Les données seront difficilement lisibles dans notre cas (c'est à dire une liste de cases à deux dimensions).</p></li><li id="r-498293" data-claire-element-id="498293"><p id="r-498292" data-claire-element-id="498292">Syntaxe très lourde, le fichier sera d'autant plus gros</p></li></ul></td></tr><tr id="r-498310" data-claire-element-id="498310"><td id="r-498298" data-claire-element-id="498298"><p id="r-498297" data-claire-element-id="498297">JSON</p></td><td id="r-498308" data-claire-element-id="498308"><ul id="r-498307" data-claire-element-id="498307"><li id="r-498300" data-claire-element-id="498300"><p id="r-498299" data-claire-element-id="498299">Syntaxe légère</p></li><li id="r-498302" data-claire-element-id="498302"><p id="r-498301" data-claire-element-id="498301">Standard</p></li><li id="r-498304" data-claire-element-id="498304"><p id="r-498303" data-claire-element-id="498303">Très lisible</p></li><li id="r-498306" data-claire-element-id="498306"><p id="r-498305" data-claire-element-id="498305">Facile à interpréter</p></li></ul></td><td id="r-498309" data-claire-element-id="498309"></td></tr><tr id="r-498325" data-claire-element-id="498325"><td id="r-498312" data-claire-element-id="498312"><p id="r-498311" data-claire-element-id="498311">Texte brut</p></td><td id="r-498318" data-claire-element-id="498318"><ul id="r-498317" data-claire-element-id="498317"><li id="r-498314" data-claire-element-id="498314"><p id="r-498313" data-claire-element-id="498313">Syntaxe légère</p></li><li id="r-498316" data-claire-element-id="498316"><p id="r-498315" data-claire-element-id="498315">Très lisible</p></li></ul></td><td id="r-498324" data-claire-element-id="498324"><ul id="r-498323" data-claire-element-id="498323"><li id="r-498320" data-claire-element-id="498320"><p id="r-498319" data-claire-element-id="498319">Il faudra développer notre propre interpréteur</p></li><li id="r-498322" data-claire-element-id="498322"><p id="r-498321" data-claire-element-id="498321">Moins facile et moins propre d'intégrer des valeurs supplémentaires</p></li></ul></td></tr><tr id="r-498340" data-claire-element-id="498340"><td id="r-498327" data-claire-element-id="498327"><p id="r-498326" data-claire-element-id="498326">Binaire</p></td><td id="r-498331" data-claire-element-id="498331"><ul id="r-498330" data-claire-element-id="498330"><li id="r-498329" data-claire-element-id="498329"><p id="r-498328" data-claire-element-id="498328">Très très léger</p></li></ul></td><td id="r-498339" data-claire-element-id="498339"><ul id="r-498338" data-claire-element-id="498338"><li id="r-498333" data-claire-element-id="498333"><p id="r-498332" data-claire-element-id="498332">Complètement illisible visuellement</p></li><li id="r-498335" data-claire-element-id="498335"><p id="r-498334" data-claire-element-id="498334">Moins facile et moins propre d'intégrer des valeurs supplémentaires</p></li><li id="r-498337" data-claire-element-id="498337"><p id="r-498336" data-claire-element-id="498336">JavaScript est prévu pour traiter des chaînes, pas du binaire. Outre les difficultés que cela impliquerait, nous y perdrions les gains en performances</p></li></ul></td></tr><tr id="r-498357" data-claire-element-id="498357"><td id="r-498342" data-claire-element-id="498342"><p id="r-498341" data-claire-element-id="498341">CSV</p></td><td id="r-498352" data-claire-element-id="498352"><ul id="r-498351" data-claire-element-id="498351"><li id="r-498344" data-claire-element-id="498344"><p id="r-498343" data-claire-element-id="498343">Léger</p></li><li id="r-498346" data-claire-element-id="498346"><p id="r-498345" data-claire-element-id="498345">Standard</p></li><li id="r-498348" data-claire-element-id="498348"><p id="r-498347" data-claire-element-id="498347">Éditable dans un tableur</p></li><li id="r-498350" data-claire-element-id="498350"><p id="r-498349" data-claire-element-id="498349">Interpréteur facile à faire ou à trouver.</p></li></ul></td><td id="r-498356" data-claire-element-id="498356"><ul id="r-498355" data-claire-element-id="498355"><li id="r-498354" data-claire-element-id="498354"><p id="r-498353" data-claire-element-id="498353">Moins facile et moins propre d'intégrer des valeurs supplémentaires</p></li></ul></td></tr></tbody></table><p id="r-498360" data-claire-element-id="498360">Le format que j'ai choisi pour notre RPG est le JSON.</p><h5 id="r-structure-de-nos-cartes" data-claire-element-id="498381">Structure de nos cartes</h5><p id="r-498362" data-claire-element-id="498362">Dans notre fichier, nous allons devoir stocker pour le moment les éléments suivants (mais il y en aura d'autres à l'avenir) :</p><ul id="r-498369" data-claire-element-id="498369"><li id="r-498364" data-claire-element-id="498364"><p id="r-498363" data-claire-element-id="498363">Terrain présent sur chaque case</p></li><li id="r-498366" data-claire-element-id="498366"><p id="r-498365" data-claire-element-id="498365">Tileset qu'on va utiliser</p></li><li id="r-498368" data-claire-element-id="498368"><p id="r-498367" data-claire-element-id="498367">Taille de la carte</p></li></ul><p id="r-498370" data-claire-element-id="498370">Pour la taille de la carte, ça va être facile : nos cases seront stockées dans des tableaux, il suffira donc de récupérer la taille des tableaux.</p><p id="r-498371" data-claire-element-id="498371">Avant de poursuivre, je vous invite à enregistrer le tileset que nous utiliserons ici (je l'ai pris sur rpg-maker.fr, puis modifié un peu pour l'adapter à nos besoins), qui est le suivant (je l'ai nommé &quot;chemin.png&quot;) :</p><figure id="r-498373" data-claire-element-id="498374"><img id="r-498372" data-claire-element-id="498372" src="medias/uploads.siteduzero.com_files_301001_302000_301139.png" alt="Tileset de chemin"/></figure><p id="r-498375" data-claire-element-id="498375">Voici le code de notre première carte (enregistrez-le dans le dossier &quot;maps&quot;, avec l'extension &quot;.json&quot;. Pour ma part, il se nomme &quot;premiere.json&quot;.) :</p><pre id="r-498376" data-claire-element-id="498376"><code data-claire-semantic="javascript">{
	&quot;tileset&quot; : &quot;chemin.png&quot;,
	&quot;terrain&quot; : [
		[2, 2, 2, 2, 2, 2, 9, 10, 11,  2,  2,  2,  2,  2,  2],
		[2, 2, 2, 2, 2, 2, 9, 10, 11,  2,  2,  2,  2,  2,  2],
		[2, 2, 2, 2, 2, 2, 9, 10, 11,  2,  2,  2,  2,  2,  2],
		[2, 2, 2, 2, 2, 2, 9, 10, 11,  2,  2,  2,  2,  2,  2],
		[2, 2, 2, 2, 2, 2, 9, 10, 11,  2,  2,  2,  2,  2,  2],
		[2, 2, 2, 2, 2, 2, 9, 10, 11,  2,  2,  2,  2,  2,  2],
		[2, 2, 2, 2, 2, 2, 9, 10,  8,  6,  6,  6,  6,  6,  6],
		[2, 2, 2, 2, 2, 2, 9, 10, 10, 10, 10, 10, 10, 10, 10],
		[2, 2, 2, 2, 2, 2, 9, 10, 12, 14, 14, 14, 14, 14, 14],
		[2, 2, 2, 2, 2, 2, 9, 10, 11,  2,  2,  2,  2,  2,  2],
		[2, 2, 2, 2, 2, 2, 9, 10, 11,  2,  2,  2,  2,  2,  2],
		[2, 2, 2, 2, 2, 2, 9, 10, 11,  2,  2,  2,  2,  2,  2],
		[2, 2, 2, 2, 2, 2, 9, 10, 11,  2,  2,  2,  2,  2,  2],
		[2, 2, 2, 2, 2, 2, 9, 10, 11,  2,  2,  2,  2,  2,  2],
		[2, 2, 2, 2, 2, 2, 9, 10, 11,  2,  2,  2,  2,  2,  2]
	]
}</code></pre><p id="r-498377" data-claire-element-id="498377">Pour ceux qui sont courageux ou masochistes (comme moi), vous verrez peut-être dès maintenant à quoi ressemblera la carte. Vous pouvez même la modifier. Comme vous pouvez le voir, cette syntaxe nous permet presque d'avoir un aperçu en deux dimensions du code de la carte, ce qui plus facile à manipuler.</p><div id="r-498379" data-claire-element-id="498379" data-claire-semantic="question"><p id="r-498378" data-claire-element-id="498378">Et tu sors ce code d'où ?</p></div><p id="r-498380" data-claire-element-id="498380">J'ai pris le temps de le faire en mode texte (et c'était d'ailleurs un peu pénible ^^ ). Lorsque l'ensemble du tutoriel sera fini, avec tout ce que vous aurez appris, vous devriez être capable de facilement créer un éditeur de cartes pour tout faire visuellement.</p>
<aside class="aside-menu">
<ul class="content-menu" role="navigation">
<li class="tuto">
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas">Créer un mini-RPG en JavaScript avec canvas</a>
</li>
<li class="chapter">
 
<a class="chapterLink" onmouseover="$(this).addClass('box-shadow-summary').next().addClass('box-shadow-summary');" onmouseout="$(this).removeClass('box-shadow-summary').next().removeClass('box-shadow-summary');">
<span>Partie 1</span>
La carte
</a>
<a class="chapterOpen" href="#" onmouseover="$(this).addClass('box-shadow-summary').prev().addClass('box-shadow-summary');" onmouseout="$(this).removeClass('box-shadow-summary').prev().removeClass('box-shadow-summary');">
<span>+</span>
</a>
 
<ul class="subchapters">
<li class="subchapter">
<div>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/mise-en-place-des-bases">Mise en place des bases</a>
<a class="subchapterOpen" href="#">
<span>+</span>
</a>
</div>
<ul class="subchapter-parts">
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/structure-des-fichiers">
Structure des fichiers
</a>
</li>
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/mise-en-place-du-canvas">
Mise en place du canvas
</a>
</li>
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/le-cas-d-internet-explorer">
Le cas d&#039;Internet Explorer
</a>
</li>
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/utilisation-de-l-objet-context">
Utilisation de l&#039;objet context
</a>
</li>
</ul> </li> <li class="subchapter">
<div>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/gestion-des-tilesets">Gestion des tilesets</a>
<a class="subchapterOpen" href="#">
<span>+</span>
</a>
</div>
<ul class="subchapter-parts">
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/presentation-132">
Présentation
</a>
</li>
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/decoupage-et-utilisation">
Découpage et utilisation
</a>
</li>
</ul> </li> <li class="subchapter">
<div>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/mise-en-place-du-terrain">Mise en place du terrain</a>
<a class="subchapterOpen" href="#">
<span>+</span>
</a>
</div>
<ul class="subchapter-parts">
<li class="active">
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/format-de-stockage-des-donnees">
Format de stockage des données
</a>
</li>
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/chargement-et-affichage-du-terrain">
Chargement et affichage du terrain
</a>
</li>
</ul> </li></ul> </li>
<li class="chapter">
 
<a class="chapterLink" onmouseover="$(this).addClass('box-shadow-summary').next().addClass('box-shadow-summary');" onmouseout="$(this).removeClass('box-shadow-summary').next().removeClass('box-shadow-summary');">
<span>Partie 2</span>
Les personnages et les décors
</a>
<a class="chapterOpen" href="#" onmouseover="$(this).addClass('box-shadow-summary').prev().addClass('box-shadow-summary');" onmouseout="$(this).removeClass('box-shadow-summary').prev().removeClass('box-shadow-summary');">
<span>+</span>
</a>
 
<ul class="subchapters">
<li class="subchapter">
<div>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/les-personnages-1">Les personnages</a>
<a class="subchapterOpen" href="#">
<span>+</span>
</a>
</div>
<ul class="subchapter-parts">
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/choix-et-rendu-des-sprites">
Choix et rendu des sprites
</a>
</li>
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/clavier-et-boucle-principale">
Clavier et boucle principale
</a>
</li>
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/animation-des-deplacements">
Animation des déplacements
</a>
</li>
</ul>
</li>
</ul>
</li>
</li>
</ul>
</aside>
</div>
<div id="content-bottom-menu"></div>
<hr/>
<div class="paginate-tuto">
<a class="before" href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/mise-en-place-du-terrain">
<span class="arrow"></span>
<span class="next">Mise en place du terrain</span>
</a>
<a class="after" href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/chargement-et-affichage-du-terrain">
<span class="next">Chargement et affichage du terrain</span>
<span class="arrow"></span>
</a>
</div>
<hr class="bottom"/>
<div class="clear"></div> <div class="adBan">
<script type='text/javascript'>
    if (window.innerWidth >= 728)
    {
        document.write('<div id="div-gpt-ad-1350977194635-8" class="megaban"></div>');
        googletag.cmd.push(function() {
            googletag.display('div-gpt-ad-1350977194635-8');
        });
    }
            else
        {
            document.write('<div id="div-gpt-ad-1350977284180-8" class="miniban"></div>');
            googletag.cmd.push(function() {
                googletag.display('div-gpt-ad-1350977284180-8');
            });
        }
    </script>
</div>
<div class="clear"></div><a name="Chargementetaffichageduterrain"></a><h2>Chargement et affichage du terrain</h2><div class="paginate-tuto">
<a class="before" href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/format-de-stockage-des-donnees">
<span class="arrow"></span>
<span class="next">Format de stockage des données</span>
</a>
<a class="after" href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/les-personnages-1">
<span class="next">Les personnages</span>
<span class="arrow"></span>
</a>
</div>
<hr class="top"/>
<div class="clear"></div> <div id="content" role="article">
<h4 id="r-chargement-et-affichage-du-terrain" data-claire-element-id="498432">Chargement et affichage du terrain</h4><h5 id="r-structure-de-la-classe-1" data-claire-element-id="498386">Structure de la classe</h5><p id="r-498383" data-claire-element-id="498383">Nous pouvons maintenant passer au codage à proprement parler.</p><p id="r-498384" data-claire-element-id="498384">Nous allons créer une classe &quot;Map&quot; (mais vous pouvez la nommer &quot;Carte&quot; si vous préférez l'avoir en français, néanmoins le terme de &quot;map&quot; vous sera plus familier si vous avez un peu l'habitude des jeux vidéo). Cette classe aura pour rôle de charger les données de la carte (que nous avons mises en place dans la partie précédente), et d'afficher le terrain sur demande.</p><p id="r-498385" data-claire-element-id="498385">Un peu comme pour le tileset, nous aurons donc une méthode &quot;dessinerMap&quot;, qui prendra en paramètre un objet context. Cette méthode y dessinera l'ensemble du terrain.<br/> J'y ajouterai également deux getters : getHauteur() et getLargeur().</p><h5 id="r-programme-de-test-2" data-claire-element-id="498390">Programme de test</h5><p id="r-498387" data-claire-element-id="498387">Ouvrez votre fichier rpg.js et mettez-y le code suivant (et pensez à faire une sauvegarde du code précédent s'il y a quelque chose que vous souhaitez conserver) :</p><pre id="r-498388" data-claire-element-id="498388"><code data-claire-semantic="javascript">var map = new Map(&quot;premiere&quot;);

window.onload = function() {
	var canvas = document.getElementById('canvas');
	var ctx = canvas.getContext('2d');
	
	canvas.width  = map.getLargeur() * 32;
	canvas.height = map.getHauteur() * 32;
	
	map.dessinerMap(ctx);
}</code></pre><p id="r-498389" data-claire-element-id="498389">Comme vous pouvez le voir, nous modifions automatiquement la taille du canvas pour que l'ensemble de la carte puisse y tenir. Cette méthode n'est pas la meilleure puisqu'elle nous posera des soucis lorsqu'on voudra faire une carte plus grande que l'écran. Nous allons quand même l'utiliser pour le moment, mais nous y reviendrons dans une prochaine partie.</p><h5 id="r-chargement-des-donnees-json" data-claire-element-id="498409">Chargement des données JSON</h5><p id="r-498391" data-claire-element-id="498391">Maintenant créez notre classe Map dans le fichier qui va bien, et pensez à l'inclure depuis le fichier HTML.</p><p id="r-498392" data-claire-element-id="498392">Notre constructeur chargera les données de la carte, et interprétera le code JSON.<br/> Nous allons donc utiliser AJAX (ou XMLHttpRequest pour les intimes :-° ). Pour nous simplifier la vie, je vais réutiliser la <a href="../../nayi.free.fr/dev/ajax/oXHR.js">fonction</a> que Thunderseb a mis a disposition dans son tuto sur Ajax. Enregistrez la dans le dossier js (et pensez bien à l'inclure dans votre page HTML). <br/> Nous allons donc commencer par créer une instance de cet objet :</p><pre id="r-498393" data-claire-element-id="498393"><code data-claire-semantic="javascript">function Map(nom) {
	
	// Création de l'objet XmlHttpRequest
	var xhr = getXMLHttpRequest();

	// Ici viendra le code que je vous présente ci-dessous
}</code></pre><p id="r-498394" data-claire-element-id="498394">Ensuite, nous lui demandons de charger le contenu du fichier JSON :</p><pre id="r-498395" data-claire-element-id="498395"><code data-claire-semantic="javascript">// Chargement du fichier
xhr.open(&quot;GET&quot;, './maps/' + nom + '.json', false);
xhr.send(null);
if(xhr.readyState != 4 || (xhr.status != 200 &amp;&amp; xhr.status != 0)) // Code == 0 en local
	throw new Error(&quot;Impossible de charger la carte nommée \&quot;&quot; + nom + &quot;\&quot; (code HTTP : &quot; + xhr.status + &quot;).&quot;);
var mapJsonData = xhr.responseText;</code></pre><aside id="r-498397" data-claire-element-id="498397" data-claire-semantic="warning"><p id="r-498396" data-claire-element-id="498396">Si vous n'utilisez pas de serveur web, il faudra peut-être configurer votre navigateur pour qu'il accepte d'utiliser AJAX sur des fichiers locaux (c'est notamment le cas d'Opera).</p></aside><p id="r-498398" data-claire-element-id="498398">Vous noterez que l'objet ne renvoie pas un code HTTP 200 si vous êtes en local puisque vous n'utilisez pas HTTP dans ce cas là.</p><p id="r-498399" data-claire-element-id="498399">Nous avons maintenant le contenu de notre fichier (donc le code JSON) dans la variable mapJsonData. Il nous suffit de le &quot;parser&quot;, c'est à dire de le transformer en objet(s) JavaScript. Pour cela il existe plusieurs méthodes. La plus propre, c'est d'utiliser la méthode JSON.parse. Mais sur certains navigateurs un peu anciens, cette méthode n'existe pas forcément. Pour eux, il va falloir inclure la librairie JavaScript qui convient (disponible sur le site <a href="http://www.json.org/">http://www.json.org/</a>, ou si vous préférez le <a href="../../raw.githubusercontent.com/douglascrockford/JSON-js/master/json2.js">lien direct</a> vers le fichier, qu'il faudra inclure dans votre HTML, de préférence en premier) :</p><pre id="r-498400" data-claire-element-id="498400"><code data-claire-semantic="javascript">// Analyse des données
var mapData = JSON.parse(mapJsonData);</code></pre><p id="r-498401" data-claire-element-id="498401">JSON étant un langage de représentation tiré de JavaScript, c'est très performant car totalement natif.<br/> Nous avons donc maintenant une variable mapData, qui fait référence à un objet contenant :</p><ul id="r-498406" data-claire-element-id="498406"><li id="r-498403" data-claire-element-id="498403"><p id="r-498402" data-claire-element-id="498402">Un attribut tileset, qui contient le nom du tileset à utiliser</p></li><li id="r-498405" data-claire-element-id="498405"><p id="r-498404" data-claire-element-id="498404">Un attribut terrain, qui contient une matrice (ou tableau a deux dimensions) contenant des entiers. Chaque entier est le numéro du tile a utiliser pour la case a laquelle il correspond.</p></li></ul><p id="r-498407" data-claire-element-id="498407">Nous pouvons maintenant charger le tileset requis et stocker la matrice du terrain dans un attribut de notre objet :</p><pre id="r-498408" data-claire-element-id="498408"><code data-claire-semantic="javascript">this.tileset = new Tileset(mapData.tileset);
this.terrain = mapData.terrain;</code></pre><h5 id="r-mise-en-place-des-methodes-de-l-objet" data-claire-element-id="498431">Mise en place des méthodes de l'objet</h5><p id="r-498410" data-claire-element-id="498410">Viennent ensuite nos trois méthodes. Les deux getters sont les plus simples :</p><pre id="r-498411" data-claire-element-id="498411"><code data-claire-semantic="javascript">// Pour récupérer la taille (en tiles) de la carte
Map.prototype.getHauteur = function() {
	return this.terrain.length;
}
Map.prototype.getLargeur = function() {
	return this.terrain[0].length;
}</code></pre><p id="r-498412" data-claire-element-id="498412">La hauteur est définie par le nombre de tableaux (donc de lignes) présents dans le tableau principal.<br/> La largeur est égale à la taille de n'importe quelle ligne (ici j'ai choisi la première puisqu'on a forcément au moins une ligne).</p><p id="r-498413" data-claire-element-id="498413">La méthode dessinerMap suivra l'algorithme suivant :</p><ul id="r-498420" data-claire-element-id="498420"><li id="r-498415" data-claire-element-id="498415"><p id="r-498414" data-claire-element-id="498414">On parcourt toutes les lignes</p></li><li id="r-498417" data-claire-element-id="498417"><p id="r-498416" data-claire-element-id="498416">Pour chaque ligne, on parcourt toutes les cellules</p></li><li id="r-498419" data-claire-element-id="498419"><p id="r-498418" data-claire-element-id="498418">Ensuite on demande au tileset de dessiner le tile dont le numéro est disponible dans la cellule, en lui passant les coordonnées correspondantes, c'est à dire (X = indice de la colonne * 32, Y = indice de la ligne * 32).</p></li></ul><pre id="r-498421" data-claire-element-id="498421"><code data-claire-semantic="javascript">Map.prototype.dessinerMap = function(context) {
	for(var i = 0, l = this.terrain.length ; i &lt; l ; i++) {
		var ligne = this.terrain[i];
		var y = i * 32;
		for(var j = 0, k = ligne.length ; j &lt; k ; j++) {
			this.tileset.dessinerTile(ligne[j], context, j * 32, y);
		}
	}
}</code></pre><p id="r-498422" data-claire-element-id="498422">Si tout va bien, vous devriez maintenant voir ceci :</p><figure id="r-498424" data-claire-element-id="498425"><img id="r-498423" data-claire-element-id="498423" src="medias/uploads.siteduzero.com_files_301001_302000_301157.png" alt="Terrain"/></figure><p id="r-498426" data-claire-element-id="498426">Nous sommes maintenant capables d'afficher aisément un terrain. Bien sûr c'est un peu vide, mais patience, nous y ajouterons des choses.</p><p id="r-498427" data-claire-element-id="498427">Et voilà, nous avons terminé la première partie de notre mini-RPG.</p><p id="r-498428" data-claire-element-id="498428">Dans la prochaine partie nous mettrons plus de choses sur notre terrain.</p><aside id="r-498430" data-claire-element-id="498430" data-claire-semantic="information"><p id="r-498429" data-claire-element-id="498429">Vous pouvez télécharger le code source de cette partie <a href="http://sebastien-caparros.name/tuto_sdz/Partie1.zip">ici</a>, ou bien le tester <a href="http://sebastien-caparros.name/tuto_sdz/Partie1/">ici</a>.</p></aside>
<aside class="aside-menu">
<ul class="content-menu" role="navigation">
<li class="tuto">
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas">Créer un mini-RPG en JavaScript avec canvas</a>
</li>
<li class="chapter">
 
<a class="chapterLink" onmouseover="$(this).addClass('box-shadow-summary').next().addClass('box-shadow-summary');" onmouseout="$(this).removeClass('box-shadow-summary').next().removeClass('box-shadow-summary');">
<span>Partie 1</span>
La carte
</a>
<a class="chapterOpen" href="#" onmouseover="$(this).addClass('box-shadow-summary').prev().addClass('box-shadow-summary');" onmouseout="$(this).removeClass('box-shadow-summary').prev().removeClass('box-shadow-summary');">
<span>+</span>
</a>
 
<ul class="subchapters">
<li class="subchapter">
<div>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/mise-en-place-des-bases">Mise en place des bases</a>
<a class="subchapterOpen" href="#">
<span>+</span>
</a>
</div>
<ul class="subchapter-parts">
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/structure-des-fichiers">
Structure des fichiers
</a>
</li>
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/mise-en-place-du-canvas">
Mise en place du canvas
</a>
</li>
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/le-cas-d-internet-explorer">
Le cas d&#039;Internet Explorer
</a>
</li>
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/utilisation-de-l-objet-context">
Utilisation de l&#039;objet context
</a>
</li>
</ul> </li> <li class="subchapter">
<div>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/gestion-des-tilesets">Gestion des tilesets</a>
<a class="subchapterOpen" href="#">
<span>+</span>
</a>
</div>
<ul class="subchapter-parts">
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/presentation-132">
Présentation
</a>
</li>
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/decoupage-et-utilisation">
Découpage et utilisation
</a>
</li>
</ul> </li> <li class="subchapter">
<div>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/mise-en-place-du-terrain">Mise en place du terrain</a>
<a class="subchapterOpen" href="#">
<span>+</span>
</a>
</div>
<ul class="subchapter-parts">
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/format-de-stockage-des-donnees">
Format de stockage des données
</a>
</li>
<li class="active">
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/chargement-et-affichage-du-terrain">
Chargement et affichage du terrain
</a>
</li>
</ul> </li></ul> </li>
<li class="chapter">
 
<a class="chapterLink" onmouseover="$(this).addClass('box-shadow-summary').next().addClass('box-shadow-summary');" onmouseout="$(this).removeClass('box-shadow-summary').next().removeClass('box-shadow-summary');">
<span>Partie 2</span>
Les personnages et les décors
</a>
<a class="chapterOpen" href="#" onmouseover="$(this).addClass('box-shadow-summary').prev().addClass('box-shadow-summary');" onmouseout="$(this).removeClass('box-shadow-summary').prev().removeClass('box-shadow-summary');">
<span>+</span>
</a>
 
<ul class="subchapters">
<li class="subchapter">
<div>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/les-personnages-1">Les personnages</a>
<a class="subchapterOpen" href="#">
<span>+</span>
</a>
</div>
<ul class="subchapter-parts">
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/choix-et-rendu-des-sprites">
Choix et rendu des sprites
</a>
</li>
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/clavier-et-boucle-principale">
Clavier et boucle principale
</a>
</li>
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/animation-des-deplacements">
Animation des déplacements
</a>
</li>
</ul>
</li>
</ul>
</li>
</li>
</ul>
</aside>
</div>
<div id="content-bottom-menu"></div>
<hr/>
<div class="paginate-tuto">
<a class="before" href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/format-de-stockage-des-donnees">
<span class="arrow"></span>
<span class="next">Format de stockage des données</span>
</a>
<a class="after" href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/les-personnages-1">
<span class="next">Les personnages</span>
<span class="arrow"></span>
</a>
</div>
<hr class="bottom"/>
<div class="clear"></div> <div class="adBan">
<script type='text/javascript'>
    if (window.innerWidth >= 728)
    {
        document.write('<div id="div-gpt-ad-1350977194635-8" class="megaban"></div>');
        googletag.cmd.push(function() {
            googletag.display('div-gpt-ad-1350977194635-8');
        });
    }
            else
        {
            document.write('<div id="div-gpt-ad-1350977284180-8" class="miniban"></div>');
            googletag.cmd.push(function() {
                googletag.display('div-gpt-ad-1350977284180-8');
            });
        }
    </script>
</div>
<div class="clear"></div><a name="Lespersonnages"></a><h2>Les personnages</h2><div class="paginate-tuto">
<a class="before" href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/chargement-et-affichage-du-terrain">
<span class="arrow"></span>
<span class="next">Chargement et affichage du terrain</span>
</a>
<a class="after" href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/choix-et-rendu-des-sprites">
<span class="next">Choix et rendu des sprites</span>
<span class="arrow"></span>
</a>
</div>
<hr class="top"/>
<div class="clear"></div> <div class="content">
<p id="r-498437" data-claire-element-id="498437">Dans cette partie, nous allons commencer à intégrer un personnage (celui que le joueur dirige, mais une bonne partie du travail sera faite pour les PNJ (Personnages Non Joueurs)) au jeu. Nous étudierons comment faire en sorte de pouvoir le déplacer à l'écran.</p><p id="r-498438" data-claire-element-id="498438">À la fin de cette partie, le personnage ne se déplacera que très basiquement, c'est à dire qu'il se &quot;téléportera&quot; d'une case à l'autre. L'animation du déplacement se fera dans la prochaine partie.</p>
</div><a name="Choixetrendudessprites"></a><h2>Choix et rendu des sprites</h2><div class="paginate-tuto">
<a class="before" href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/les-personnages-1">
<span class="arrow"></span>
<span class="next">Les personnages</span>
</a>
<a class="after" href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/clavier-et-boucle-principale">
<span class="next">Clavier et boucle principale</span>
<span class="arrow"></span>
</a>
</div>
<hr class="top"/>
<div class="clear"></div> <div id="content" role="article">
<h4 id="r-choix-et-rendu-des-sprites" data-claire-element-id="498513">Choix et rendu des sprites</h4><h5 id="r-le-fichier-de-sprite" data-claire-element-id="498461">Le fichier de sprite</h5><p id="r-498439" data-claire-element-id="498439">Avant d'afficher nos personnages, il faut se mettre d'accord sur le format utilisé.</p><div id="r-498441" data-claire-element-id="498441" data-claire-semantic="question"><p id="r-498440" data-claire-element-id="498440">C'est quoi un sprite ?</p></div><p id="r-498442" data-claire-element-id="498442">Non non, il ne s'agit pas d'une boisson, mais d'une image. Dans la même idée que le tileset, le sprite permet de combiner toutes les images d'un personnage dans un seul fichier afin d'en réduire le nombre.</p><p id="r-498443" data-claire-element-id="498443">Comme ce n'est probablement pas clair, voici en image le format que j'ai utilisé pour ce tutoriel. Pour les connaisseurs, vous verrez qu'il s'agit du format utilisé par RPG maker (un format que je trouve assez facile à comprendre, mais surtout qui vous permettra de trouver beaucoup de ressources sur Internet) :</p><figure id="r-498445" data-claire-element-id="498446"><img id="r-498444" data-claire-element-id="498444" src="medias/uploads.siteduzero.com_files_313001_314000_313386.png" alt="Sprite"/></figure><p id="r-498447" data-claire-element-id="498447">(image tirée du site <a href="http://www.rpg-maker.fr/">rpg-maker.fr</a>)</p><p id="r-498448" data-claire-element-id="498448">Nous voyons donc que cette image en contient en réalité 16 (4 lignes et 4 colonnes). Étudions-la de plus près :</p><ul id="r-498457" data-claire-element-id="498457"><li id="r-498450" data-claire-element-id="498450"><p id="r-498449" data-claire-element-id="498449">Sur la première ligne, il y a 4 images du personnage tourné vers le bas</p></li><li id="r-498452" data-claire-element-id="498452"><p id="r-498451" data-claire-element-id="498451">Sur la seconde ligne, il y a 4 images du personnage tourné vers la gauche</p></li><li id="r-498454" data-claire-element-id="498454"><p id="r-498453" data-claire-element-id="498453">Sur la troisième ligne, il y a 4 images du personnage tourné vers la droite</p></li><li id="r-498456" data-claire-element-id="498456"><p id="r-498455" data-claire-element-id="498455">Sur la dernière ligne, il y a 4 images du personnage tourné vers le haut</p></li></ul><p id="r-498458" data-claire-element-id="498458">Ensuite, pour chaque ligne, nous avons quatre images. Ces quatre images constitueront les quatre &quot;frames&quot; de l'animation du personnage (que nous étudierons un peu plus loin). Ce qui nous importe pour le moment, c'est la colonne de gauche. C'est là que l'on trouve l'image du personnage lorsqu'il est immobile.</p><p id="r-498459" data-claire-element-id="498459">Notez qu'il peut exister des images de sprites de différentes tailles, <a href="medias/uploads.siteduzero.com_files_319001_320000_319011.gif">petites</a> ou <a href="medias/uploads.siteduzero.com_files_324001_325000_324326.png">grandes</a>.</p><p id="r-498460" data-claire-element-id="498460">Avant de passer à la suite, je vous invite à enregistrer notre personnage dans le dossier &quot;sprites&quot; que nous avions créé au début (je l'ai nommé &quot;exemple.png&quot;, mais si vous avez une idée de nom plus original n'hésitez pas :p ).</p><h5 id="r-la-classe-personnage-2" data-claire-element-id="498496">La classe Personnage</h5><p id="r-498462" data-claire-element-id="498462">Nos personnages auront quatre attributs :</p><ul id="r-498471" data-claire-element-id="498471"><li id="r-498464" data-claire-element-id="498464"><p id="r-498463" data-claire-element-id="498463">Un pour l'image du sprite</p></li><li id="r-498466" data-claire-element-id="498466"><p id="r-498465" data-claire-element-id="498465">Deux dans lesquels nous stockerons la taille de chaque partie de l'image (pour la calculer une seule fois dans le constructeur)</p></li><li id="r-498468" data-claire-element-id="498468"><p id="r-498467" data-claire-element-id="498467">Deux pour la position du personnage en x et y</p></li><li id="r-498470" data-claire-element-id="498470"><p id="r-498469" data-claire-element-id="498469">Un pour l'orientation du personnage</p></li></ul><p id="r-498472" data-claire-element-id="498472">C'est ce dernier auquel nous allons nous intéresser. Il va falloir choisir quoi mettre dans notre variable. Plusieurs solutions sont alors possibles, comme stocker des chaînes de caractères ou des objets. Ce serait plus facile à gérer (quoique ...), mais ce serait tout sauf performant.<br/> La solution pour laquelle j'ai opté, c'est d'utiliser des nombres entiers. C'est moins facile à lire pour nous, mais les performances seront meilleures. Seulement, il faut là aussi qu'on choisisse quel entier associer à quelle direction. Nous pourrions nous faciliter la vie en prenant des nombres logiques, allant par exemple dans le sens des aiguilles d'une montre (1 pour le haut, 2 pour la droite ...). Saut qu'à un moment donné, lorsque nous voudrons dessiner notre personnage, il faudra déterminer quelle portion de l'image prendre par rapport à cet attribut. Si nous prenions des entiers comme ceux-là, nous devrions avoir quatre conditions (if, else if, ou switch) pour trouver les coordonnées de cette portion.</p><p id="r-498473" data-claire-element-id="498473">Nous pouvons l'éviter en prenant des nombres ordonnés dans la même logique que le fichier de sprite. Nous aurons donc :</p><ul id="r-498482" data-claire-element-id="498482"><li id="r-498475" data-claire-element-id="498475"><p id="r-498474" data-claire-element-id="498474">0 pour le personnage orienté vers le bas</p></li><li id="r-498477" data-claire-element-id="498477"><p id="r-498476" data-claire-element-id="498476">1 pour le personnage orienté vers la gauche</p></li><li id="r-498479" data-claire-element-id="498479"><p id="r-498478" data-claire-element-id="498478">2 pour le personnage orienté vers la droite</p></li><li id="r-498481" data-claire-element-id="498481"><p id="r-498480" data-claire-element-id="498480">3 pour le personnage orienté vers le haut</p></li></ul><p id="r-498483" data-claire-element-id="498483">Ainsi, nous pourrons déterminer la position de la ligne correspondant à la direction sur l'image en multipliant simplement la hauteur d'une ligne par l'entier représentant la direction du personnage.</p><p id="r-498484" data-claire-element-id="498484">Afin que ce soit plus facile à utiliser, je vous propose de définir des constantes (je les place dans le même fichier que la classe Personnage, mais tout en haut, en dehors de la classe elle-même). <br/> Nous pouvons donc commencer à créer le fichier Personnage.js, dans le dossier js/classes (en pensant bien à l'inclure dans la page html) :</p><pre id="r-498485" data-claire-element-id="498485"><code data-claire-semantic="javascript">var DIRECTION = {
	&quot;BAS&quot;    : 0,
	&quot;GAUCHE&quot; : 1,
	&quot;DROITE&quot; : 2,
	&quot;HAUT&quot;   : 3
}

// Ici se trouvera la classe Personnage</code></pre><p id="r-498486" data-claire-element-id="498486">Étant donné que nous avons tout ce qu'il faut, nous pouvons commencer à mettre en place la classe Personnage elle-même (le constructeur n'ayant pas grand-chose de plus complexe que pour la classe Tileset, je ne vais pas expliquer ce code, notamment pour ce qui est du chargement de l'image) :</p><pre id="r-498487" data-claire-element-id="498487"><code data-claire-semantic="javascript">function Personnage(url, x, y, direction) {
	this.x = x; // (en cases)
	this.y = y; // (en cases)
	this.direction = direction;
	
	// Chargement de l'image dans l'attribut image
	this.image = new Image();
	this.image.referenceDuPerso = this;
	this.image.onload = function() {
		if(!this.complete) 
			throw &quot;Erreur de chargement du sprite nommé \&quot;&quot; + url + &quot;\&quot;.&quot;;
		
		// Taille du personnage
		this.referenceDuPerso.largeur = this.width / 4;
		this.referenceDuPerso.hauteur = this.height / 4;
	}
	this.image.src = &quot;sprites/&quot; + url;
}

Personnage.prototype.dessinerPersonnage = function(context) {
	// Ici se trouvera le code de dessin du personnage
}</code></pre><p id="r-498488" data-claire-element-id="498488">Comme vous le voyez, la méthode dessinerPersonnage n'a besoin que d'un seul paramètre, qui est l'objet context sur lequel il faut dessiner le personnage, car nous avons toutes les données nécessaires pour dessiner notre personnage :</p><pre id="r-498489" data-claire-element-id="498489"><code data-claire-semantic="javascript">context.drawImage(
	this.image, 
	0, this.direction * this.hauteur, // Point d'origine du rectangle source à prendre dans notre image
	this.largeur, this.hauteur, // Taille du rectangle source (c'est la taille du personnage)
	(this.x * 32) - (this.largeur / 2) + 16, (this.y * 32) - this.hauteur + 24, // Point de destination (dépend de la taille du personnage)
	this.largeur, this.hauteur // Taille du rectangle destination (c'est la taille du personnage)
);</code></pre><p id="r-498490" data-claire-element-id="498490">Il y a deux calculs importants dans ce code.</p><ul id="r-498495" data-claire-element-id="498495"><li id="r-498492" data-claire-element-id="498492"><p id="r-498491" data-claire-element-id="498491">Le point x où nous allons dessiner notre personnage. Il faut y soustraire la moitié de la largeur du personnage. Autrement, si le personnage est plus large que la taille d'une case, il apparaîtra à droite de cette case. Il faut également y ajouter 16 (c'est-à-dire la moitié de la largeur d'une case), sinon il sera centré, mais par rapport au côté gauche de la case.</p></li><li id="r-498494" data-claire-element-id="498494"><p id="r-498493" data-claire-element-id="498493">Le point y où nous allons dessiner notre personnage. Il faut y soustraire la hauteur du personnage et y ajouter 24 (les trois quarts de la hauteur d'une case, car si vous observez bien le sprite, il y a toujours une petite marge qu'il faut prendre en compte entre les pieds du personnage et le bas de l'image, mais sinon on aurait pris 32). Autrement, comme la plupart de nos personnages sont plus hauts qu'une case, c'est leur tête qui apparaîtrait au niveau de la case, alors que ce sont leurs pieds qui touchent le sol.</p></li></ul><h5 id="r-integration-basique-des-personnages-dans-la-carte" data-claire-element-id="498512">Intégration basique des personnages dans la carte</h5><p id="r-498497" data-claire-element-id="498497">Il ne nous manque plus qu'un détail pour afficher nos personnages : décider où faire appel à cette méthode de dessin. J'ai choisi d'intégrer dans la classe Map une liste des personnages qu'il faut afficher. Comme plus tard nous aurons des décors, et que ces décors pourront aussi bien être au dessus qu'en dessous des personnages, il est plus simple de le faire comme ça. De plus, comme nous aurons des PNJ (personnages non joueurs : vendeurs, passants ...) qui seront décrits dans le code JSON de chaque map, il est plus simple que ce soit la map qui gère cela.</p><p id="r-498498" data-claire-element-id="498498">Pour le moment, nous allons donc utiliser un simple tableau en attribut pour cela (j'ai mis ce code juste au-dessus des déclarations de méthodes, mais vous pouvez le mettre où vous voulez dans le constructeur) :</p><pre id="r-498499" data-claire-element-id="498499"><code data-claire-semantic="javascript">// Liste des personnages présents sur le terrain.
this.personnages = new Array();</code></pre><p id="r-498500" data-claire-element-id="498500">Il nous faut aussi une méthode pour remplir ce tableau :</p><pre id="r-498501" data-claire-element-id="498501"><code data-claire-semantic="javascript">// Pour ajouter un personnage
Map.prototype.addPersonnage = function(perso) {
	this.personnages.push(perso);
}</code></pre><p id="r-498502" data-claire-element-id="498502">Et enfin, il faut que la méthode de dessin de la map dessine également nos personnages. Pour cela, j'ajoute (temporairement) le code suivant à la suite de la boucle, en bas de la méthode dessinerMap :</p><pre id="r-498503" data-claire-element-id="498503"><code data-claire-semantic="javascript">// Dessin des personnages
for(var i = 0, l = this.personnages.length ; i &lt; l ; i++) {
	this.personnages[i].dessinerPersonnage(context);
}</code></pre><aside id="r-498505" data-claire-element-id="498505" data-claire-semantic="error"><p id="r-498504" data-claire-element-id="498504">Ce code n'est pas du tout optimisé. C'est pour cela qu'il n'est que temporaire. Quand nous passerons aux décors, nous optimiserons cela en structurant mieux la liste des personnages. Pour le moment je ne peux pas expliquer pourquoi sans dévoiler la partie sur la gestion des décors.</p></aside><p id="r-498506" data-claire-element-id="498506">Nous pouvons maintenant tester le dessin de nos personnages. Pour cela, je vais créer quatre personnages, chacun orienté dans une direction précise. Et pour être sûr qu'ils se positionnent aux bons endroits, je vais les placer sur les côtés de la carte, le regard tourné vers le centre. Pour cela, j'ajoute le code suivant au fichier rpg.js, tout en haut du fichier (mais en dessous de la ligne qui instancie la carte) :</p><pre id="r-498507" data-claire-element-id="498507"><code data-claire-semantic="javascript">map.addPersonnage(new Personnage(&quot;exemple.png&quot;, 7, 14, DIRECTION.HAUT));
map.addPersonnage(new Personnage(&quot;exemple.png&quot;, 7, 0, DIRECTION.BAS));
map.addPersonnage(new Personnage(&quot;exemple.png&quot;, 0, 7, DIRECTION.DROITE));
map.addPersonnage(new Personnage(&quot;exemple.png&quot;, 14, 7, DIRECTION.GAUCHE));</code></pre><p id="r-498508" data-claire-element-id="498508">Si tout va bien vous devriez obtenir ceci :</p><figure id="r-498510" data-claire-element-id="498511"><img id="r-498509" data-claire-element-id="498509" src="medias/uploads.siteduzero.com_files_314001_315000_314363.png" alt="Résultat de l'affichage des personnages"/></figure>
<aside class="aside-menu">
<ul class="content-menu" role="navigation">
<li class="tuto">
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas">Créer un mini-RPG en JavaScript avec canvas</a>
</li>
<li class="chapter">
 
<a class="chapterLink" onmouseover="$(this).addClass('box-shadow-summary').next().addClass('box-shadow-summary');" onmouseout="$(this).removeClass('box-shadow-summary').next().removeClass('box-shadow-summary');">
<span>Partie 1</span>
La carte
</a>
<a class="chapterOpen" href="#" onmouseover="$(this).addClass('box-shadow-summary').prev().addClass('box-shadow-summary');" onmouseout="$(this).removeClass('box-shadow-summary').prev().removeClass('box-shadow-summary');">
<span>+</span>
</a>
 
<ul class="subchapters">
<li class="subchapter">
<div>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/mise-en-place-des-bases">Mise en place des bases</a>
<a class="subchapterOpen" href="#">
<span>+</span>
</a>
</div>
<ul class="subchapter-parts">
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/structure-des-fichiers">
Structure des fichiers
</a>
</li>
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/mise-en-place-du-canvas">
Mise en place du canvas
</a>
</li>
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/le-cas-d-internet-explorer">
Le cas d&#039;Internet Explorer
</a>
</li>
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/utilisation-de-l-objet-context">
Utilisation de l&#039;objet context
</a>
</li>
</ul> </li> <li class="subchapter">
<div>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/gestion-des-tilesets">Gestion des tilesets</a>
<a class="subchapterOpen" href="#">
<span>+</span>
</a>
</div>
<ul class="subchapter-parts">
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/presentation-132">
Présentation
</a>
</li>
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/decoupage-et-utilisation">
Découpage et utilisation
</a>
</li>
</ul> </li> <li class="subchapter">
<div>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/mise-en-place-du-terrain">Mise en place du terrain</a>
<a class="subchapterOpen" href="#">
<span>+</span>
</a>
</div>
<ul class="subchapter-parts">
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/format-de-stockage-des-donnees">
Format de stockage des données
</a>
</li>
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/chargement-et-affichage-du-terrain">
Chargement et affichage du terrain
</a>
</li>
</ul> </li></ul> </li>
<li class="chapter">
 
<a class="chapterLink" onmouseover="$(this).addClass('box-shadow-summary').next().addClass('box-shadow-summary');" onmouseout="$(this).removeClass('box-shadow-summary').next().removeClass('box-shadow-summary');">
<span>Partie 2</span>
Les personnages et les décors
</a>
<a class="chapterOpen" href="#" onmouseover="$(this).addClass('box-shadow-summary').prev().addClass('box-shadow-summary');" onmouseout="$(this).removeClass('box-shadow-summary').prev().removeClass('box-shadow-summary');">
<span>+</span>
</a>
 
<ul class="subchapters">
<li class="subchapter">
<div>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/les-personnages-1">Les personnages</a>
<a class="subchapterOpen" href="#">
<span>+</span>
</a>
</div>
<ul class="subchapter-parts">
<li class="active">
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/choix-et-rendu-des-sprites">
Choix et rendu des sprites
</a>
</li>
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/clavier-et-boucle-principale">
Clavier et boucle principale
</a>
</li>
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/animation-des-deplacements">
Animation des déplacements
</a>
</li>
</ul>
</li>
</ul>
</li>
</li>
</ul>
</aside>
</div>
<div id="content-bottom-menu"></div>
<hr/>
<div class="paginate-tuto">
<a class="before" href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/les-personnages-1">
<span class="arrow"></span>
<span class="next">Les personnages</span>
</a>
<a class="after" href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/clavier-et-boucle-principale">
<span class="next">Clavier et boucle principale</span>
<span class="arrow"></span>
</a>
</div>
<hr class="bottom"/>
<div class="clear"></div> <div class="adBan">
<script type='text/javascript'>
    if (window.innerWidth >= 728)
    {
        document.write('<div id="div-gpt-ad-1350977194635-8" class="megaban"></div>');
        googletag.cmd.push(function() {
            googletag.display('div-gpt-ad-1350977194635-8');
        });
    }
            else
        {
            document.write('<div id="div-gpt-ad-1350977284180-8" class="miniban"></div>');
            googletag.cmd.push(function() {
                googletag.display('div-gpt-ad-1350977284180-8');
            });
        }
    </script>
</div>
<div class="clear"></div><a name="Clavieretboucleprincipale"></a><h2>Clavier et boucle principale</h2><div class="paginate-tuto">
<a class="before" href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/choix-et-rendu-des-sprites">
<span class="arrow"></span>
<span class="next">Choix et rendu des sprites</span>
</a>
<a class="after" href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/animation-des-deplacements">
<span class="next">Animation des déplacements</span>
<span class="arrow"></span>
</a>
</div>
<hr class="top"/>
<div class="clear"></div> <div id="content" role="article">
<h4 id="r-clavier-et-boucle-principale" data-claire-element-id="498608">Clavier et boucle principale</h4><h5 id="r-methode-de-deplacement" data-claire-element-id="498526">Méthode de déplacement</h5><p id="r-498514" data-claire-element-id="498514">Maintenant que nous pouvons afficher nos personnages, il fa falloir qu'ils puissent se déplacer. Pour le moment nous allons faire des déplacements très simples, c'est-à-dire que le personnage passera d'une case à l'autre sans animation.</p><p id="r-498515" data-claire-element-id="498515">Pour cela, nous allons avoir une seule méthode, à laquelle il faudra passer deux paramètres :</p><ul id="r-498520" data-claire-element-id="498520"><li id="r-498517" data-claire-element-id="498517"><p id="r-498516" data-claire-element-id="498516">La direction vers laquelle on souhaite aller</p></li><li id="r-498519" data-claire-element-id="498519"><p id="r-498518" data-claire-element-id="498518">La référence de l'objet map. Nous en aurons besoin pour faire plusieurs vérifications. Il faudra en premier lieu savoir si le joueur n'essaye pas d'aller en dehors de la carte, mais plus tard il faudra vérifier qu'il peut aller sur la case en question (est-ce un mur par exemple ?)</p></li></ul><aside id="r-498522" data-claire-element-id="498522" data-claire-semantic="information"><p id="r-498521" data-claire-element-id="498521">Dans tous les cas (que le personnage puisse aller sur la case désirée ou non), il faudra changer la direction du personnage. Entre autres, si le joueur ne comprend pas pourquoi le déplacement ne se fait pas, il saura au moins que l'appui sur la touche a bien été détecté, car le personnage ne regardera plus au même endroit.</p></aside><p id="r-498523" data-claire-element-id="498523">Nous allons avoir besoin de connaître la case où l'on souhaite aller, à partir des coordonnées courantes et de la direction souhaitée. Je vais pour cela créer une méthode, qui prend en paramètre une direction, et qui renvoie un objet contenant deux attributs (x et y), qui sont les coordonnées correspondant à la case située dans la direction donnée par rapport au point actuel du joueur. Cette méthode nous sera utile à plusieurs reprises (et ce sera plus propre car nous aurons obligatoirement besoin de faire plusieurs tests).</p><p id="r-498524" data-claire-element-id="498524">Voici donc nos deux méthodes :</p><pre id="r-498525" data-claire-element-id="498525"><code data-claire-semantic="javascript">Personnage.prototype.getCoordonneesAdjacentes = function(direction)  {
	var coord = {'x' : this.x, 'y' : this.y};
	switch(direction) {
		case DIRECTION.BAS : 
			coord.y++;
			break;
		case DIRECTION.GAUCHE : 
			coord.x--;
			break;
		case DIRECTION.DROITE : 
			coord.x++;
			break;
		case DIRECTION.HAUT : 
			coord.y--;
			break;
	}
	return coord;
}
	
Personnage.prototype.deplacer = function(direction, map) {
	// On change la direction du personnage
	this.direction = direction;
		
	// On vérifie que la case demandée est bien située dans la carte
	var prochaineCase = this.getCoordonneesAdjacentes(direction);
	if(prochaineCase.x &lt; 0 || prochaineCase.y &lt; 0 || prochaineCase.x &gt;= map.getLargeur() || prochaineCase.y &gt;= map.getHauteur()) {
		// On retourne un booléen indiquant que le déplacement ne s'est pas fait, 
		// Ça ne coute pas cher et ca peut toujours servir
		return false;
	}
		
	// On effectue le déplacement
	this.x = prochaineCase.x;
	this.y = prochaineCase.y;
		
	return true;
}</code></pre><h5 id="r-le-clavier-5" data-claire-element-id="498578">Le clavier</h5><p id="r-498527" data-claire-element-id="498527">Nous allons maintenant modifier le fichier rpg.js. Nous allons supprimer nos quatre personnages de test précédents (les quatre appels à la méthode &quot;addPersonnage), pour n'en mettre qu'un seul, qui sera le personnage du joueur :</p><pre id="r-498528" data-claire-element-id="498528"><code data-claire-semantic="javascript">var joueur = new Personnage(&quot;exemple.png&quot;, 7, 14, DIRECTION.BAS);
map.addPersonnage(joueur);</code></pre><p id="r-498529" data-claire-element-id="498529">Nous allons maintenant nous intéresser à la gestion du clavier. Je ne vais pas faire un système &quot;dynamique&quot;, c'est-à-dire que l'association d'une touche avec la fonction qu'elle déclenche sera écrite directement dans le code (mais rien ne vous empêche de faire quelque chose de plus personnalisable, via un menu d'options par exemple).<br/> Nous allons commencer par détecter l'appui sur les touches. Attention ici, afin d'éviter des erreurs éventuelles, on va commencer à détecter l'appui sur une touche uniquement à partir du moment ou la page est totalement chargée.</p><p id="r-498530" data-claire-element-id="498530">Ajoutez donc le code suivant en bas, à l'intérieur de la fonction &quot;windows.onload&quot; :</p><pre id="r-498531" data-claire-element-id="498531"><code data-claire-semantic="javascript">// Gestion du clavier
window.onkeydown = function(event) {
	alert('test');
	return false;
}</code></pre><p id="r-498532" data-claire-element-id="498532">Vous pouvez tester, vous allez voir que dès que vous appuierez sur une touche du clavier, le message &quot;test&quot; apparaîtra.<br/> Ici, j'ai retourné faux, tout simplement pour éviter que le comportement normal de la touche ne soit utilisé. Imaginez que vous ayez des barres de défilement sur votre page : à chaque fois que vous appuierez sur une flèche pour vous déplacer, elles vont bouger avec. En retournant faux, ce comportement ne se produira pas.</p><p id="r-498533" data-claire-element-id="498533">Maintenant, il va falloir identifier les touches pour produire une action en fonction de celle qui a été appuyée.<br/> Pour cela, il faut d'abord récupérer l'objet correspondant à l'événement. Ensuite, il faut récupérer le code de la touche appuyée. Le code est soit dans l'attribut which, soit dans l'attribut keyCode (la plupart du temps keyCode fonctionne, mais sous Firefox par exemple ce n'est pas le cas lorsqu'on appuie sur une lettre) :</p><pre id="r-498534" data-claire-element-id="498534"><code data-claire-semantic="javascript">var e = event || window.event;
var key = e.which || e.keyCode;
alert(key);</code></pre><p id="r-498535" data-claire-element-id="498535">(pensez également à supprimer la ligne d'affichage du message de test, elle ne nous servira plus)</p><p id="r-498536" data-claire-element-id="498536">Maintenant, à chaque appui sur une touche, un nombre correspondant à cette touche s'affichera. Par exemple nous avons :</p><table id="r-498569" data-claire-element-id="498569"><thead id="r-498542" data-claire-element-id="498542"><tr id="r-498541" data-claire-element-id="498541"><th id="r-498538" data-claire-element-id="498538"><p id="r-498537" data-claire-element-id="498537">Touche</p></th><th id="r-498540" data-claire-element-id="498540"><p id="r-498539" data-claire-element-id="498539">Code</p></th></tr></thead><tbody id="r-498568" data-claire-element-id="498568"><tr id="r-498547" data-claire-element-id="498547"><td id="r-498544" data-claire-element-id="498544"><p id="r-498543" data-claire-element-id="498543">Haut</p></td><td id="r-498546" data-claire-element-id="498546"><p id="r-498545" data-claire-element-id="498545">38</p></td></tr><tr id="r-498552" data-claire-element-id="498552"><td id="r-498549" data-claire-element-id="498549"><p id="r-498548" data-claire-element-id="498548">Bas</p></td><td id="r-498551" data-claire-element-id="498551"><p id="r-498550" data-claire-element-id="498550">40</p></td></tr><tr id="r-498557" data-claire-element-id="498557"><td id="r-498554" data-claire-element-id="498554"><p id="r-498553" data-claire-element-id="498553">Gauche</p></td><td id="r-498556" data-claire-element-id="498556"><p id="r-498555" data-claire-element-id="498555">37</p></td></tr><tr id="r-498562" data-claire-element-id="498562"><td id="r-498559" data-claire-element-id="498559"><p id="r-498558" data-claire-element-id="498558">Droite</p></td><td id="r-498561" data-claire-element-id="498561"><p id="r-498560" data-claire-element-id="498560">39</p></td></tr><tr id="r-498567" data-claire-element-id="498567"><td id="r-498564" data-claire-element-id="498564"><p id="r-498563" data-claire-element-id="498563">Entrée</p></td><td id="r-498566" data-claire-element-id="498566"><p id="r-498565" data-claire-element-id="498565">13</p></td></tr></tbody></table><div id="r-498571" data-claire-element-id="498571" data-claire-semantic="question"><p id="r-498570" data-claire-element-id="498570">Et on les trouve où ces codes ?</p></div><p id="r-498572" data-claire-element-id="498572">Je ne connais aucune documentation complète à ce sujet. Pour les trouver, j'utilise un alert, comme dans cet exemple.</p><p id="r-498573" data-claire-element-id="498573">Le reste du travail est assez simple, il suffit de tester le code et de déplacer notre personnage à gauche si le code de la touche est 37, à droite si le code est 39 ... Notez également que j'ai pensé aux joueurs qui préfèrent la combinaison ZQSD ou encore WASD à l'usage des flèches directionnelles ^^ :</p><pre id="r-498574" data-claire-element-id="498574"><code data-claire-semantic="javascript">switch(key) {
	case 38 : case 122 : case 119 : case 90 : case 87 : // Flèche haut, z, w, Z, W
		joueur.deplacer(DIRECTION.HAUT, map);
		break;
	case 40 : case 115 : case 83 : // Flèche bas, s, S
		joueur.deplacer(DIRECTION.BAS, map);
		break;
	case 37 : case 113 : case 97 : case 81 : case 65 : // Flèche gauche, q, a, Q, A
		joueur.deplacer(DIRECTION.GAUCHE, map);
		break;
	case 39 : case 100 : case 68 : // Flèche droite, d, D
		joueur.deplacer(DIRECTION.DROITE, map);
		break;
	default : 
		//alert(key);
		// Si la touche ne nous sert pas, nous n'avons aucune raison de bloquer son comportement normal.
		return true;
}</code></pre><aside id="r-498576" data-claire-element-id="498576" data-claire-semantic="warning"><p id="r-498575" data-claire-element-id="498575">Vous remarquerez que pour chaque lettre, il y a deux codes différents, ce qui veut dire qu'un 'a' minuscule est différent d'un 'A' majuscule.</p></aside><p id="r-498577" data-claire-element-id="498577">Vous pouvez maintenant tester le jeu, appuyez sur les flèches et TADAAAA ... <strong>Ça ne fonctionne pas !</strong></p><h5 id="r-la-boucle-principale-5" data-claire-element-id="498607">La boucle principale</h5><p id="r-498579" data-claire-element-id="498579">Reprenons dans l'ordre les grandes phases de l'exécution de notre jeu :</p><ul id="r-498590" data-claire-element-id="498590"><li id="r-498581" data-claire-element-id="498581"><p id="r-498580" data-claire-element-id="498580">Chargement de la page. Pendant ce temps, on initialise nos objets et on charge nos images.</p></li><li id="r-498583" data-claire-element-id="498583"><p id="r-498582" data-claire-element-id="498582">Fin du chargement de la page</p></li><li id="r-498585" data-claire-element-id="498585"><p id="r-498584" data-claire-element-id="498584">On dessine notre carte</p></li><li id="r-498587" data-claire-element-id="498587"><p id="r-498586" data-claire-element-id="498586">On associe l'événement window.onkeypress à notre fonction de détection</p></li><li id="r-498589" data-claire-element-id="498589"><p id="r-498588" data-claire-element-id="498588">L'utilisateur appuie sur une touche, ce qui modifie ses coordonnées x et y</p></li></ul><p id="r-498591" data-claire-element-id="498591">Vous ne trouvez pas qu'il manque quelque chose après cela ?</p><p id="r-498592" data-claire-element-id="498592">Notre carte n'est pas redessinée après l'appui sur une touche ! Ce qui veut dire que les coordonnées x et y du personnage sont bien modifiées en mémoire, mais qu'on ne peut pas le voir puisque nous n'avons dessiné qu'une seule image, et puis plus rien.</p><p id="r-498593" data-claire-element-id="498593">Nous allons donc utiliser un genre de &quot;boucle principale&quot; (vous avez peut-être déjà entendu parler de ce concept par ailleurs). La boucle principale, c'est une boucle qui tourne en tâche de fond et qui redessine l'écran en permanence pour le garder à jour. Une fois mise en place, il nous suffira donc de modifier les coordonnées du personnage en mémoire pour qu'il soit automatiquement redessiné à sa nouvelle place sur l'écran quelques fractions de secondes plus tard.</p><p id="r-498594" data-claire-element-id="498594">En réalité ici ce n'est pas une boucle que nous allons utiliser. Si nous faisions une boucle infinie en JavaScript, le navigateur resterait bloqué (et stopperait l'exécution du programme au bout d'un moment). Nous allons donc utiliser la fonction setInterval.<br/> Cette fonction prend deux paramètres :</p><ul id="r-498599" data-claire-element-id="498599"><li id="r-498596" data-claire-element-id="498596"><p id="r-498595" data-claire-element-id="498595">Un callback, c'est-à-dire une fonction (ou une chaîne contenant un code à exécuter, ce qui est moins propre et moins performant)</p></li><li id="r-498598" data-claire-element-id="498598"><p id="r-498597" data-claire-element-id="498597">Un nombre en millisecondes</p></li></ul><p id="r-498600" data-claire-element-id="498600">Une fois l'appel à cette fonction effectué, le callback sera automatiquement appelé par JavaScript toutes les n millisecondes, n étant le nombre passé en second paramètre.</p><p id="r-498601" data-claire-element-id="498601">Le premier paramètre sera simple : Il s'agira d'une fonction faisant un appel à la méthode de dessin de notre map.</p><p id="r-498602" data-claire-element-id="498602">Le cerveau humain est capable de discerner entre 20 et 30 images par seconde. Je vais donc régler le second paramètre à 40 millisecondes (1000 / 40 = 25 images par seconde, nous n'avons pas vraiment d'animation pour le moment, donc difficile d'évaluer avec précision ce que ça donnera, mais nous re-règlerons ce chiffre plus tard si l'animation n'est pas assez fluide).</p><p id="r-498603" data-claire-element-id="498603">Remplacez donc la ligne suivante de notre fichier :</p><pre id="r-498604" data-claire-element-id="498604"><code data-claire-semantic="javascript">map.dessinerMap(ctx);</code></pre><p id="r-498605" data-claire-element-id="498605">par ceci :</p><pre id="r-498606" data-claire-element-id="498606"><code data-claire-semantic="javascript">setInterval(function() {
	map.dessinerMap(ctx);
}, 40);</code></pre>
<aside class="aside-menu">
<ul class="content-menu" role="navigation">
<li class="tuto">
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas">Créer un mini-RPG en JavaScript avec canvas</a>
</li>
<li class="chapter">
 
<a class="chapterLink" onmouseover="$(this).addClass('box-shadow-summary').next().addClass('box-shadow-summary');" onmouseout="$(this).removeClass('box-shadow-summary').next().removeClass('box-shadow-summary');">
<span>Partie 1</span>
La carte
</a>
<a class="chapterOpen" href="#" onmouseover="$(this).addClass('box-shadow-summary').prev().addClass('box-shadow-summary');" onmouseout="$(this).removeClass('box-shadow-summary').prev().removeClass('box-shadow-summary');">
<span>+</span>
</a>
 
<ul class="subchapters">
<li class="subchapter">
<div>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/mise-en-place-des-bases">Mise en place des bases</a>
<a class="subchapterOpen" href="#">
<span>+</span>
</a>
</div>
<ul class="subchapter-parts">
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/structure-des-fichiers">
Structure des fichiers
</a>
</li>
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/mise-en-place-du-canvas">
Mise en place du canvas
</a>
</li>
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/le-cas-d-internet-explorer">
Le cas d&#039;Internet Explorer
</a>
</li>
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/utilisation-de-l-objet-context">
Utilisation de l&#039;objet context
</a>
</li>
</ul> </li> <li class="subchapter">
<div>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/gestion-des-tilesets">Gestion des tilesets</a>
<a class="subchapterOpen" href="#">
<span>+</span>
</a>
</div>
<ul class="subchapter-parts">
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/presentation-132">
Présentation
</a>
</li>
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/decoupage-et-utilisation">
Découpage et utilisation
</a>
</li>
</ul> </li> <li class="subchapter">
<div>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/mise-en-place-du-terrain">Mise en place du terrain</a>
<a class="subchapterOpen" href="#">
<span>+</span>
</a>
</div>
<ul class="subchapter-parts">
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/format-de-stockage-des-donnees">
Format de stockage des données
</a>
</li>
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/chargement-et-affichage-du-terrain">
Chargement et affichage du terrain
</a>
</li>
</ul> </li></ul> </li>
<li class="chapter">
 
<a class="chapterLink" onmouseover="$(this).addClass('box-shadow-summary').next().addClass('box-shadow-summary');" onmouseout="$(this).removeClass('box-shadow-summary').next().removeClass('box-shadow-summary');">
<span>Partie 2</span>
Les personnages et les décors
</a>
<a class="chapterOpen" href="#" onmouseover="$(this).addClass('box-shadow-summary').prev().addClass('box-shadow-summary');" onmouseout="$(this).removeClass('box-shadow-summary').prev().removeClass('box-shadow-summary');">
<span>+</span>
</a>
 
<ul class="subchapters">
<li class="subchapter">
<div>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/les-personnages-1">Les personnages</a>
<a class="subchapterOpen" href="#">
<span>+</span>
</a>
</div>
<ul class="subchapter-parts">
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/choix-et-rendu-des-sprites">
Choix et rendu des sprites
</a>
</li>
<li class="active">
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/clavier-et-boucle-principale">
Clavier et boucle principale
</a>
</li>
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/animation-des-deplacements">
Animation des déplacements
</a>
</li>
</ul>
</li>
</ul>
</li>
</li>
</ul>
</aside>
</div>
<div id="content-bottom-menu"></div>
<hr/>
<div class="paginate-tuto">
<a class="before" href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/choix-et-rendu-des-sprites">
<span class="arrow"></span>
<span class="next">Choix et rendu des sprites</span>
</a>
<a class="after" href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/animation-des-deplacements">
<span class="next">Animation des déplacements</span>
<span class="arrow"></span>
</a>
</div>
<hr class="bottom"/>
<div class="clear"></div> <div class="adBan">
<script type='text/javascript'>
    if (window.innerWidth >= 728)
    {
        document.write('<div id="div-gpt-ad-1350977194635-8" class="megaban"></div>');
        googletag.cmd.push(function() {
            googletag.display('div-gpt-ad-1350977194635-8');
        });
    }
            else
        {
            document.write('<div id="div-gpt-ad-1350977284180-8" class="miniban"></div>');
            googletag.cmd.push(function() {
                googletag.display('div-gpt-ad-1350977284180-8');
            });
        }
    </script>
</div>
<div class="clear"></div><a name="Animationdesdplacements"></a><h2>Animation des déplacements</h2><div class="paginate-tuto">
<a class="before" href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/clavier-et-boucle-principale">
<span class="arrow"></span>
<span class="next">Clavier et boucle principale</span>
</a>
</div>
<hr class="top"/>
<div class="clear"></div> <div id="content" role="article">
<h4 id="r-animation-des-deplacements" data-claire-element-id="498695">Animation des déplacements</h4><p id="r-498609" data-claire-element-id="498609">Nous allons maintenant nous attaquer à l'animation des personnages lors de leurs déplacements. Nous n'aurons besoin ici de ne modifier que la classe Personnage.</p><p id="r-498610" data-claire-element-id="498610">La mise en place de l'animation se déroulera en deux parties principales :</p><ul id="r-498615" data-claire-element-id="498615"><li id="r-498612" data-claire-element-id="498612"><p id="r-498611" data-claire-element-id="498611">L'animation elle-même (c'est-à-dire qu'on fera en sorte que durant le déplacement, on voie les jambes du personnage bouger)</p></li><li id="r-498614" data-claire-element-id="498614"><p id="r-498613" data-claire-element-id="498613">La mise en place d'un mouvement fluide (au lieu que le personnage se téléporte d'une case à l'autre, il y passera progressivement).</p></li></ul><h5 id="r-l-animation-elle-meme" data-claire-element-id="498668">L'animation elle-même</h5><p id="r-498616" data-claire-element-id="498616">Nous avons vu que notre fichier de sprite contient, pour chaque direction, quatre images (frames) différentes.<br/> Si on y regarde de plus près, voici l'organisation des frames (de gauche à droite) :</p><ul id="r-498625" data-claire-element-id="498625"><li id="r-498618" data-claire-element-id="498618"><p id="r-498617" data-claire-element-id="498617">La première image est celle où le personnage est immobile</p></li><li id="r-498620" data-claire-element-id="498620"><p id="r-498619" data-claire-element-id="498619">Sur la seconde image, le personnage avance son pied droit</p></li><li id="r-498622" data-claire-element-id="498622"><p id="r-498621" data-claire-element-id="498621">Sur la troisième, il a de nouveau les jambes parallèles (en fait, il s'est avancé sur son pied droit et s'apprête à avancer le gauche pour finir un pas)</p></li><li id="r-498624" data-claire-element-id="498624"><p id="r-498623" data-claire-element-id="498623">Sur la quatrième, il avance le pied gauche</p></li></ul><p id="r-498626" data-claire-element-id="498626">Ce schéma se répète à l'infini, une fois arrivé à la quatrième image, on repart à la première. Le personnage se retrouve donc droit, prêt à faire un autre pas.</p><p id="r-498627" data-claire-element-id="498627">Pour réaliser cette animation, il va nous falloir deux paramètres :</p><ul id="r-498632" data-claire-element-id="498632"><li id="r-498629" data-claire-element-id="498629"><p id="r-498628" data-claire-element-id="498628">Un repère pour mesurer le temps</p></li><li id="r-498631" data-claire-element-id="498631"><p id="r-498630" data-claire-element-id="498630">La durée (dans l'unité choisie) entre deux frames pour réaliser cette animation</p></li></ul><p id="r-498633" data-claire-element-id="498633">Pour le second, c'est assez facile. Nous allons déclarer une constante, à laquelle nous donnerons une valeur initiale. Une fois que l'animation fonctionnera, il nous suffira de modifier cette valeur pour avoir une animation à la bonne vitesse.</p><p id="r-498634" data-claire-element-id="498634">Pour le repère temporel, nous avons deux choix :</p><ul id="r-498639" data-claire-element-id="498639"><li id="r-498636" data-claire-element-id="498636"><p id="r-498635" data-claire-element-id="498635">Utiliser l'heure du système (c'est-à-dire le timestamp)</p></li><li id="r-498638" data-claire-element-id="498638"><p id="r-498637" data-claire-element-id="498637">Compter le nombre de passages dans la boucle principale, c'est-à-dire le nombre de fois qu'on redessine le personnage sur l'écran (qui est régulier).</p></li></ul><p id="r-498640" data-claire-element-id="498640">J'ai choisi la deuxième option pour une raison principale : si nous souhaitons mettre un système de pause dans le jeu (plus tard), il nous sera impossible de mettre aussi l'horloge en pause :p . Nous risquerions donc de rencontrer des décalages dans l'animation après les pauses (ce qui n'est pas un bug primordial, mais autant l'éviter autant que possible).</p><p id="r-498641" data-claire-element-id="498641">Pour la durée de chaque frame de notre animation, il nous faut simplement un entier. On peut donc déclarer cette constante (je la déclare juste après les constantes de direction) :</p><pre id="r-498642" data-claire-element-id="498642"><code data-claire-semantic="javascript">var DUREE_ANIMATION = 4;</code></pre><aside id="r-498644" data-claire-element-id="498644" data-claire-semantic="information"><p id="r-498643" data-claire-element-id="498643">Ici, nous avons une durée de quatre. Cela signifie que chaque fois qu'on aura redessiné quatre fois un personnage en train de bouger, il faudra passer à la frame suivante de l'animation. J'ai choisi ce chiffre en testant cette partie une fois achevée, mais au départ j'avais mis un chiffre bien trop grand (tellement grand que le personnage semblait immobile :D ).</p></aside><p id="r-498645" data-claire-element-id="498645">Nous allons avoir besoin de certaines informations pour gérer cette animation au niveau du personnage :</p><ul id="r-498650" data-claire-element-id="498650"><li id="r-498647" data-claire-element-id="498647"><p id="r-498646" data-claire-element-id="498646">L'état du personnage, c'est-à-dire si le personnage est immobile ou non</p></li><li id="r-498649" data-claire-element-id="498649"><p id="r-498648" data-claire-element-id="498648">Si le personnage est en mouvement, le nombre de passages effectué par la boucle principale, afin d'afficher la bonne image.</p></li></ul><p id="r-498651" data-claire-element-id="498651">Je vais combiner ça en un seul attribut, qui contiendra :</p><ul id="r-498656" data-claire-element-id="498656"><li id="r-498653" data-claire-element-id="498653"><p id="r-498652" data-claire-element-id="498652">Un nombre négatif si le personnage est immobile (Nous utiliserons -1, mais il vaut mieux tester s'il est négatif plutôt que de vérifier s'il est exactement égal à -1. Ainsi, l'attribut peut être potentiellement réutilisable pour stocker des informations concernant l'animation).</p></li><li id="r-498655" data-claire-element-id="498655"><p id="r-498654" data-claire-element-id="498654">Un nombre positif ou nul si le personnage est en mouvement. Dans ce cas, ce nombre est le nombre de passages effectués dans la boucle principale.</p></li></ul><p id="r-498657" data-claire-element-id="498657">Nous pouvons donc initialiser notre attribut à -1, pour que le personnage soit immobile quand il apparaît dans le jeu :</p><pre id="r-498658" data-claire-element-id="498658"><code data-claire-semantic="javascript">this.etatAnimation = -1;</code></pre><p id="r-498659" data-claire-element-id="498659">Au moment où le personnage commencera à se déplacer, il faudra démarrer l'animation, et donc mettre cet attribut à 1 (on pourrait aussi le mettre à 0, mais cela décale l'animation d'une frame et provoque un court arrêt de l'animation entre deux cases). Ajoutez donc ce code dans la méthode &quot;deplacer&quot;, juste avant les deux lignes où les attributs x et y sont modifiés :</p><pre id="r-498660" data-claire-element-id="498660"><code data-claire-semantic="javascript">// On commence l'animation
this.etatAnimation = 1;</code></pre><aside id="r-498662" data-claire-element-id="498662" data-claire-semantic="warning"><p id="r-498661" data-claire-element-id="498661">Ce que nous sommes en train de mettre en place est étroitement lié avec la mise en place d'un mouvement plus fluide. Nous allons donc avoir une animation qui - pour le moment - ne s'arrêtera jamais à partir du moment où un premier déplacement a été effectué.</p></aside><p id="r-498663" data-claire-element-id="498663">Ensuite, il faut calculer l'image à afficher en fonction de l'animation courante. Modifiez donc la méthode &quot;dessinerPersonnage&quot;, et ajoutez ceci au début :</p><pre id="r-498664" data-claire-element-id="498664"><code data-claire-semantic="javascript">var frame = 0;
if(this.etatAnimation &gt;= 0) {
	frame = Math.floor(this.etatAnimation / DUREE_ANIMATION);
	if(frame &gt; 3) {
		frame %= 4;
	}
	this.etatAnimation++;
}</code></pre><p id="r-498665" data-claire-element-id="498665">Par défaut, nous prenons donc l'image immobile, c'est-à-dire l'image 0 (il y a quatre images dans notre animation, que l'on compte de 0 à 3). Si l'animation est commencée, on calcule la bonne image à afficher (on compte le nombre total de &quot;pas&quot; effectués dans l'animation, c'est-dire le nombre de fois où l'on a changé d'image. Si le nombre est supérieur à trois (qui est le numéro correspondant à la dernière image de l'animation), l'image à prendre est ce nombre modulo quatre (le reste de la division de ce nombre par le nombre d'images dans l'animation).</p><p id="r-498666" data-claire-element-id="498666">Il ne nous reste plus qu'à utiliser ce nombre. Dans l'appel à la méthode &quot;drawImage&quot; de l'objet context, nous avions mis un paramètre à 0. Il nous suffit de le remplacer par le numéro de l'image que nous venons de calculer, multiplié par la largeur du personnage :</p><pre id="r-498667" data-claire-element-id="498667"><code data-claire-semantic="javascript">this.largeur * frame</code></pre><h5 id="r-mise-en-place-d-un-mouvement-fluide" data-claire-element-id="498694">Mise en place d'un mouvement fluide</h5><p id="r-498669" data-claire-element-id="498669">Pour que le déplacement se fasse de manière fluide, et pas par &quot;téléportation&quot;, il nous faut tout d'abord définir une vitesse de déplacement. Ce nombre nous indiquera combien de passages par la boucle principale seront nécessaires pour que le personnage passe d'une case à l'autre (les deux cases étant adjacentes). Je vais donc définir une constante, juste à côté de celle que nous avons déclarée pour l'animation :</p><pre id="r-498670" data-claire-element-id="498670"><code data-claire-semantic="javascript">var DUREE_DEPLACEMENT = 15;</code></pre><p id="r-498671" data-claire-element-id="498671">Maintenant il faut définir un point important : lorsque le personnage se trouve entre deux cases, quelles sont ses coordonnées ?</p><ul id="r-498676" data-claire-element-id="498676"><li id="r-498673" data-claire-element-id="498673"><p id="r-498672" data-claire-element-id="498672">Soit les coordonnées qu'il avait avant de se déplacer</p></li><li id="r-498675" data-claire-element-id="498675"><p id="r-498674" data-claire-element-id="498674">Soit ses nouvelles coordonnées (on anticipe donc le déplacement)</p></li></ul><p id="r-498677" data-claire-element-id="498677">J'ai choisi le deuxième cas pour que nous n'ayons pas de problèmes &quot;d'accès concurrents&quot; à l'avenir. Je m'explique : si nous avons un autre personnage à l'écran qui souhaite aller sur la même case que nous et que durant le déplacement nous sommes toujours (en mémoire) sur la case précédente, l'autre pourra venir sur cette case, et nous serons alors deux sur une même case. Or, dans un prochain chapitre (sur les obstacles), nous ferons en sorte qu'il ne puisse y avoir qu'un seul personnage par case !<br/> De même, si on prend un peu le problème à l'envers, si un personnage souhaite aller sur la case dans laquelle nous nous trouvions avant le déplacement alors que nous sommes entre deux cases, il devra attendre que nous ayons terminé le déplacement dans le premier cas. Dans le deuxième cas, il pourra commencer son déplacement sans problème.</p><p id="r-498678" data-claire-element-id="498678">À partir du temps total nécessaire à un déplacement, et du temps passé depuis le début du déplacement (que nous avons déjà dans l'attribut &quot;etatAnimation&quot;), nous allons - à chaque dessin - pouvoir calculer quelle proportion (pourcentage) du déplacement a été effectuée (nous obtiendrons un nombre décimal entre 0 et 1) pour passer d'une case à l'autre. En multipliant ce chiffre par 32 (qui est la taille d'une case), nous obtiendrons le nombre de pixels de &quot;décalage&quot; à appliquer (c'est-à-dire à ajouter ou soustraire en fonction de la direction) à la position du personnage en pixels.</p><p id="r-498679" data-claire-element-id="498679">La première chose à laquelle il faut penser (car on l'oublie souvent, ce qui provoque des choses assez étranges, vous n'aurez qu'à commenter ce bloc quand nous aurons terminé, et vous verrez ;) ), c'est d'empêcher le personnage de se déplacer tant qu'il y a déjà un déplacement en cours. Pour cela, il nous suffit d'ajouter la ligne suivante au début de la fonction &quot;deplacer&quot; :</p><pre id="r-498680" data-claire-element-id="498680"><code data-claire-semantic="javascript">// On ne peut pas se déplacer si un mouvement est déjà en cours !
if(this.etatAnimation &gt;= 0) {
	return false;
}</code></pre><p id="r-498681" data-claire-element-id="498681">Pour l'autre partie du code (que j'ai déjà décrit dans les grandes lignes), je vais vous donner directement le bloc de code (commenté) à remplacer (les modifications seraient un peu complexes à détailler ligne par ligne). Dans la fonction dessinerPersonnage, remplacez le code suivant (que nous avons défini juste avant) :</p><pre id="r-498682" data-claire-element-id="498682"><code data-claire-semantic="javascript">var frame = 0;
if(this.etatAnimation &gt;= 0) {
	frame = Math.floor(this.etatAnimation / DUREE_ANIMATION);
	if(frame &gt; 3) {
		frame %= 4;
	}
	this.etatAnimation++;
}</code></pre><p id="r-498683" data-claire-element-id="498683">par ceci :</p><pre id="r-498684" data-claire-element-id="498684"><code data-claire-semantic="javascript">var frame = 0; // Numéro de l'image à prendre pour l'animation
var decalageX = 0, decalageY = 0; // Décalage à appliquer à la position du personnage
if(this.etatAnimation &gt;= DUREE_DEPLACEMENT) {
	// Si le déplacement a atteint ou dépassé le temps nécessaire pour s'effectuer, on le termine
	this.etatAnimation = -1;
} else if(this.etatAnimation &gt;= 0) {
	// On calcule l'image (frame) de l'animation à afficher
	frame = Math.floor(this.etatAnimation / DUREE_ANIMATION);
	if(frame &gt; 3) {
		frame %= 4;
	}
	
	// Nombre de pixels restant à parcourir entre les deux cases
	var pixelsAParcourir = 32 - (32 * (this.etatAnimation / DUREE_DEPLACEMENT));
	
	// À partir de ce nombre, on définit le décalage en x et y.
	// NOTE : Si vous connaissez une manière plus élégante que ces quatre conditions, je suis preneur
	if(this.direction == DIRECTION.HAUT) {
		decalageY = pixelsAParcourir;
	} else if(this.direction == DIRECTION.BAS) {
		decalageY = -pixelsAParcourir;
	} else if(this.direction == DIRECTION.GAUCHE) {
		decalageX = pixelsAParcourir;
	} else if(this.direction == DIRECTION.DROITE) {
		decalageX = -pixelsAParcourir;
	}
	
	this.etatAnimation++;
}
/*
 * Si aucune des deux conditions n'est vraie, c'est qu'on est immobile, 
 * donc il nous suffit de garder les valeurs 0 pour les variables 
 * frame, decalageX et decalageY
 */</code></pre><p id="r-498685" data-claire-element-id="498685">Il ne nous reste plus qu'à additionner nos variables decalageX et decalageY aux paramètres passés à la méthode drawImage. Ce qui nous donne ceci pour les 6ème et 7ème paramètres :</p><pre id="r-498686" data-claire-element-id="498686"><code data-claire-semantic="javascript">// Point de destination (dépend de la taille du personnage)
(this.x * 32) - (this.largeur / 2) + 16 + decalageX, (this.y * 32) - this.hauteur + 24 + decalageY,</code></pre><p id="r-498687" data-claire-element-id="498687">Et voilà, si vous avez bien suivi les étapes, vous devriez pouvoir vous déplacer librement dans le jeu, ce qui devrait donner quelque chose comme ceci (ce gif est beaucoup moins beau et fluide que dans la réalité) :</p><figure id="r-498689" data-claire-element-id="498690"><img id="r-498688" data-claire-element-id="498688" src="medias/uploads.siteduzero.com_files_319001_320000_319011.gif" alt="Fin de la mise en place des personnages !"/></figure><aside id="r-498692" data-claire-element-id="498692" data-claire-semantic="information"><p id="r-498691" data-claire-element-id="498691">Vous pouvez télécharger le code source de cette partie <a href="http://sebastien-caparros.name/tuto_sdz/Partie2_persos.zip">ici</a>, ou bien le tester <a href="http://sebastien-caparros.name/tuto_sdz/Partie2_persos/">ici</a>.</p></aside><p id="r-498693" data-claire-element-id="498693">Nous sommes maintenant capables d'afficher une carte de n'importe quelle taille sur l'écran, ainsi que des personnages. Bien sûr notre jeu est loin d'être complet, mais ce premier résultat n'est-il pas satisfaisant ?</p>
<aside class="aside-menu">
<ul class="content-menu" role="navigation">
<li class="tuto">
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas">Créer un mini-RPG en JavaScript avec canvas</a>
</li>
<li class="chapter">
 
<a class="chapterLink" onmouseover="$(this).addClass('box-shadow-summary').next().addClass('box-shadow-summary');" onmouseout="$(this).removeClass('box-shadow-summary').next().removeClass('box-shadow-summary');">
<span>Partie 1</span>
La carte
</a>
<a class="chapterOpen" href="#" onmouseover="$(this).addClass('box-shadow-summary').prev().addClass('box-shadow-summary');" onmouseout="$(this).removeClass('box-shadow-summary').prev().removeClass('box-shadow-summary');">
<span>+</span>
</a>
 
<ul class="subchapters">
<li class="subchapter">
<div>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/mise-en-place-des-bases">Mise en place des bases</a>
<a class="subchapterOpen" href="#">
<span>+</span>
</a>
</div>
<ul class="subchapter-parts">
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/structure-des-fichiers">
Structure des fichiers
</a>
</li>
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/mise-en-place-du-canvas">
Mise en place du canvas
</a>
</li>
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/le-cas-d-internet-explorer">
Le cas d&#039;Internet Explorer
</a>
</li>
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/utilisation-de-l-objet-context">
Utilisation de l&#039;objet context
</a>
</li>
</ul> </li> <li class="subchapter">
<div>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/gestion-des-tilesets">Gestion des tilesets</a>
<a class="subchapterOpen" href="#">
<span>+</span>
</a>
</div>
<ul class="subchapter-parts">
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/presentation-132">
Présentation
</a>
</li>
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/decoupage-et-utilisation">
Découpage et utilisation
</a>
</li>
</ul> </li> <li class="subchapter">
<div>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/mise-en-place-du-terrain">Mise en place du terrain</a>
<a class="subchapterOpen" href="#">
<span>+</span>
</a>
</div>
<ul class="subchapter-parts">
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/format-de-stockage-des-donnees">
Format de stockage des données
</a>
</li>
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/chargement-et-affichage-du-terrain">
Chargement et affichage du terrain
</a>
</li>
</ul> </li></ul> </li>
<li class="chapter">
 
<a class="chapterLink" onmouseover="$(this).addClass('box-shadow-summary').next().addClass('box-shadow-summary');" onmouseout="$(this).removeClass('box-shadow-summary').next().removeClass('box-shadow-summary');">
<span>Partie 2</span>
Les personnages et les décors
</a>
<a class="chapterOpen" href="#" onmouseover="$(this).addClass('box-shadow-summary').prev().addClass('box-shadow-summary');" onmouseout="$(this).removeClass('box-shadow-summary').prev().removeClass('box-shadow-summary');">
<span>+</span>
</a>
 
<ul class="subchapters">
<li class="subchapter">
<div>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/les-personnages-1">Les personnages</a>
<a class="subchapterOpen" href="#">
<span>+</span>
</a>
</div>
<ul class="subchapter-parts">
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/choix-et-rendu-des-sprites">
Choix et rendu des sprites
</a>
</li>
<li>
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/clavier-et-boucle-principale">
Clavier et boucle principale
</a>
</li>
<li class="active">
<a href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/animation-des-deplacements">
Animation des déplacements
</a>
</li>
</ul>
</li>
</ul>
</li>
</li>
</ul>
</aside>
</div>
<div id="content-bottom-menu"></div>
<hr/>
<div class="paginate-tuto">
<a class="before" href="http://62.4.17.167/informatique/tutoriels/creer-un-mini-rpg-en-javascript-avec-canvas/clavier-et-boucle-principale">
<span class="arrow"></span>
<span class="next">Clavier et boucle principale</span>
</a>
</div>
<hr class="bottom"/>
<div class="clear"></div> <div class="adBan">
<script type='text/javascript'>
    if (window.innerWidth >= 728)
    {
        document.write('<div id="div-gpt-ad-1350977194635-8" class="megaban"></div>');
        googletag.cmd.push(function() {
            googletag.display('div-gpt-ad-1350977194635-8');
        });
    }
            else
        {
            document.write('<div id="div-gpt-ad-1350977284180-8" class="miniban"></div>');
            googletag.cmd.push(function() {
                googletag.display('div-gpt-ad-1350977284180-8');
            });
        }
    </script>
</div>
<div class="clear"></div>
</body>
<!-- Mirrored from 62.4.17.167/sdz/sdz/creer-un-mini-rpg-en-javascript-avec-canvas.html by HTTrack Website Copier/3.x [XR&CO'2013], Sun, 27 Oct 2013 01:53:11 GMT -->

<!-- Mirrored from sdz.tdct.org/sdz/creer-un-mini-rpg-en-javascript-avec-canvas.html by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 30 Nov 2015 04:29:51 GMT -->
</html>
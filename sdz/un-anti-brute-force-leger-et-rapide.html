<html>

<!-- Mirrored from 62.4.17.167/sdz/sdz/un-anti-brute-force-leger-et-rapide.html by HTTrack Website Copier/3.x [XR&CO'2013], Sun, 27 Oct 2013 06:36:45 GMT -->

<!-- Mirrored from sdz.tdct.org/sdz/un-anti-brute-force-leger-et-rapide.html by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 30 Nov 2015 05:10:56 GMT -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Tutoriel : Un anti brute-force léger et rapide</title>
<link href="medias/sdz_main.css" type="text/css" rel="stylesheet" media="all"/>
</head>
        <body>
<a href="../www.siteduzero.com/informatique/tutoriels/un-anti-brute-force-leger-et-rapide.html" class="version_en_ligne">Version en ligne</a>
<h1>Tutoriel : Un anti brute-force léger et rapide</h1>
<h2>Table des matières</h2><div class="table_des_matieres"><a href="#Unantibrute-forcelgeretrapide">Un anti brute-force léger et rapide</a><br/><a href="#Est-cebienutile">Est-ce bien utile ?</a><br/><a href="#Principedebase">Principe de base</a><br/><a href="#vosclaviersc039estparti">À vos claviers, c&#039;est parti</a><br/><a href="#Ajoutd039unsystmedenotification">Ajout d&#039;un systéme de notification</a><br/></div>
<a name="Unantibrute-forcelgeretrapide"></a><h2>Un anti brute-force léger et rapide</h2><div class="paginate-tuto">
<a class="after" href="http://62.4.17.167/informatique/tutoriels/un-anti-brute-force-leger-et-rapide/est-ce-bien-utile">
<span class="next">Est-ce bien utile ?</span>
<span class="arrow"></span>
</a>
</div>
<hr class="top"/>
<div class="clear"></div> <div class="content">
<p id="r-565770" data-claire-element-id="565770">Vous avez sécurisé votre site au maximum, exterminé les failles, protégé vos pages... mais la menace de la force brute pèse sur vous ? :euh:</p><p id="r-565771" data-claire-element-id="565771">La <em>force brute</em> consiste à tester à l'aide d'un script des tas de mots de passe dans vos formulaires, pour accéder à votre administration par exemple (ce qui est plutôt désagréable, je vous l'accorde).</p><p id="r-565772" data-claire-element-id="565772">Mettre en place un anti brute-force en utilisant la base de données est la solution la plus souvent envisagée sur les forums du Site du Zér0. Cela fonctionne parfaitement, mais c'est gourmand (une requête pour chaque identification ratée, sans compter les vérifications par la suite o_O ).</p><p id="r-565773" data-claire-element-id="565773">Dans ce tutoriel, nous allons nous pencher sur une solution plus rapide et qui ne demandera pas l'intervention d'une base de données : un anti brute-force qui fonctionne grâce à des fichiers.</p>
</div><a name="Est-cebienutile"></a><h2>Est-ce bien utile ?</h2><div class="paginate-tuto">
<a class="after" href="http://62.4.17.167/informatique/tutoriels/un-anti-brute-force-leger-et-rapide/principe-de-base-5">
<span class="next">Principe de base</span>
<span class="arrow"></span>
</a>
</div>
<hr class="top"/>
<div class="clear"></div> <div id="content" role="article">
<div id="r-565775" data-claire-element-id="565775" data-claire-semantic="question"><p id="r-565774" data-claire-element-id="565774">Mais, comment peut-on contrer une attaque de ce genre ?</p></div><p id="r-565776" data-claire-element-id="565776">C'est très simple : le pirate va essayer plein de mots de passe, mais vraiment beaucoup, car on ne trouve pas un mot de passe aussi facilement.</p><p id="r-565777" data-claire-element-id="565777">Le script du pirate va essayer des centaines de mots de passe formés, soit aléatoirement, soit piochés dans une liste qu'il aura téléchargé ou préétabli. On appelle cette seconde option une attaque par dictionnaire.</p><div id="r-565779" data-claire-element-id="565779" data-claire-semantic="question"><p id="r-565778" data-claire-element-id="565778">Mais alors, si c'est aussi compliqué et long pour trouver un mot de passe, à quoi ça sert de s'embêter avec un système de protection ? o_O</p></div><p id="r-565780" data-claire-element-id="565780">C'est vrai, certains développeurs vous diront qu'il est inutile de mettre en place ce genre de protection, car, en théorie, il est très difficile de trouver un mot de passe complexe.</p><p id="r-565781" data-claire-element-id="565781">Certes, un pirate mettrait des mois à trouver un mot de passe complexe comme celui-ci : 4gf/ki-2KL@[23]. Mais qu'en est-il des mots de passe de vos membres ?</p><p id="r-565782" data-claire-element-id="565782">Il y a peu de chances de voir des membres utiliser ce genre de mot de passe ; certains mettront certainement des mots de passe basiques comme un prénom ou le nom de leur héros préféré. Et là, une attaque par dictionnaire le trouvera en peu de temps. Un pirate pourra alors s'amuser avec le compte d'un de vos membres et, croyez-moi, c'est sur vous et sur la réputation du site que ça retombera.</p><p id="r-565783" data-claire-element-id="565783">Une des solutions consiste simplement à forcer les gens à entrer un mot de passe très complexe lors de leur inscription. Cette solution n'est pas forcement celle à adopter : moins les visiteurs auront d'obstacles lors de leur inscription et de leur navigation, et meilleure sera le souvenir qu'ils garderont de votre site web.</p>
<aside class="aside-menu">
<ul class="content-menu subchapter" role="navigation">
<li class="tuto">
<a href="http://62.4.17.167/informatique/tutoriels/un-anti-brute-force-leger-et-rapide">Un anti brute-force léger et rapide</a>
</li>
<ul class="subchapter-parts">
<li class="active">
<a href="http://62.4.17.167/informatique/tutoriels/un-anti-brute-force-leger-et-rapide/est-ce-bien-utile">
Est-ce bien utile ?
</a>
</li>
<li>
<a href="http://62.4.17.167/informatique/tutoriels/un-anti-brute-force-leger-et-rapide/principe-de-base-5">
Principe de base
</a>
</li>
<li>
<a href="http://62.4.17.167/informatique/tutoriels/un-anti-brute-force-leger-et-rapide/a-vos-claviers-c-est-parti">
À vos claviers, c&#039;est parti
</a>
</li>
<li>
<a href="http://62.4.17.167/informatique/tutoriels/un-anti-brute-force-leger-et-rapide/ajout-d-un-systeme-de-notification">
Ajout d&#039;un systéme de notification
</a>
</li>
</ul>
</ul>
</aside>
</div>
<div id="content-bottom-menu"></div>
<hr/>
<div class="paginate-tuto">
<a class="after" href="http://62.4.17.167/informatique/tutoriels/un-anti-brute-force-leger-et-rapide/principe-de-base-5">
<span class="next">Principe de base</span>
<span class="arrow"></span>
</a>
</div>
<hr class="bottom"/>
<div class="clear"></div> <div class="adBan">
<script type='text/javascript'>
    if (window.innerWidth >= 728)
    {
        document.write('<div id="div-gpt-ad-1350977194635-8" class="megaban"></div>');
        googletag.cmd.push(function() {
            googletag.display('div-gpt-ad-1350977194635-8');
        });
    }
            else
        {
            document.write('<div id="div-gpt-ad-1350977284180-8" class="miniban"></div>');
            googletag.cmd.push(function() {
                googletag.display('div-gpt-ad-1350977284180-8');
            });
        }
    </script>
</div>
<div class="clear"></div><a name="Principedebase"></a><h2>Principe de base</h2><div class="paginate-tuto">
<a class="before" href="http://62.4.17.167/informatique/tutoriels/un-anti-brute-force-leger-et-rapide/est-ce-bien-utile">
<span class="arrow"></span>
<span class="next">Est-ce bien utile ?</span>
</a>
<a class="after" href="http://62.4.17.167/informatique/tutoriels/un-anti-brute-force-leger-et-rapide/a-vos-claviers-c-est-parti">
<span class="next">À vos claviers, c&#039;est parti</span>
<span class="arrow"></span>
</a>
</div>
<hr class="top"/>
<div class="clear"></div> <div id="content" role="article">
<p id="r-565785" data-claire-element-id="565785">Ici, on ne va pas utiliser de base de données pour notre script (trop lent et trop gourmand pour cette utilisation) mais des fichiers.</p><div id="r-565787" data-claire-element-id="565787" data-claire-semantic="question"><p id="r-565786" data-claire-element-id="565786">Oh, mais tu oublies les sessions et les cookies !</p></div><p id="r-565788" data-claire-element-id="565788">Non, je ne les ai pas oubliés ; c'est en effet une solution. Néanmoins, il y a un petit souci avec eux : il suffit de vider ses cookies pour pouvoir recommencer à essayer des mots de passe. De plus, vous allez voir qu'utiliser des fichiers n'est pas plus difficile !</p><p id="r-565789" data-claire-element-id="565789">Le principe est simple : si quelqu'un tente de s'identifier avec un mauvais mot de passe, on crée un fichier nommé <em>pseudodumembre.tmp</em> qui contiendra la date du jour et le nombre de tentatives.<br/> Et c'est tout, ce sont les seules informations dont on aura besoin.</p><p id="r-565790" data-claire-element-id="565790">À chaque fois qu'une personne tentera de s'identifier, il suffira de regarder si un fichier ayant comme nom son pseudo existe. S'il a atteint le quota de mauvais mots de passe journalier, on bloque l'identification.</p>
<aside class="aside-menu">
<ul class="content-menu subchapter" role="navigation">
<li class="tuto">
<a href="http://62.4.17.167/informatique/tutoriels/un-anti-brute-force-leger-et-rapide">Un anti brute-force léger et rapide</a>
</li>
<ul class="subchapter-parts">
<li>
<a href="http://62.4.17.167/informatique/tutoriels/un-anti-brute-force-leger-et-rapide/est-ce-bien-utile">
Est-ce bien utile ?
</a>
</li>
<li class="active">
<a href="http://62.4.17.167/informatique/tutoriels/un-anti-brute-force-leger-et-rapide/principe-de-base-5">
Principe de base
</a>
</li>
<li>
<a href="http://62.4.17.167/informatique/tutoriels/un-anti-brute-force-leger-et-rapide/a-vos-claviers-c-est-parti">
À vos claviers, c&#039;est parti
</a>
</li>
<li>
<a href="http://62.4.17.167/informatique/tutoriels/un-anti-brute-force-leger-et-rapide/ajout-d-un-systeme-de-notification">
Ajout d&#039;un systéme de notification
</a>
</li>
</ul>
</ul>
</aside>
</div>
<div id="content-bottom-menu"></div>
<hr/>
<div class="paginate-tuto">
<a class="before" href="http://62.4.17.167/informatique/tutoriels/un-anti-brute-force-leger-et-rapide/est-ce-bien-utile">
<span class="arrow"></span>
<span class="next">Est-ce bien utile ?</span>
</a>
<a class="after" href="http://62.4.17.167/informatique/tutoriels/un-anti-brute-force-leger-et-rapide/a-vos-claviers-c-est-parti">
<span class="next">À vos claviers, c&#039;est parti</span>
<span class="arrow"></span>
</a>
</div>
<hr class="bottom"/>
<div class="clear"></div> <div class="adBan">
<script type='text/javascript'>
    if (window.innerWidth >= 728)
    {
        document.write('<div id="div-gpt-ad-1350977194635-8" class="megaban"></div>');
        googletag.cmd.push(function() {
            googletag.display('div-gpt-ad-1350977194635-8');
        });
    }
            else
        {
            document.write('<div id="div-gpt-ad-1350977284180-8" class="miniban"></div>');
            googletag.cmd.push(function() {
                googletag.display('div-gpt-ad-1350977284180-8');
            });
        }
    </script>
</div>
<div class="clear"></div><a name="vosclaviersc039estparti"></a><h2>À vos claviers, c&#039;est parti</h2><div class="paginate-tuto">
<a class="before" href="http://62.4.17.167/informatique/tutoriels/un-anti-brute-force-leger-et-rapide/principe-de-base-5">
<span class="arrow"></span>
<span class="next">Principe de base</span>
</a>
<a class="after" href="http://62.4.17.167/informatique/tutoriels/un-anti-brute-force-leger-et-rapide/ajout-d-un-systeme-de-notification">
<span class="next">Ajout d&#039;un systéme de notification</span>
<span class="arrow"></span>
</a>
</div>
<hr class="top"/>
<div class="clear"></div> <div id="content" role="article">
<p id="r-565792" data-claire-element-id="565792">Pour pouvoir appliquer ce tutoriel, vous devez connaître les bases de la gestion de fichiers en PHP.</p><p id="r-565793" data-claire-element-id="565793">Commençons par le plus simple : la création du dossier qui contiendra tous les fichiers générés par le script anti brute-force. Vous pouvez créer le dossier où vous le souhaitez et le nommer à votre goût. Le tutoriel sera basé sur un dossier antibrute placé à la racine du site (si vous êtes sous linux, pensez à chmoder le dossier en 777).</p><p id="r-565794" data-claire-element-id="565794">C'est fait ? Parfait, on peut continuer ! :)</p><p id="r-565795" data-claire-element-id="565795">Voici le script d'identification (<em>ultra-simplifié</em>) sur lequel nous allons nous baser pour créer l'anti brute-force. Évidemment celui-ci est une pure invention, vous pouvez appliquer ce tutoriel sur vos propres scripts.</p><pre id="r-565796" data-claire-element-id="565796"><code data-claire-semantic="html+php">&lt;?php

// Si on tente de s'identifier
if(!empty($_POST['pseudo']) AND !empty($_POST['motdepasse']))
{


$verifications = mysql_query('SELECT pseudo, motdepasse FROM membres WHERE pseudo = \''.mysql_real_escape_string($_POST['pseudo']).'\' ');

$data_verif = mysql_fetch_assoc($verifications);


    // Si le pseudo existe bien
    if(!empty($data_verif['pseudo']))
    {

       // Si le mot de passe est bon
       if($data_verif['motdepasse'] == trim($_POST['motdepasse']))
       {
           //------------------------------------------------
           // Ici Votre script qui identifie le membre
           //------------------------------------------------
       }
       // Si le mot de passe est faux
       else
       {
           echo 'Mot de passe incorrect';
       }

    }
    // Si le pseudo n'existe pas
    else
    {
        echo 'Pseudonyme incorrect';
    }

}

?&gt;</code></pre><p id="r-565797" data-claire-element-id="565797">Jusque là, normalement, ça vous est tout à fait familier. Commençons les choses sérieuses.</p><p id="r-565798" data-claire-element-id="565798">Avant tout, on va vérifier l'existence d'un fichier indiquant des tentatives d'identification.<br/> Si on trouve un fichier créé dans la journée, on récupère les informations qu'il contient ; on saura alors combien de tentatives il reste au visiteur en question.</p><p id="r-565799" data-claire-element-id="565799">On commence par regarder si le fichier existe grâce à la fonction file_exists().</p><p id="r-565800" data-claire-element-id="565800">Si la réponse est positive, on ouvre le fichier avec fopen() puis on récupère le contenu du fichier dans une variable avec fgets().</p><p id="r-565801" data-claire-element-id="565801">Il faut aussi que l'on fasse en sorte que le fichier soit créé s'il n'existe pas encore, ou mis à jour si la date est dépassée. Pour cela, on va donner naissance à une variable $existence_ft en cas de retour négatif de la fonction file_exists() ou de mauvaise date.</p><div id="r-565803" data-claire-element-id="565803" data-claire-semantic="question"><p id="r-565802" data-claire-element-id="565802">Mais pourquoi ne pas créer / mettre à jour le fichier tout de suite au lieu de créer cette variable ?</p></div><p id="r-565804" data-claire-element-id="565804">Si on créait le fichier tout de suite, il faudrait forcement le faire en se basant sur le pseudonyme entré dans le formulaire par le pirate. On se retrouverait donc avec un fichier par pseudo même s'il n'existe pas ; le pirate pourrait alors faire planter le serveur en essayant des milliers de pseudos bidons ! On créera donc le fichier uniquement si le pseudonyme existe dans la base de données. Comme cela, il y aura un maximum d'un fichier par membre. D'où l'utilité de cette variable dont on vérifiera l'existence au moment venu pour éviter de regarder une deuxième fois si le fichier existe.</p><p id="r-565805" data-claire-element-id="565805">Pour ce qui est de la mise à jour de la date, à quoi bon consommer des ressources pour changer la date alors que le membre ne va peut être pas se tromper ? Celui-ci peut très bien s'identifier chaque jour sans problème, ce serait du gaspillage de ressources de s'amuser à changer le contenu du fichier pour rien.</p><p id="r-565806" data-claire-element-id="565806">Dans un premier temps, on met $existence_ft à 0 si le fichier n'existe pas du tout.</p><pre id="r-565807" data-claire-element-id="565807"><code data-claire-semantic="html+php">&lt;?php

// Si on tente de s'identifier
if(!empty($_POST['pseudo']) AND !empty($_POST['motdepasse']))
{


    // On initialise $existence_ft
    $existence_ft = '';
 
 
    // Si le fichier existe, on le lit
    if(file_exists('antibrute/'.$_POST['pseudo'].'.tmp'))
    {
 
        // On ouvre le fichier
        $fichier_tentatives = fopen('antibrute/'.$_POST['pseudo'].'.tmp', 'r+');
 
        // On récupère son contenu dans la variable $infos_tentatives
        $contenu_tentatives = fgets($fichier_tentatives);
 
    }
    // Si le fichier n'existe pas encore, on met la variable $existence_ft à 1 et on met les $tentatives à 0
    else
    {
        $existence_ft = 1;
        $tentatives = 0;
    }



        $verifications = mysql_query('SELECT pseudo, motdepasse FROM membres WHERE pseudo = \''.mysql_real_escape_string($_POST['pseudo']).'\' ');

        $data_verif = mysql_fetch_assoc($verifications);

        // Si le pseudo existe bien
        if(!empty($data_verif['pseudo']))
        {

           // Si le mot de passe est bon
           if($data_verif['motdepasse'] == trim($_POST['motdepasse']))
           {
               //------------------------------------------------
               // Ici Votre script qui identifie le membre
               //------------------------------------------------
           }
           // Si le mot de passe est faux
           else
           {
               echo 'Mot de passe incorrect';
           }

        }
        // Si le pseudo n'existe pas
        else
        {
            echo 'Pseudonyme incorrect';
        }


}

?&gt;</code></pre><p id="r-565808" data-claire-element-id="565808">Si le fichier existe on obtient son contenu dans la variable $contenu_tentatives, il ne nous reste plus qu'à traiter ces informations pour pouvoir les utiliser. La fonction explode() va nous permettre de couper en morceaux le contenu du fichier selon le séparateur de notre choix. Ici le point virgule ( ; ).</p><pre id="r-565809" data-claire-element-id="565809"><code data-claire-semantic="html+php">&lt;?php

// Si on tente de s'identifier
if(!empty($_POST['pseudo']) AND !empty($_POST['motdepasse']))
{


    // On initialise $existence_ft
    $existence_ft = '';


    // Si le fichier existe, on le lit
    if(file_exists('antibrute/'.$_POST['pseudo'].'.tmp'))
    {

        // On ouvre le fichier
        $fichier_tentatives = fopen('antibrute/'.$_POST['pseudo'].'.tmp', 'r+');

        // On récupère son contenu dans la variable $infos_tentatives
        $contenu_tentatives = fgets($fichier_tentatives);

        // On découpe le contenu du fichier pour récupérer les informations
        $infos_tentatives = explode(';', $contenu_tentatives);

    }
    // Si le fichier n'existe pas encore, on met la variable $existence_ft à 1 et on met les $tentatives à 0
    else
    {
        $existence_ft = 1;
        $tentatives = 0;
    }



        $verifications = mysql_query('SELECT pseudo, motdepasse FROM membres WHERE pseudo = \''.mysql_real_escape_string($_POST['pseudo']).'\' ');

        $data_verif = mysql_fetch_assoc($verifications);

        // Si le pseudo existe bien
        if(!empty($data_verif['pseudo']))
        {

           // Si le mot de passe est bon
           if($data_verif['motdepasse'] == trim($_POST['motdepasse']))
           {
               //------------------------------------------------
               // Ici Votre script qui identifie le membre
               //------------------------------------------------
           }
           // Si le mot de passe est faux
           else
           {
               echo 'Mot de passe incorrect';
           }

        }
        // Si le pseudo n'existe pas
        else
        {
            echo 'Pseudonyme incorrect';
        }


}

?&gt;</code></pre><p id="r-565810" data-claire-element-id="565810">Le contenu de notre fichier se présente de cette manière :</p><p id="r-565811" data-claire-element-id="565811">01/10/2008;0</p><p id="r-565812" data-claire-element-id="565812">La fonction explode() a donc créé un tableau contenant tout d'abord la date puis le nombre de tentatives.</p><ul id="r-565817" data-claire-element-id="565817"><li id="r-565814" data-claire-element-id="565814"><p id="r-565813" data-claire-element-id="565813">$infos_tentatives[0] contient la date.</p></li><li id="r-565816" data-claire-element-id="565816"><p id="r-565815" data-claire-element-id="565815">$infos_tentatives[1] contient le nombre de tentatives.</p></li></ul><p id="r-565818" data-claire-element-id="565818">La première chose que l'on va faire, c'est comparer la date du jour à la date que l'on vient de récupérer dans le fichier. Si la date est identique, le fichier est encore valide et on va utiliser le nombre de tentatives qu'il contient. Si au contraire la date ne correspond pas, on met la fameuse variable $existence_ft à 1.</p><p id="r-565819" data-claire-element-id="565819">On en profite pour créer la variable $tentatives que l'on utilisera pour savoir si le quota est dépassé ou non.</p><pre id="r-565820" data-claire-element-id="565820"><code data-claire-semantic="html+php">&lt;?php

// Si on tente de s'identifier
if(!empty($_POST['pseudo']) AND !empty($_POST['motdepasse']))
{


    // On initialise $existence_ft
    $existence_ft = '';


    // Si le fichier existe, on le lit
    if(file_exists('antibrute/'.$_POST['pseudo'].'.tmp'))
    {
        
        // On ouvre le fichier
        $fichier_tentatives = fopen('antibrute/'.$_POST['pseudo'].'.tmp', 'r+');

        // On récupère son contenu dans la variable $infos_tentatives
        $contenu_tentatives = fgets($fichier_tentatives);

        // On découpe le contenu du fichier pour récupérer les informations
        $infos_tentatives = explode(';', $contenu_tentatives);


        // Si la date du fichier est celle d'aujourd'hui, on récupère le nombre de tentatives
        if($infos_tentatives[0] == date('d/m/Y'))
        {
            $tentatives = $infos_tentatives[1];
        }
        // Si la date du fichier est dépassée, on met le nombre de tentatives à 0 et $existence_ft à 2
        else
        {
            $existence_ft = 2;
            $tentatives = 0; // On met la variable $tentatives à 0
        }
 
    }
    // Si le fichier n'existe pas encore, on met la variable $existence_ft à 1 et on met les $tentatives à 0
    else
    {
        $existence_ft = 1;
        $tentatives = 0;
    }



        $verifications = mysql_query('SELECT pseudo, motdepasse FROM membres WHERE pseudo = \''.mysql_real_escape_string($_POST['pseudo']).'\' ');

        $data_verif = mysql_fetch_assoc($verifications);

        // Si le pseudo existe bien
        if(!empty($data_verif['pseudo']))
        {

           // Si le mot de passe est bon
           if($data_verif['motdepasse'] == trim($_POST['motdepasse']))
           {
               //------------------------------------------------
               // Ici Votre script qui identifie le membre
               //------------------------------------------------
           }
           // Si le mot de passe est faux
           else
           {
               echo 'Mot de passe incorrect';
           }

        }
        // Si le pseudo n'existe pas
        else
        {
            echo 'Pseudonyme incorrect';
        }


}

?&gt;</code></pre><p id="r-565821" data-claire-element-id="565821">Pfiou, ça avance. Maintenant on possède deux variables qui nous fournissent toutes les informations dont on a besoin pour la suite. Il ne reste que deux choses à faire avant que le script soit fonctionnel :</p><ul id="r-565826" data-claire-element-id="565826"><li id="r-565823" data-claire-element-id="565823"><p id="r-565822" data-claire-element-id="565822">Couper l'accès à l'identification dès que le quota de tentatives a été atteint.</p></li><li id="r-565825" data-claire-element-id="565825"><p id="r-565824" data-claire-element-id="565824">Mettre à jour le fichier à chaque fois qu'un mauvais mot de passe est envoyé.</p></li></ul><p id="r-565827" data-claire-element-id="565827">La première tâche est très simple à réaliser, on a déjà le nombre de tentatives dans une variable. Tout ce qu'il reste à faire c'est de le comparer à notre quota.</p><pre id="r-565828" data-claire-element-id="565828"><code data-claire-semantic="html+php">&lt;?php

// Si on tente de s'identifier
if(!empty($_POST['pseudo']) AND !empty($_POST['motdepasse']))
{


    // On initialise $existence_ft
    $existence_ft = '';


    // Si le fichier existe, on le lit
    if(file_exists('antibrute/'.$_POST['pseudo'].'.tmp'))
    {
        
        // On ouvre le fichier
        $fichier_tentatives = fopen('antibrute/'.$_POST['pseudo'].'.tmp', 'r+');

        // On récupère son contenu dans la variable $infos_tentatives
        $contenu_tentatives = fgets($fichier_tentatives);

        // On découpe le contenu du fichier pour récupérer les informations
        $infos_tentatives = explode(';', $contenu_tentatives);


        // Si la date du fichier est celle d'aujourd'hui, on récupère le nombre de tentatives
        if($infos_tentatives[0] == date('d/m/Y'))
        {
            $tentatives = $infos_tentatives[1];
        }
        // Si la date du fichier est dépassée, on met le nombre de tentatives à 0 et $existence_ft à 2
        else
        {
            $existence_ft = 2;
            $tentatives = 0; // On met la variable $tentatives à 0
        }


    }
    // Si le fichier n'existe pas encore, on met la variable $existence_ft à 1 et on met les $tentatives à 0
    else
    {
        $existence_ft = 1;
        $tentatives = 0;
    }

 
    // S'il y a eu moins de 30 identifications ratées dans la journée, on laisse passer
    if($tentatives &lt; 30)
    {


        $verifications = mysql_query('SELECT pseudo, motdepasse FROM membres WHERE pseudo = \''.mysql_real_escape_string($_POST['pseudo']).'\' ');

        $data_verif = mysql_fetch_assoc($verifications);

        // Si le pseudo existe bien
        if(!empty($data_verif['pseudo']))
        {

           // Si le mot de passe est bon
           if($data_verif['motdepasse'] == trim($_POST['motdepasse']))
           {
               //------------------------------------------------
               // Ici Votre script qui identifie le membre
               //------------------------------------------------
           }
           // Si le mot de passe est faux
           else
           {
               echo 'Mot de passe incorrect';
           }

        }
        // Si le pseudo n'existe pas
        else
        {
            echo 'Pseudonyme incorrect';
        }

 
    }
    // S'il y a déjà eu 30 tentatives dans la journée, on affiche un message d'erreur
    else
    {
        echo 'Trop de tentatives d\'authentification aujourd\'hui';
    }

}

?&gt;</code></pre><p id="r-565829" data-claire-element-id="565829">La seconde sera légèrement plus ardue. Si le fichier n'existe pas encore, on le crée et on indique à l'intérieur qu'il y a eu une tentative. Mais s'il a déjà été créé, il va falloir à chaque identification ratée mettre à jour le nombre de tentatives à l'intérieur du fichier. Pour cela on va incrémenter notre variable tentative (+1), placer le curseur juste à l'endroit où se trouve le nombre de tentatives puis écrire le nouveau nombre. Il faudra aussi mettre à jour la date si nécessaire.</p><p id="r-565830" data-claire-element-id="565830">Inutile de s'affoler, je suis certain que vous y arriverez très facilement :-° .</p><aside id="r-565832" data-claire-element-id="565832" data-claire-semantic="warning"><p id="r-565831" data-claire-element-id="565831">Selon la configuration de votre serveur, l'encodage de vos données, et le type de caractères que vos membres ont le droit d'insérer dans leurs pseudonymes ; il se peut que vous deviez convertir les noms de fichiers pour qu'ils soient créés sans problème.</p></aside><pre id="r-565833" data-claire-element-id="565833"><code data-claire-semantic="html+php">&lt;?php

// Si on tente de s'identifier
if(!empty($_POST['pseudo']) AND !empty($_POST['motdepasse']))
{


    // On initialise $existence_ft
    $existence_ft = '';


    // Si le fichier existe, on le lit
    if(file_exists('antibrute/'.$_POST['pseudo'].'.tmp'))
    {
        
        // On ouvre le fichier
        $fichier_tentatives = fopen('antibrute/'.$_POST['pseudo'].'.tmp', 'r+');

        // On récupère son contenu dans la variable $infos_tentatives
        $contenu_tentatives = fgets($fichier_tentatives);

        // On découpe le contenu du fichier pour récupérer les informations
        $infos_tentatives = explode(';', $contenu_tentatives);


        // Si la date du fichier est celle d'aujourd'hui, on récupère le nombre de tentatives
        if($infos_tentatives[0] == date('d/m/Y'))
        {
            $tentatives = $infos_tentatives[1];
        }
        // Si la date du fichier est dépassée, on met le nombre de tentatives à 0 et $existence_ft à 2
        else
        {
            $existence_ft = 2;
            $tentatives = 0; // On met la variable $tentatives à 0
        }


    }
    // Si le fichier n'existe pas encore, on met la variable $existence_ft à 1 et on met les $tentatives à 0
    else
    {
        $existence_ft = 1;
        $tentatives = 0;
    }


    // S'il y a eu moins de 30 identifications ratées dans la journée, on laisse passer
    if($tentatives &lt; 30)
    {


        $verifications = mysql_query('SELECT pseudo, motdepasse FROM membres WHERE pseudo = \''.mysql_real_escape_string($_POST['pseudo']).'\' ');

        $data_verif = mysql_fetch_assoc($verifications);

        // Si le pseudo existe bien
        if(!empty($data_verif['pseudo']))
        {

           // Si le mot de passe est bon
           if($data_verif['motdepasse'] == trim($_POST['motdepasse']))
           {
               //------------------------------------------------
               // Ici Votre script qui identifie le membre
               //------------------------------------------------
           }
           // Si le mot de passe est faux
           else
           {
               
               // Si le fichier n'existe pas encore, on le créer
               if($existence_ft == 1)
               {
                   $creation_fichier = fopen('antibrute/'.$data_verif['pseudo'].'.tmp', 'a+'); // On créer le fichier puis on l'ouvre
                   fputs($creation_fichier, date('d/m/Y').';1'); // On écrit à l'intérieur la date du jour et on met le nombre de tentatives à 1
                   fclose($creation_fichier); // On referme
               }
               // Si la date n'est plus a jour
               elseif($existence_ft == 2)
               {
                   fseek($fichier_tentatives, 0); // On remet le curseur au début du fichier
                   fputs($fichier_tentatives, date('d/m/Y').';1'); // On met à jour le contenu du fichier (date du jour;1 tentatives)
               }
               else
               {
                   fseek($fichier_tentatives, 11); // On place le curseur juste devant le nombre de tentatives
                   fputs($fichier_tentatives, $tentatives + 1); // On ajoute 1 au nombre de tentatives
               }


           echo 'Mot de passe incorrect';
           }

        }
        // Si le pseudo n'existe pas
        else
        {
            echo 'Pseudonyme incorrect';
        }


    }
    // S'il y a déjà eu 30 tentatives dans la journée, on affiche un message d'erreur
    else
    {
        echo 'Trop de tentatives d\'authentification aujourd\'hui';
    }


 
    // Si on a ouvert un fichier, on le referme (eh oui, il ne faut pas l'oublier)
    if($existence_ft != 1)
    {
    fclose($fichier_tentatives);
    }

}

?&gt;</code></pre><p id="r-565834" data-claire-element-id="565834">Quelques explications s'imposent. Lorsque le fichier n'existe pas encore, c'est très simple : on le crée. Par contre, si la date n'est plus à jour, on va réécrire par dessus. Au tout début du script, on a ouvert et lu le fichier ; celui-ci est donc toujours ouvert. Tout ce qu'il nous reste à faire c'est de replacer le curseur au début avec <code>fseek($fichier_tentatives, 0);</code> puis d'écrire à la place du contenu actuel la date du jour suivie du nouveau nombre de tentatives (qui est logiquement 1 ici) via <code>fputs($fichier_tentatives, date('d/m/Y').';1');</code>. L'espace derrière le chiffre 1 n'est pas une erreur, il faut absolument le laisser. Si le fichier contenait par exemple 10/02/2008;25 (25 tentatives le 10/02/2008) et que vous écrivez par dessus 10/10/2008;1 vous obtiendriez 10/10/2008;15.<br/> Le nouveau contenu étant 1 caractère plus petit que le précédent, le dernier chiffre est resté et fausse complètement le nombre de tentatives. D'où l'utilité d'écrire un espace à la fin du nouveau contenu pour écraser un éventuel caractère gênant.</p><p id="r-565835" data-claire-element-id="565835">Si le fichier existe et est à la bonne date, il n'y a qu'à incrémenter le nombre de tentatives. Inutile de s'amuser à réécrire tout le fichier. On place le curseur juste devant le nombre de tentatives grâce à <code>fseek($fichier_tentatives, 11);</code>, puis on écrit par dessus le nouveau nombre. Pourquoi utiliser 11 avec la variable fseek ? tout simplement parce que la date suivit du point virgule fera toujours 11 caractères.</p><p id="r-565836" data-claire-element-id="565836">Voilà ! Le script anti brute-force est maintenant fonctionnel.<br/> Celui-ci n'autorisera que 30 tentatives par jour ; cela découragera pas mal de pirates. Si vous estimez que ce n'est pas suffisant, il est très simple de baisser le nombre de tentatives.</p><p id="r-565837" data-claire-element-id="565837">Bien que le système soit fonctionnel, vous pouvez si vous le souhaitez lire le chapitre suivant pour l'améliorer. Si vous estimez avoir appris bien assez de choses pour aujourd'hui, vous pouvez le lire plus tard ou laisser votre script tel quel. ^^</p>
<aside class="aside-menu">
<ul class="content-menu subchapter" role="navigation">
<li class="tuto">
<a href="http://62.4.17.167/informatique/tutoriels/un-anti-brute-force-leger-et-rapide">Un anti brute-force léger et rapide</a>
</li>
<ul class="subchapter-parts">
<li>
<a href="http://62.4.17.167/informatique/tutoriels/un-anti-brute-force-leger-et-rapide/est-ce-bien-utile">
Est-ce bien utile ?
</a>
</li>
<li>
<a href="http://62.4.17.167/informatique/tutoriels/un-anti-brute-force-leger-et-rapide/principe-de-base-5">
Principe de base
</a>
</li>
<li class="active">
<a href="http://62.4.17.167/informatique/tutoriels/un-anti-brute-force-leger-et-rapide/a-vos-claviers-c-est-parti">
À vos claviers, c&#039;est parti
</a>
</li>
<li>
<a href="http://62.4.17.167/informatique/tutoriels/un-anti-brute-force-leger-et-rapide/ajout-d-un-systeme-de-notification">
Ajout d&#039;un systéme de notification
</a>
</li>
</ul>
</ul>
</aside>
</div>
<div id="content-bottom-menu"></div>
<hr/>
<div class="paginate-tuto">
<a class="before" href="http://62.4.17.167/informatique/tutoriels/un-anti-brute-force-leger-et-rapide/principe-de-base-5">
<span class="arrow"></span>
<span class="next">Principe de base</span>
</a>
<a class="after" href="http://62.4.17.167/informatique/tutoriels/un-anti-brute-force-leger-et-rapide/ajout-d-un-systeme-de-notification">
<span class="next">Ajout d&#039;un systéme de notification</span>
<span class="arrow"></span>
</a>
</div>
<hr class="bottom"/>
<div class="clear"></div> <div class="adBan">
<script type='text/javascript'>
    if (window.innerWidth >= 728)
    {
        document.write('<div id="div-gpt-ad-1350977194635-8" class="megaban"></div>');
        googletag.cmd.push(function() {
            googletag.display('div-gpt-ad-1350977194635-8');
        });
    }
            else
        {
            document.write('<div id="div-gpt-ad-1350977284180-8" class="miniban"></div>');
            googletag.cmd.push(function() {
                googletag.display('div-gpt-ad-1350977284180-8');
            });
        }
    </script>
</div>
<div class="clear"></div><a name="Ajoutd039unsystmedenotification"></a><h2>Ajout d&#039;un systéme de notification</h2><div class="paginate-tuto">
<a class="before" href="http://62.4.17.167/informatique/tutoriels/un-anti-brute-force-leger-et-rapide/a-vos-claviers-c-est-parti">
<span class="arrow"></span>
<span class="next">À vos claviers, c&#039;est parti</span>
</a>
</div>
<hr class="top"/>
<div class="clear"></div> <div id="content" role="article">
<p id="r-565839" data-claire-element-id="565839">Maintenant que votre anti brute-force fonctionne, il sera beaucoup plus long pour un pirate de réussir à récupérer le mot de passe d'un de vos comptes. Néanmoins il reste deux petits problèmes :</p><ul id="r-565844" data-claire-element-id="565844"><li id="r-565841" data-claire-element-id="565841"><p id="r-565840" data-claire-element-id="565840">Un pirate particulièrement acharné pourrait quand même, au bout de quelques temps, réussir à trouver un mot de passe.</p></li><li id="r-565843" data-claire-element-id="565843"><p id="r-565842" data-claire-element-id="565842">Si un pirate continue malgré la protection à tenter de récupérer un mot de passe, il pourrait empêcher la personne réelle de s'identifier.</p></li></ul><p id="r-565845" data-claire-element-id="565845">Il n'y a malheureusement techniquement rien d'autre à faire pour empêcher quelqu'un d'essayer des mots de passe, ne serai-ce que 30 par jour. On va donc faire en sorte d'être informé à chaque fois qu'un quota est dépassé ; étant donné que les personnes qui se trompent 30 fois de mot de passe sur la journée sont plutôt rares, ces notifications seront généralement légitimes.</p><p id="r-565846" data-claire-element-id="565846">La mise en place de ce système est très simple, il suffit d'envoyer un mail à un administrateur grâce à la fonction mail() lorsque un compte est arrivé à 30 tentatives.</p><pre id="r-565847" data-claire-element-id="565847"><code data-claire-semantic="html+php">&lt;?php

// Si on tente de s'identifier
if(!empty($_POST['pseudo']) AND !empty($_POST['motdepasse']))
{


    // On initialise $existence_ft
    $existence_ft = '';


    // Si le fichier existe, on le lit
    if(file_exists('antibrute/'.$_POST['pseudo'].'.tmp'))
    {
        
        // On ouvre le fichier
        $fichier_tentatives = fopen('antibrute/'.$_POST['pseudo'].'.tmp', 'r+');

        // On récupère son contenu dans la variable $infos_tentatives
        $contenu_tentatives = fgets($fichier_tentatives);

        // On découpe le contenu du fichier pour récupérer les informations
        $infos_tentatives = explode(';', $contenu_tentatives);


        // Si la date du fichier est celle d'aujourd'hui, on récupère le nombre de tentatives
        if($infos_tentatives[0] == date('d/m/Y'))
        {
            $tentatives = $infos_tentatives[1];
        }
        // Si la date du fichier est dépassée, on met le nombre de tentatives à 0 et $existence_ft à 2
        else
        {
            $existence_ft = 2;
            $tentatives = 0; // On met la variable $tentatives à 0
        }


    }
    // Si le fichier n'existe pas encore, on met la variable $existence_ft à 1 et on met les $tentatives à 0
    else
    {
        $existence_ft = 1;
        $tentatives = 0;
    }


    // S'il y a eu moins de 30 identifications ratées dans la journée, on laisse passer
    if($tentatives &lt; 30)
    {


        $verifications = mysql_query('SELECT pseudo, motdepasse FROM membres WHERE pseudo = \''.mysql_real_escape_string($_POST['pseudo']).'\' ');

        $data_verif = mysql_fetch_assoc($verifications);

        // Si le pseudo existe bien
        if(!empty($data_verif['pseudo']))
        {

           // Si le mot de passe est bon
           if($data_verif['motdepasse'] == trim($_POST['motdepasse']))
           {
               //------------------------------------------------
               // Ici Votre script qui identifie le membre
               //------------------------------------------------
           }
           // Si le mot de passe est faux
           else
           {
               
               // Si le fichier n'existe pas encore, on le créé
               if($existence_ft == 1)
               {
                   $creation_fichier = fopen('antibrute/'.$data_verif['pseudo'].'.tmp', 'a+'); // On créé le fichier puis on l'ouvre
                   fputs($creation_fichier, date('d/m/Y').';1'); // On écrit à l'intérieur la date du jour et on met le nombre de tentatives à 1
                   fclose($creation_fichier); // On referme
               }
               // Si la date n'est plus a jour
               elseif($existence_ft == 2)
               {
                   fseek($fichier_tentatives, 0); // On remet le curseur au début du fichier
                   fputs($fichier_tentatives, date('d/m/Y').';1 '); // On met à jour le contenu du fichier (date du jour;1 tentatives)
               }
               else
               {

                   // Si la variable $tentatives est sur le point de passer à 30, on en informe l'administrateur du site
                   if($tentatives == 29)
                   {
                       $email_administrateur = 'Email de administrateur du site';
 
                       $sujet_notification = '[Site] Un compte membre a atteint son quota';
 
                       $message_notification = 'Un des comptes a atteint le quota de mauvais mots de passe journalier :';
                       $message_notification .= $data_verif['pseudo'].' - '.$_SERVER['REMOTE_ADDR'].' - '.gethostbyaddr($_SERVER['REMOTE_ADDR']);
 
                       mail($email_administrateur, $sujet_notification, $message_notification);
                   }

                   fseek($fichier_tentatives, 11); // On place le curseur juste devant le nombre de tentatives
                   fputs($fichier_tentatives, $tentatives + 1); // On ajoute 1 au nombre de tentatives
               }


           echo 'Mot de passe incorrect';
           }

        }
        // Si le pseudo n'existe pas
        else
        {
            echo 'Pseudonyme incorrect';
        }


    }
    // S'il y a déjà eu 30 tentatives dans la journée, on affiche un message d'erreur
    else
    {
        echo 'Trop de tentatives d\'authentification aujourd\'hui';
    }


 
    // Si on a ouvert un fichier, on le referme (eh oui, il ne faut pas l'oublier)
    if($existence_ft != 1)
    {
    fclose($fichier_tentatives);
    }

}

?&gt;</code></pre><p id="r-565848" data-claire-element-id="565848">Et voilà, l'administrateur du site sera informé à chaque fois que le quota d'un compte sera atteint ! Il recevra :</p><ul id="r-565855" data-claire-element-id="565855"><li id="r-565850" data-claire-element-id="565850"><p id="r-565849" data-claire-element-id="565849">Le pseudonyme du compte en question.</p></li><li id="r-565852" data-claire-element-id="565852"><p id="r-565851" data-claire-element-id="565851">L'adresse IP du pirate présumé.</p></li><li id="r-565854" data-claire-element-id="565854"><p id="r-565853" data-claire-element-id="565853">Des détails tirés de l'adresse IP permettant généralement de déduire le Fournisseur d'Accès à Internet du pirate présumé.</p></li></ul><p id="r-565856" data-claire-element-id="565856">Évidemment, chaque mail ne voudra pas forcement dire qu'un pirate attaque votre site web. Les membres qui se trompent de mot de passe 30 fois sur une journée existent, ça peut arriver à tout le monde de s'énerver sur un trou de mémoire et essayer plein de mots de passe. Vous pourrez commencer à vous inquiéter si vous recevez un mail pour le même compte plusieurs jours de suite. À vous alors de réagir en conséquence : bloquer le compte attaqué, contacter son propriétaire et vous tournez si nécessaire vers la justice de votre pays pour tenter de vous débarrasser du malotru responsable des attaques.</p><p id="r-565857" data-claire-element-id="565857">Si votre site connait un fort trafic, vous pouvez créer une boîte de messagerie rien que pour recevoir les notifications. Vous pourriez aussi choisir d'envoyer les notifications par message privé ou de les insérer dans la base de données. Et bien plus encore.</p><p id="r-565858" data-claire-element-id="565858">Ce tutoriel touche à sa fin, mais il est néanmoins amené à évoluer au fil des remarques et commentaires des zéros. Passez jeter un coup d'œil sur les évolutions de temps en temps.</p><p id="r-565859" data-claire-element-id="565859">Vous êtes maintenant à l'abri des attaques par brute-force.</p><p id="r-565860" data-claire-element-id="565860">Encore un souci de moins, ça fait plaisir non ? ^^</p>
<aside class="aside-menu">
<ul class="content-menu subchapter" role="navigation">
<li class="tuto">
<a href="http://62.4.17.167/informatique/tutoriels/un-anti-brute-force-leger-et-rapide">Un anti brute-force léger et rapide</a>
</li>
<ul class="subchapter-parts">
<li>
<a href="http://62.4.17.167/informatique/tutoriels/un-anti-brute-force-leger-et-rapide/est-ce-bien-utile">
Est-ce bien utile ?
</a>
</li>
<li>
<a href="http://62.4.17.167/informatique/tutoriels/un-anti-brute-force-leger-et-rapide/principe-de-base-5">
Principe de base
</a>
</li>
<li>
<a href="http://62.4.17.167/informatique/tutoriels/un-anti-brute-force-leger-et-rapide/a-vos-claviers-c-est-parti">
À vos claviers, c&#039;est parti
</a>
</li>
<li class="active">
<a href="http://62.4.17.167/informatique/tutoriels/un-anti-brute-force-leger-et-rapide/ajout-d-un-systeme-de-notification">
Ajout d&#039;un systéme de notification
</a>
</li>
</ul>
</ul>
</aside>
</div>
<div id="content-bottom-menu"></div>
<hr/>
<div class="paginate-tuto">
<a class="before" href="http://62.4.17.167/informatique/tutoriels/un-anti-brute-force-leger-et-rapide/a-vos-claviers-c-est-parti">
<span class="arrow"></span>
<span class="next">À vos claviers, c&#039;est parti</span>
</a>
</div>
<hr class="bottom"/>
<div class="clear"></div> <div class="adBan">
<script type='text/javascript'>
    if (window.innerWidth >= 728)
    {
        document.write('<div id="div-gpt-ad-1350977194635-8" class="megaban"></div>');
        googletag.cmd.push(function() {
            googletag.display('div-gpt-ad-1350977194635-8');
        });
    }
            else
        {
            document.write('<div id="div-gpt-ad-1350977284180-8" class="miniban"></div>');
            googletag.cmd.push(function() {
                googletag.display('div-gpt-ad-1350977284180-8');
            });
        }
    </script>
</div>
<div class="clear"></div>
</body>
<!-- Mirrored from 62.4.17.167/sdz/sdz/un-anti-brute-force-leger-et-rapide.html by HTTrack Website Copier/3.x [XR&CO'2013], Sun, 27 Oct 2013 06:36:45 GMT -->

<!-- Mirrored from sdz.tdct.org/sdz/un-anti-brute-force-leger-et-rapide.html by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 30 Nov 2015 05:10:57 GMT -->
</html>